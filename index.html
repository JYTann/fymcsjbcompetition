<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å±±å®½æŸ”ä¸­å­¦ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›</title>
    
    <!-- CSS èµ„æº -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- JavaScript èµ„æº -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --info-color: #2980b9;
        --light-color: #ecf0f1;
        --dark-color: #2c3e50;
        --background-color: #f8f9fa;
        --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        --card-shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.18);
        --border-radius: 16px;
        --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        --text-color: #2c3e50;
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-danger: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    /* å…¨å±€æ ·å¼ */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Noto Sans SC', sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        color: var(--text-color);
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* å¯¼èˆªæ ç¾åŒ– */
    .navbar {
        background: var(--gradient-primary);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 1rem 1.5rem;
        backdrop-filter: blur(10px);
        border-bottom: none;
        position: sticky;
        top: 0;
        z-index: 1000;
    }

    .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        color: white;
        transition: var(--transition);
        letter-spacing: 0.5px;
    }

    .navbar-brand:hover {
        color: rgba(255, 255, 255, 0.9);
        transform: translateX(3px);
    }

    .logo {
        height: 40px;
        margin-right: 12px;
        filter: brightness(0) invert(1);
        transition: var(--transition);
    }

    .logo:hover {
        transform: rotate(10deg) scale(1.1);
    }

    /* æŒ‰é’®ç¾åŒ– */
    .btn {
        border-radius: var(--border-radius);
        padding: 12px 24px;
        font-weight: 600;
        transition: var(--transition);
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
        transform: translateY(0);
    }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
        transform: translateY(1px);
    }

    .btn-primary {
        background: var(--gradient-primary);
        color: white;
    }

    .btn-success {
        background: var(--gradient-success);
        color: white;
    }

    .btn-danger {
        background: var(--gradient-secondary);
        color: white;
    }

    .btn-warning {
        background: var(--gradient-warning);
        color: white;
    }

    .btn-outline-light {
        border: 2px solid rgba(255, 255, 255, 0.3);
        background-color: transparent;
        color: white;
        position: relative;
        z-index: 1;
        overflow: hidden;
    }

    .btn-outline-light::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: var(--transition);
    }

    .btn-outline-light:hover::before {
        left: 100%;
    }

    /* å¡ç‰‡ç¾åŒ– */
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 24px;
        transition: var(--transition);
        overflow: hidden;
        background: white;
        border-top: 4px solid transparent;
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
    }

    .card:hover {
        transform: translateY(-8px);
        box-shadow: var(--card-shadow-hover);
        border-top: 4px solid var(--secondary-color);
    }

    .card-header {
        background: var(--gradient-primary);
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
        font-weight: 600;
        padding: 1.25rem 1.5rem;
        border-bottom: none;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
    }

    .card-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* é¢˜ç›®å¡ç‰‡ */
    .question-card {
        background: white;
        padding: 2rem;
        margin-bottom: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        animation: fadeInUp 0.6s ease forwards;
        border-left: 4px solid var(--primary-color);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .question-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--gradient-primary);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.4s ease;
    }

    .question-card:hover::before {
        transform: scaleX(1);
    }

    .question-card:hover {
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-5px);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* é€‰é¡¹æ ·å¼ */
    .option-item {
        padding: 15px 20px;
        margin: 12px 0;
        background: white;
        border-radius: 12px;
        cursor: pointer;
        transition: var(--transition);
        border: 2px solid #e9ecef;
        font-weight: 500;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .option-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
        transition: var(--transition);
    }

    .option-item:hover::before {
        left: 100%;
    }

    .option-item:hover {
        background-color: #f8fafc;
        border-color: var(--secondary-color);
        transform: translateX(8px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .option-item.selected {
        background: var(--gradient-primary);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
        transform: translateX(8px);
    }

    .option-item.correct {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        border-left: 5px solid #28a745;
        color: #155724;
    }

    .option-item.incorrect {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        border-left: 5px solid #dc3545;
        color: #721c24;
    }

    .option-item.missed {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border-left: 5px solid #ffc107;
        color: #856404;
    }

    /* è®¡æ—¶å™¨æ ·å¼ */
    .timer {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--accent-color);
        text-align: center;
        margin: 20px 0;
        padding: 15px 30px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        display: inline-block;
        border: 2px solid #f1f1f1;
        transition: var(--transition);
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
    }

    .timer.text-danger {
        animation: pulse 1s infinite;
        background: linear-gradient(135deg, #ffeaa7, #fab1a0);
    }

    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2); }
        50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4); }
        100% { transform: scale(1); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2); }
    }

    /* æ¬¢è¿åŒºåŸŸ */
    .welcome-section {
        background: var(--gradient-primary);
        color: white;
        padding: 5rem 0;
        border-radius: var(--border-radius);
        margin-bottom: 2.5rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }

    .welcome-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('https://i.postimg.cc/qqV3NyJB/logo-01.png') no-repeat;
        background-size: 30%;
        background-position: right bottom;
        opacity: 0.05;
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(2deg); }
        100% { transform: translateY(0px) rotate(0deg); }
    }

    .welcome-section h1 {
        font-weight: 800;
        margin-bottom: 1.5rem;
        font-size: 3rem;
        position: relative;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        animation: fadeInDown 0.8s ease;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* è¿›åº¦æ¡ç¾åŒ– */
    .progress {
        height: 12px;
        margin-bottom: 1.5rem;
        border-radius: 10px;
        background: linear-gradient(135deg, #e9ecef, #dee2e6);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: visible;
        position: relative;
    }

    .progress-bar {
        background: var(--gradient-primary);
        border-radius: 10px;
        transition: width 0.6s ease;
        position: relative;
        overflow: hidden;
    }

    .progress-bar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            rgba(255, 255, 255, 0) 0%, 
            rgba(255, 255, 255, 0.4) 50%, 
            rgba(255, 255, 255, 0) 100%);
        animation: progressShine 2s linear infinite;
    }

    @keyframes progressShine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* ç»“æœæ‘˜è¦ç¾åŒ– */
    .result-summary {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2.5rem;
        border-top: 5px solid transparent;
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        position: relative;
        overflow: hidden;
    }

    .result-summary::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: var(--gradient-primary);
    }

    .result-score {
        font-size: 4.5rem;
        font-weight: 800;
        color: var(--primary-color);
        margin: 1.5rem 0;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        position: relative;
        display: inline-block;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .result-score::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 50%;
        height: 3px;
        background: var(--gradient-primary);
        border-radius: 2px;
    }

    /* è¡¨æ ¼ç¾åŒ– */
    .ranking-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
        background: white;
    }

    .ranking-table th, .ranking-table td {
        padding: 15px 20px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
        transition: var(--transition);
    }

    .ranking-table th {
        background: var(--gradient-primary);
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0;
        border: none;
    }

    .ranking-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .ranking-table tr:hover {
        background-color: #f0f7ff;
        transform: translateX(5px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .first-place {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9) !important;
        position: relative;
    }

    .first-place::before {
        content: 'ğŸ¥‡';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
    }

    .second-place {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
        position: relative;
    }

    .second-place::before {
        content: 'ğŸ¥ˆ';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
    }

    .third-place {
        background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
        position: relative;
    }

    .third-place::before {
        content: 'ğŸ¥‰';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
    }

    /* æ ‡ç­¾é¡µç¾åŒ– */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        background: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        padding: 0.5rem 0.5rem 0;
    }

    .nav-tabs .nav-link {
        color: var(--dark-color);
        font-weight: 600;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        padding: 12px 24px;
        transition: var(--transition);
        border: none;
        margin-right: 5px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        position: relative;
        overflow: hidden;
    }

    .nav-tabs .nav-link::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: var(--transition);
    }

    .nav-tabs .nav-link:hover::before {
        left: 100%;
    }

    .nav-tabs .nav-link:hover {
        background: linear-gradient(135deg, #e9ecef, #dee2e6);
        transform: translateY(-2px);
    }

    .nav-tabs .nav-link.active {
        color: white;
        font-weight: 700;
        background: var(--gradient-primary);
        border-bottom: none;
        box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .tab-content {
        padding: 2rem;
        background: white;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        box-shadow: var(--card-shadow);
        border: none;
        border-top: none;
        transition: var(--transition);
    }

    /* æ¨¡æ€æ¡†ç¾åŒ– */
    .modal-content {
        border-radius: var(--border-radius);
        border: none;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        background: white;
    }

    .modal-header {
        background: var(--gradient-primary);
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        border-bottom: none;
        padding: 1.5rem;
    }

    .modal-title {
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .modal-footer {
        border-top: none;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        padding: 1.5rem;
    }

    /* è¡¨å•å…ƒç´ ç¾åŒ– */
    .form-control, .form-select {
        border-radius: var(--border-radius);
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        transition: var(--transition);
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        transform: translateY(-2px);
    }

    /* åŠ è½½åŠ¨ç”» */
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
        border-color: var(--primary-color) transparent transparent transparent;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸç¾åŒ– */
    .image-upload-container {
        margin-top: 1rem;
        padding: 2.5rem;
        border: 2px dashed #e9ecef;
        border-radius: var(--border-radius);
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        position: relative;
        overflow: hidden;
    }

    .image-upload-container:hover {
        border-color: var(--secondary-color);
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .image-preview {
        max-width: 100%;
        max-height: 200px;
        margin-top: 1rem;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid #e9ecef;
        transition: var(--transition);
    }

    .image-preview:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    /* é¡µè„šç¾åŒ– */
    .footer {
        background: var(--gradient-primary);
        color: white;
        padding: 2.5rem 0;
        margin-top: auto;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .footer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--gradient-secondary);
    }

    /* é˜²ä½œå¼Šç³»ç»Ÿæ ·å¼ */
    .anti-cheat-alert {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 15px;
        text-align: center;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: alertPulse 2s infinite;
    }

    .anti-cheat-warning {
        background: linear-gradient(135deg, #ff9ff3, #f368e0);
    }

    .anti-cheat-info {
        background: linear-gradient(135deg, #48dbfb, #0abde3);
    }

    @keyframes alertPulse {
        0% { opacity: 1; }
        50% { opacity: 0.8; }
        100% { opacity: 1; }
    }

    .cheat-detection-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--border-radius);
        padding: 15px;
        box-shadow: var(--card-shadow);
        z-index: 9998;
        backdrop-filter: blur(10px);
        border-left: 4px solid var(--warning-color);
        min-width: 250px;
    }

    .cheat-detection-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .cheat-detection-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .cheat-status {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .cheat-status.safe {
        background-color: var(--success-color);
    }

    .cheat-status.warning {
        background-color: var(--warning-color);
        animation: pulse 1s infinite;
    }

    .cheat-status.danger {
        background-color: var(--accent-color);
        animation: pulse 0.5s infinite;
    }

    .warning-counter {
        background-color: var(--accent-color);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }

    .fullscreen-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        text-align: center;
        padding: 20px;
    }

    .fullscreen-overlay h2 {
        font-size: 2rem;
        margin-bottom: 20px;
    }

    .fullscreen-overlay p {
        font-size: 1.2rem;
        margin-bottom: 30px;
        max-width: 600px;
    }

    /* ç¦ç”¨æ–‡æœ¬é€‰æ‹©å’Œå³é”®èœå• */
    .no-select, .no-context-menu {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
    }

    /* æŸ¥è¯¢ç»“æœæ ·å¼ */
    .result-container {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: var(--border-radius);
        padding: 2rem;
        border-left: 4px solid var(--primary-color);
        box-shadow: var(--card-shadow);
    }

    /* ç®¡ç†å‘˜é¢æ¿ç‰¹æ®Šæ ·å¼ */
    .admin-stats-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        border-top: 4px solid transparent;
        height: 100%;
    }

    .admin-stats-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }

    .admin-stats-card.bg-primary {
        border-top-color: var(--primary-color);
        background: var(--gradient-primary) !important;
    }

    .admin-stats-card.bg-success {
        border-top-color: var(--success-color);
        background: var(--gradient-success) !important;
    }

    .admin-stats-card.bg-info {
        border-top-color: var(--info-color);
        background: linear-gradient(135deg, #4facfe, #00f2fe) !important;
    }

    .admin-stats-card.bg-warning {
        border-top-color: var(--warning-color);
        background: var(--gradient-warning) !important;
    }

    /* æ™ºèƒ½ç»„å·æ ·å¼ */
    .question-dist, .difficulty-dist {
        border-radius: var(--border-radius);
        padding: 10px;
        border: 2px solid #e9ecef;
        transition: var(--transition);
    }

    .question-dist:focus, .difficulty-dist:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .welcome-section {
            padding: 3rem 1rem;
        }
        
        .welcome-section h1 {
            font-size: 2.2rem;
        }
        
        .result-summary {
            padding: 2rem;
        }
        
        .result-score {
            font-size: 3rem;
        }
        
        .card {
            margin-bottom: 1rem;
        }
        
        .btn {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .ranking-table th, .ranking-table td {
            padding: 10px 15px;
        }
        
        .cheat-detection-panel {
            top: 70px;
            right: 10px;
            min-width: 200px;
        }
    }

    @media (max-width: 576px) {
        .navbar-brand {
            font-size: 1.2rem;
        }
        
        .logo {
            height: 30px;
        }
        
        .welcome-section h1 {
            font-size: 1.8rem;
        }
        
        .result-details {
            padding: 1rem;
        }
        
        .result-details-item {
            flex-direction: column;
            text-align: center;
        }
        
        .btn {
            padding: 8px 16px;
            font-size: 0.8rem;
        }
        
        .timer {
            font-size: 1.2rem;
            padding: 10px 20px;
        }
    }

    /* ç‰¹æ®Šæ•ˆæœ */
    .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .floating {
        animation: floating 3s ease-in-out infinite;
    }

    @keyframes floating {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }

    /* å¾½ç« ç¾åŒ– */
    .badge {
        border-radius: 20px;
        padding: 8px 16px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
    }

    .badge:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* ç­”é¢˜ç»Ÿè®¡å›¾è¡¨å®¹å™¨ */
    .chart-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 1.5rem;
        height: 300px;
    }

    /* å®æ—¶ç›‘æ§æ ·å¼ */
    .monitor-active {
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* å€’è®¡æ—¶æ ·å¼ */
    .countdown-timer {
        font-size: 3rem;
        font-weight: bold;
        color: var(--accent-color);
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        display: inline-block;
    }

            .warning-badge {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        font-weight: bold;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.75rem;
        display: inline-block;
        min-width: 20px;
        text-align: center;
    }
    
    .warning-badge.safe {
        background: linear-gradient(135deg, #48dbfb, #0abde3);
    }
    
    .warning-badge.warning {
        background: linear-gradient(135deg, #ff9ff3, #f368e0);
    }
    
    .warning-badge.danger {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        animation: pulse 0.8s infinite;
    }
    
    /* è­¦å‘Šè®°å½•è¡¨æ ¼æ ·å¼ */
    .warning-record-table {
        font-size: 0.85rem;
    }
    
    .warning-record-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    /* æˆç»©åˆ†å¸ƒæ ·å¼ */
    .score-distribution {
        display: flex;
        height: 200px;
        align-items: flex-end;
        gap: 10px;
        padding: 20px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
    }

    .distribution-bar {
        flex: 1;
        background: var(--gradient-primary);
        border-radius: 5px 5px 0 0;
        transition: var(--transition);
        position: relative;
        cursor: pointer;
    }

    .distribution-bar:hover {
        transform: scaleY(1.1);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .distribution-label {
        position: absolute;
        bottom: -25px;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 0.8rem;
        color: var(--text-color);
    }

        /* é˜²æ­¢æ¨¡æ€æ¡†èƒŒæ™¯å˜é»‘ */
.modal-backdrop {
    z-index: 1040 !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
}

/* ç¡®ä¿æ¨¡æ€æ¡†åœ¨å‰ç«¯æ˜¾ç¤º */
#warningDetailsModal {
    z-index: 1050 !important;
}

/* é˜²æ­¢å…¨å±è¦†ç›–å±‚å¹²æ‰° */
.fullscreen-overlay {
    z-index: 10000 !important;
}

/* é˜²ä½œå¼Šé¢æ¿ */
.cheat-detection-panel {
    z-index: 9998 !important;
}

    /* æ¯”èµ›ä¿¡æ¯é¢æ¿ */
    .competition-info-panel {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .info-item {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .info-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.2rem;
    }

    /* ç­”é¢˜å¯¼èˆªç‚¹ */
    .question-nav-dots {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 20px 0;
        padding: 15px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
    }

    .nav-dot {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        font-weight: bold;
    }

    .nav-dot.answered {
        background: var(--gradient-success);
        color: white;
    }

    .nav-dot.current {
        background: var(--gradient-primary);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .nav-dot.unanswered {
        background: #e9ecef;
        color: var(--text-color);
    }

    .nav-dot:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* æˆç»©è¯ä¹¦æ ·å¼ */
    .certificate {
        background: linear-gradient(135deg, #fff8e1, #ffe0b2);
        padding: 3rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        text-align: center;
        position: relative;
        overflow: hidden;
        border: 20px solid transparent;
        border-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="none" stroke="%23ff9800" stroke-width="2"/></svg>') 20 stretch;
    }

    .certificate::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 152, 0, 0.1) 0%, transparent 70%);
        z-index: 0;
    }

    .certificate-content {
        position: relative;
        z-index: 1;
    }

    .certificate h2 {
        font-size: 2.5rem;
        color: #ff9800;
        margin-bottom: 1.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .certificate h3 {
        font-size: 1.5rem;
        color: var(--text-color);
        margin-bottom: 2rem;
    }

    .certificate .result-score {
        font-size: 4rem;
        margin: 2rem 0;
    }

    /* å…¬å‘Šæ æ ·å¼ */
    .announcement-board {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 5px solid var(--warning-color);
    }

    .announcement-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .announcement-icon {
        font-size: 1.5rem;
        color: var(--warning-color);
        margin-right: 1rem;
    }

    .announcement-content {
        line-height: 1.6;
    }

    /* å¿«æ·é”®æç¤º */
    .shortcut-hint {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(5px);
    }

    .shortcut-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
    }

    .shortcut-key {
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 8px;
        border-radius: 4px;
        font-family: monospace;
    }
    </style>
</head>
<body class="no-select">
    <!-- é˜²ä½œå¼Šç³»ç»Ÿ -->
    <div id="antiCheatAlert" class="anti-cheat-alert d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="alertMessage">æ£€æµ‹åˆ°å¯ç–‘è¡Œä¸ºï¼è¯·ç«‹å³è¿”å›è€ƒè¯•ç•Œé¢ã€‚</span>
    </div>

    <div id="cheatDetectionPanel" class="cheat-detection-panel d-none">
        <h5 class="mb-3"><i class="fas fa-shield-alt me-2"></i>é˜²ä½œå¼Šç›‘æ§</h5>
        
        <div class="cheat-detection-item">
            <div>
                <span class="cheat-status safe" id="tabStatus"></span>
                <span>æ ‡ç­¾é¡µçŠ¶æ€</span>
            </div>
            <span id="tabStatusText">æ­£å¸¸</span>
        </div>
        
        <div class="cheat-detection-item">
            <div>
                <span class="cheat-status safe" id="fullscreenStatus"></span>
                <span>å…¨å±çŠ¶æ€</span>
            </div>
            <span id="fullscreenStatusText">æ­£å¸¸</span>
        </div>
        
        <div class="cheat-detection-item">
            <div>
                <span class="cheat-status safe" id="keyboardStatus"></span>
                <span>é”®ç›˜çŠ¶æ€</span>
            </div>
            <span id="keyboardStatusText">æ­£å¸¸</span>
        </div>
        
        <div class="cheat-detection-item">
            <div>
                <span class="cheat-status safe" id="mouseStatus"></span>
                <span>é¼ æ ‡çŠ¶æ€</span>
            </div>
            <span id="mouseStatusText">æ­£å¸¸</span>
        </div>
        
        <div class="cheat-detection-item">
            <div>
                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                <span>è­¦å‘Šæ¬¡æ•°</span>
            </div>
            <span class="warning-counter" id="warningCount">0</span>
        </div>
    </div>

    <div id="fullscreenOverlay" class="fullscreen-overlay d-none">
        <i class="fas fa-expand-arrows-alt fa-5x mb-4"></i>
        <h2>è¯·è¿”å›å…¨å±æ¨¡å¼</h2>
        <p>æ£€æµ‹åˆ°æ‚¨å·²é€€å‡ºå…¨å±æ¨¡å¼ï¼Œè¯·åœ¨10ç§’å†…è¿”å›å…¨å±æ¨¡å¼ç»§ç»­è€ƒè¯•ï¼Œå¦åˆ™ç³»ç»Ÿå°†è‡ªåŠ¨æäº¤ç­”å·ã€‚</p>
        <div class="countdown-timer mb-4">
            <span id="countdown">10</span> ç§’
        </div>
        <button class="btn btn-primary btn-lg" id="returnToFullscreen">
            <i class="fas fa-expand me-2"></i>è¿”å›å…¨å±
        </button>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="https://i.postimg.cc/qqV3NyJB/logo-01.png" class="logo" alt="å®½æŸ”ä¸­å­¦ç”µè„‘åä¼š">
                æ–°å±±å®½æŸ”ä¸­å­¦ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <button class="btn btn-outline-light me-2" id="checkResultBtn">
                            <i class="fas fa-search me-1"></i>æŸ¥è¯¢ç»“æœ
                        </button>
                    </li>
                    <li class="nav-item" id="loginNavItem">
                        <button class="btn btn-outline-light" id="loginButton">
                            <i class="fab fa-google me-1"></i>ç™»å½•
                        </button>
                    </li>
                    <li class="nav-item d-none" id="userNavItem">
                        <div class="dropdown">
                            <button class="btn btn-outline-light dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown">
                                <span id="userName"></span>
                                <img src="" alt="ç”¨æˆ·å¤´åƒ" id="userPhoto" style="height: 30px; width: 30px; border-radius: 50%; margin-left: 5px;">
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" id="quizLink"><i class="fas fa-play-circle me-2"></i>å¼€å§‹ç­”é¢˜</a></li>
                                <li><a class="dropdown-item" href="#" id="adminLink"><i class="fas fa-cog me-2"></i>ç®¡ç†å‘˜é¢æ¿</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutButton"><i class="fas fa-sign-out-alt me-2"></i>é€€å‡ºç™»å½•</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container my-5" id="mainContent">
        <!-- æ¬¢è¿ç•Œé¢ -->
        <div id="welcomeView">
            <div class="welcome-section">
                <h1>æ¬¢è¿å‚åŠ å®½æŸ”ä¸­å­¦ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›</h1>
                <p class="lead mb-4">æµ‹è¯•æ‚¨çš„çŸ¥è¯†æ°´å¹³ï¼Œä¸åŒå­¦ä»¬ä¸€è¾ƒé«˜ä¸‹ï¼è¯·ä½¿ç”¨Googleè´¦å·ç™»å½•åå¼€å§‹ç­”é¢˜ã€‚</p>
                <button class="btn btn-light btn-lg px-4 py-2" id="welcomeLoginButton">
                    <i class="fab fa-google me-2"></i> ä½¿ç”¨Googleè´¦å·ç™»å½•
                </button>
            </div>
            
            <!-- æ¯”èµ›ä¿¡æ¯é¢æ¿ -->
            <div class="competition-info-panel">
                <h3 class="mb-4"><i class="fas fa-info-circle me-2"></i>æ¯”èµ›ä¿¡æ¯</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div>
                                <h5>æ¯”èµ›æ—¶é—´</h5>
                                <p>2025å¹´8æœˆ4æ—¥</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div>
                                <h5>æ¯”èµ›åœ°ç‚¹</h5>
                                <p>éƒ­é’¦é‰´æ¥¼10æ¥¼ç”µè„‘å®¤L1003, L1004</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div>
                                <h5>å¥–é¡¹è®¾ç½®</h5>
                                <p>åˆä¸­ç»„å’Œé«˜ä¸­ç»„å„è®¾å† äºšå­£å†›</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h5>å‚èµ›å¯¹è±¡</h5>
                                <p>å®½æŸ”ä¸­å­¦åœ¨æ ¡å­¦ç”Ÿ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clipboard-list me-2"></i>æ¯”èµ›è§„åˆ™
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><i class="fas fa-clock me-2 text-primary"></i>æ¯”èµ›æ—¶é—´ä¸º60åˆ†é’Ÿ</li>
                                <li class="list-group-item"><i class="fas fa-question-circle me-2 text-primary"></i>é¢˜ç›®åˆ†ä¸ºå•é€‰é¢˜ã€å¤šé€‰é¢˜ã€é—®ç­”é¢˜å’Œç”³è®ºé¢˜</li>
                                <li class="list-group-item"><i class="fas fa-check-circle me-2 text-success"></i>ç­”å¯¹å¾—åˆ†ï¼Œç­”é”™ä¸æ‰£åˆ†</li>
                                <li class="list-group-item"><i class="fas fa-calculator me-2 text-primary"></i>æ¯”èµ›ç»“æŸåç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æˆç»©</li>
                                <li class="list-group-item"><i class="fas fa-ban me-2 text-danger"></i>ç¦æ­¢ä½¿ç”¨ä»»ä½•å¤–éƒ¨è¾…åŠ©å·¥å…·</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-2"></i>å®æ—¶ç»Ÿè®¡
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="admin-stats-card bg-primary">
                                        <h5>æ€»å‚èµ›äººæ•°</h5>
                                        <h2 id="totalParticipantsCount">0</h2>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="admin-stats-card bg-success">
                                        <h5>å·²å®Œæˆäººæ•°</h5>
                                        <h2 id="completedParticipantsCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="progress">
                                    <div class="progress-bar" id="globalProgress" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted">æ€»ä½“å®Œæˆè¿›åº¦</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å…¬å‘Šæ  -->
            <div class="announcement-board mt-4">
                <div class="announcement-header">
                    <div class="announcement-icon">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <h4 class="mb-0">é‡è¦å…¬å‘Š</h4>
                </div>
                <div class="announcement-content">
                    <p>1. æ¯”èµ›æœŸé—´è¯·ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®šï¼Œé¿å…ç­”é¢˜è¿‡ç¨‹ä¸­æ–­ã€‚</p>
                    <p>2. è¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚</p>
                    <p>3. æ¯”èµ›å¼€å§‹åè®¡æ—¶å™¨å°†è‡ªåŠ¨å¯åŠ¨ï¼Œæ— æ³•æš‚åœã€‚</p>
                    <p>4. å¦‚æœ‰ä»»ä½•æŠ€æœ¯é—®é¢˜ï¼Œè¯·è”ç³»ç°åœºå·¥ä½œäººå‘˜ã€‚</p>
                </div>
            </div>
        </div>
        
        <!-- ç»“æœæŸ¥è¯¢ç•Œé¢ -->
        <div id="resultCheckView" class="d-none">
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title"><i class="fas fa-search me-2"></i>æŸ¥è¯¢æ¯”èµ›ç»“æœ</h2>
                </div>
                <div class="card-body">
                    <form id="resultCheckForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="checkName" class="form-label">å§“å</label>
                                <input type="text" class="form-control" id="checkName" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="checkClass" class="form-label">ç­çº§</label>
                                <input type="text" class="form-control" id="checkClass" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="checkStudentId" class="form-label">å­¦å·</label>
                                <input type="text" class="form-control" id="checkStudentId" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-3">
                            <i class="fas fa-search me-2"></i>æŸ¥è¯¢ç»“æœ
                        </button>
                    </form>
                    
                    <div class="result-container mt-4 d-none" id="resultCheckContainer">
                        <h3 class="text-center mb-4">æŸ¥è¯¢ç»“æœ</h3>
                        <div class="alert alert-success" id="resultCheckSuccess" style="display: none;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-trophy fa-2x me-3"></i>
                                <div>
                                    <h4 class="alert-heading mb-2">æ­å–œæ‚¨å·²æ™‹çº§/è·å¥–ï¼</h4>
                                    <div id="resultCheckDetails"></div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info" id="resultCheckInfo" style="display: none;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3"></i>
                                <div>
                                    <h4 class="alert-heading mb-2">æŸ¥è¯¢ç»“æœ</h4>
                                    <p id="resultCheckMessage"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‚èµ›è€…ç­”é¢˜ç•Œé¢ -->
        <div id="quizView" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="section-title mb-2">å¸¸è¯†æ¯”èµ›ç­”é¢˜ç³»ç»Ÿ</h2>
                    <div class="text-muted">
                        <i class="fas fa-user me-1"></i>
                        <span id="quizUserInfo"></span>
                    </div>
                </div>
                <div class="timer" id="quizTimer">å‰©ä½™æ—¶é—´: 60:00</div>
            </div>
            
            <!-- ç­”é¢˜å¯¼èˆªç‚¹ -->
            <div class="question-nav-dots" id="questionNavDots"></div>
            
            <div class="progress mb-4">
                <div class="progress-bar" id="quizProgress" role="progressbar" style="width: 0%"></div>
            </div>
            
            <div id="quizQuestionsContainer"></div>
            
            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" id="prevQuestionBtn">
                    <i class="fas fa-arrow-left me-1"></i>ä¸Šä¸€é¢˜
                </button>
                <div>
                    <button class="btn btn-warning me-2" id="markQuestionBtn">
                        <i class="fas fa-flag me-1"></i>æ ‡è®°æœ¬é¢˜
                    </button>
                    <button class="btn btn-outline-primary" id="reviewQuestionsBtn">
                        <i class="fas fa-list me-1"></i>é¢˜ç›®åˆ—è¡¨
                    </button>
                </div>
                <div>
                    <button class="btn btn-primary me-2" id="nextQuestionBtn">
                        ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                    <button class="btn btn-success" id="submitQuizBtn">
                        <i class="fas fa-paper-plane me-1"></i>æäº¤ç­”å·
                    </button>
                </div>
            </div>
        </div>

        <!-- å‚èµ›è€…ç»“æœç•Œé¢ -->
        <div id="resultView" class="d-none">
            <div class="result-summary">
                <h2 class="section-title">æ¯”èµ›ç»“æœ</h2>
                <div class="result-score" id="finalScore">0/100</div>
                <p class="lead">æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼ä»¥ä¸‹æ˜¯æ‚¨çš„ç­”é¢˜è¯¦æƒ…ï¼š</p>
                
                <div class="row text-center mt-4">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h5 class="card-title">æ­£ç¡®é¢˜æ•°</h5>
                                <p class="display-4 text-primary" id="correctCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body">
                                <h5 class="card-title">é”™è¯¯é¢˜æ•°</h5>
                                <p class="display-4 text-danger" id="wrongCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h5 class="card-title">æœªç­”é¢˜æ•°</h5>
                                <p class="display-4 text-warning" id="unansweredCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body">
                                <h5 class="card-title">æ€»å¾—åˆ†</h5>
                                <p class="display-4 text-success" id="totalScore">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>ç»„åˆ«æ’å</h5>
                                <p class="display-6" id="groupRank">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>æ€»æ’å</h5>
                                <p class="display-6" id="overallRank">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <h3 class="section-title mt-5">ç­”é¢˜è¯¦æƒ…</h3>
            <div id="resultQuestionsContainer"></div>
            
            <div class="text-center mt-4">
                <button class="btn btn-primary me-2" id="viewRankingBtn">
                    <i class="fas fa-trophy me-1"></i>æŸ¥çœ‹å®Œæ•´æ’å
                </button>
                <button class="btn btn-success" id="downloadCertificateBtn">
                    <i class="fas fa-award me-1"></i>ä¸‹è½½æˆç»©è¯ä¹¦
                </button>
            </div>
        </div>

        <!-- æ’åç•Œé¢ -->
        <div id="rankingView" class="d-none">
            <h2 class="section-title">æ¯”èµ›æ’å</h2>
            
            <ul class="nav nav-tabs" id="rankingTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="highschool-tab" data-bs-toggle="tab" data-bs-target="#highschool" type="button">
                        <i class="fas fa-user-graduate me-1"></i>é«˜ä¸­ç»„
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="middleschool-tab" data-bs-toggle="tab" data-bs-target="#middleschool" type="button">
                        <i class="fas fa-user me-1"></i>åˆä¸­ç»„
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="overall-tab" data-bs-toggle="tab" data-bs-target="#overall" type="button">
                        <i class="fas fa-globe me-1"></i>æ€»æ’å
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="rankingTabContent">
                <div class="tab-pane fade show active" id="highschool" role="tabpanel">
                    <div class="table-responsive">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>å§“å</th>
                                    <th>ç­çº§</th>
                                    <th>æ­£ç¡®é¢˜æ•°</th>
                                    <th>é”™è¯¯é¢˜æ•°</th>
                                    <th>å¾—åˆ†</th>
                                    <th>ç”¨æ—¶</th>
                                </tr>
                            </thead>
                            <tbody id="highschoolRankingBody">
                                <!-- é«˜ä¸­ç»„æ’åæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="middleschool" role="tabpanel">
                    <div class="table-responsive">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>å§“å</th>
                                    <th>ç­çº§</th>
                                    <th>æ­£ç¡®é¢˜æ•°</th>
                                    <th>é”™è¯¯é¢˜æ•°</th>
                                    <th>å¾—åˆ†</th>
                                    <th>ç”¨æ—¶</th>
                                </tr>
                            </thead>
                            <tbody id="middleschoolRankingBody">
                                <!-- åˆä¸­ç»„æ’åæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="overall" role="tabpanel">
                    <div class="table-responsive">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>å§“å</th>
                                    <th>ç­çº§</th>
                                    <th>ç»„åˆ«</th>
                                    <th>æ­£ç¡®é¢˜æ•°</th>
                                    <th>é”™è¯¯é¢˜æ•°</th>
                                    <th>å¾—åˆ†</th>
                                    <th>ç”¨æ—¶</th>
                                </tr>
                            </thead>
                            <tbody id="overallRankingBody">
                                <!-- æ€»æ’åæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button class="btn btn-secondary" id="backToResultBtn">
                    <i class="fas fa-arrow-left me-1"></i>è¿”å›æˆ‘çš„æˆç»©
                </button>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜ç•Œé¢ -->
        <div id="adminView" class="d-none">
            <h2 class="section-title">ç®¡ç†å‘˜é¢æ¿</h2>
            
            <!-- ç®¡ç†å‘˜ç»Ÿè®¡å¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="admin-stats-card bg-primary">
                        <h5>æ€»å‚èµ›äººæ•°</h5>
                        <h2 id="adminTotalParticipants">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="admin-stats-card bg-success">
                        <h5>å·²å®Œæˆäººæ•°</h5>
                        <h2 id="adminCompletedParticipants">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="admin-stats-card bg-info">
                        <h5>å¹³å‡åˆ†</h5>
                        <h2 id="adminAverageScore">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="admin-stats-card bg-warning">
                        <h5>æœ€é«˜åˆ†</h5>
                        <h2 id="adminHighestScore">0</h2>
                    </div>
                </div>
            </div>
            
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button">
                        <i class="fas fa-question-circle me-1"></i>é¢˜ç›®ç®¡ç†
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="participants-tab" data-bs-toggle="tab" data-bs-target="#participants" type="button">
                        <i class="fas fa-users me-1"></i>å‚èµ›è€…ç®¡ç†
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button">
                        <i class="fas fa-chart-bar me-1"></i>æˆç»©ç®¡ç†
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                        <i class="fas fa-cogs me-1"></i>æ¯”èµ›è®¾ç½®
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="awards-tab" data-bs-toggle="tab" data-bs-target="#awards" type="button">
                        <i class="fas fa-trophy me-1"></i>æ™‹çº§/è·å¥–ç®¡ç†
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="paper-tab" data-bs-toggle="tab" data-bs-target="#paper" type="button">
                        <i class="fas fa-file-alt me-1"></i>æ™ºèƒ½ç»„å·
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="adminTabContent">
                <div class="tab-pane fade show active" id="questions" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-list me-2"></i>é¢˜ç›®åˆ—è¡¨</span>
                                    <div>
                                        <button class="btn btn-sm btn-success me-2" id="importQuestionsBtn">
                                            <i class="fas fa-upload me-1"></i>å¯¼å…¥
                                        </button>
                                        <button class="btn btn-sm btn-primary" id="addQuestionBtn">
                                            <i class="fas fa-plus me-1"></i>æ·»åŠ é¢˜ç›®
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>åºå·</th>
                                                    <th>é¢˜ç›®å†…å®¹</th>
                                                    <th>ç±»å‹</th>
                                                    <th>åˆ†å€¼</th>
                                                    <th>éš¾åº¦</th>
                                                    <th>æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="questionListBody">
                                                <!-- é¢˜ç›®åˆ—è¡¨æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-edit me-2"></i>é¢˜ç›®ç¼–è¾‘
                                </div>
                                <div class="card-body">
                                    <form id="questionForm">
                                        <input type="hidden" id="questionId">
                                        <div class="mb-3">
                                            <label for="questionType" class="form-label">é¢˜ç›®ç±»å‹</label>
                                            <select class="form-select" id="questionType" required>
                                                <option value="single">å•é€‰é¢˜</option>
                                                <option value="multiple">å¤šé€‰é¢˜</option>
                                                <option value="short_answer">é—®ç­”é¢˜</option>
                                                <option value="essay">ç”³è®ºé¢˜</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="questionDifficulty" class="form-label">é¢˜ç›®éš¾åº¦</label>
                                            <select class="form-select" id="questionDifficulty">
                                                <option value="easy">ç®€å•</option>
                                                <option value="medium" selected>ä¸­ç­‰</option>
                                                <option value="hard">å›°éš¾</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="questionPoints" class="form-label">åˆ†å€¼</label>
                                            <input type="number" class="form-control" id="questionPoints" min="1" value="5" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="questionText" class="form-label">é¢˜ç›®å†…å®¹</label>
                                            <div id="editor" style="height: 200px;"></div>
                                            <textarea class="form-control d-none" id="questionText" rows="3" required></textarea>
                                        </div>
                                        
                                        <!-- å›¾ç‰‡ä¸Šä¼  -->
                                        <div class="mb-3">
                                            <label class="form-label">é¢˜ç›®å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                                            <div class="image-upload-container" id="imageUploadContainer">
                                                <i class="fas fa-image fa-3x mb-2" style="color: #6c757d;"></i>
                                                <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                                                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                                <img id="imagePreview" class="image-preview d-none">
                                            </div>
                                        </div>

                                        <!-- å‚è€ƒç­”æ¡ˆè¾“å…¥æ¡† -->
                                        <div class="mb-3" id="correctAnswerContainer" style="display: none;">
                                            <label for="correctAnswerText" class="form-label">å‚è€ƒç­”æ¡ˆ</label>
                                            <div id="answerEditor" style="height: 150px;"></div>
                                            <textarea class="form-control d-none" id="correctAnswerText" name="correctAnswerText" rows="3"></textarea>
                                        </div>
                                        
                                        <!-- é€‰é¡¹å®¹å™¨ï¼ˆä»…é€‰æ‹©é¢˜æ˜¾ç¤ºï¼‰ -->
                                        <div class="mb-3" id="optionsSection">
                                            <label class="form-label">é€‰é¡¹</label>
                                            <div id="optionsContainer">
                                                <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                            </div>
                                            <button type="button" class="btn btn-sm btn-secondary mt-2" id="addOptionBtn">
                                                <i class="fas fa-plus me-1"></i>æ·»åŠ é€‰é¡¹
                                            </button>
                                        </div>
                                        
                                        <!-- æ­£ç¡®ç­”æ¡ˆå®¹å™¨ï¼ˆä»…é€‰æ‹©é¢˜æ˜¾ç¤ºï¼‰ -->
                                        <div class="mb-3" id="correctAnswersSection">
                                            <label class="form-label">æ­£ç¡®ç­”æ¡ˆ</label>
                                            <div id="correctAnswersContainer">
                                                <!-- æ­£ç¡®ç­”æ¡ˆé€‰æ‹©å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                            </div>
                                        </div>
                                       
                                        <div class="d-flex justify-content-between mt-4">
                                            <button type="button" class="btn btn-secondary" id="cancelEditBtn">
                                                å–æ¶ˆ
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-1"></i>ä¿å­˜
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="participants" role="tabpanel">
                    <!-- å®æ—¶ç›‘æ§ -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-desktop me-2"></i>å®æ—¶ç›‘æ§</span>
                            <button class="btn btn-sm btn-primary" id="refreshMonitorBtn">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-header">å‚èµ›è€…åˆ—è¡¨</div>
                                        <div class="card-body p-0">
                                            <div class="list-group list-group-flush" id="participantMonitorList">
                                                <!-- åŠ¨æ€å¡«å……å‚èµ›è€…åˆ—è¡¨ -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="card h-100">
                                        <div class="card-header">ç­”é¢˜è¯¦æƒ…</div>
                                        <div class="card-body" id="participantMonitorView">
                                            <div class="text-center text-muted py-5">
                                                <i class="fas fa-mouse-pointer fa-2x mb-3"></i>
                                                <p>è¯·ä»å·¦ä¾§é€‰æ‹©å‚èµ›è€…æŸ¥çœ‹è¯¦æƒ…</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-users me-2"></i>å‚èµ›è€…åˆ—è¡¨
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>å§“å</th>
                                            <th>ç­çº§</th>
                                            <th>ç»„åˆ«</th>
                                            <th>çŠ¶æ€</th>
                                            <th>ç­”é¢˜è¿›åº¦</th>
                                            <th>å¾—åˆ†</th>
                                            <th>è­¦å‘Šæ¬¡æ•°</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="participantListBody">
                                        <!-- å‚èµ›è€…åˆ—è¡¨æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="results" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- æˆç»©åˆ†å¸ƒå›¾è¡¨ -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-chart-bar me-2"></i>æˆç»©åˆ†å¸ƒ
                                </div>
                                <div class="card-body">
                                    <div class="score-distribution" id="scoreDistribution">
                                        <!-- æˆç»©åˆ†å¸ƒå›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                            
                             <!-- è­¦å‘Šè®°å½•è¯¦æƒ…æ¨¡æ€æ¡† - æ–°å¢ -->
    <div class="modal fade" id="warningDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>ä½œå¼Šè­¦å‘Šè®°å½•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="warningDetailsContent">
                        <!-- åŠ¨æ€å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
                            <!-- è¯¦ç»†æˆç»©åˆ—è¡¨ -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-list-ol me-2"></i>è¯¦ç»†æˆç»©</span>
                                    <button class="btn btn-sm btn-primary" id="exportAllResultsBtn">
                                        <i class="fas fa-download me-1"></i>å¯¼å‡ºå…¨éƒ¨
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>æ’å</th>
                                                    <th>å§“å</th>
                                                    <th>ç­çº§</th>
                                                    <th>ç»„åˆ«</th>
                                                    <th>æ­£ç¡®é¢˜æ•°</th>
                                                    <th>é”™è¯¯é¢˜æ•°</th>
                                                    <th>å¾—åˆ†</th>
                                                    <th>ç”¨æ—¶</th>
                                                    <th>æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="detailedResultsBody">
                                                <!-- è¯¦ç»†æˆç»©æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-download me-2"></i>æˆç»©å¯¼å‡º
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">å¯¼å‡ºæ ¼å¼</label>
                                        <select class="form-select" id="exportFormat">
                                            <option value="csv">CSVæ ¼å¼</option>
                                            <option value="excel">Excelæ ¼å¼</option>
                                            <option value="pdf">PDFæ ¼å¼</option>
                                            <option value="png">PNGæˆªå›¾</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">å¯¼å‡ºèŒƒå›´</label>
                                        <select class="form-select" id="exportScope">
                                            <option value="all">å…¨éƒ¨å‚èµ›è€…</option>
                                            <option value="highschool">é«˜ä¸­ç»„</option>
                                            <option value="middleschool">åˆä¸­ç»„</option>
                                            <option value="completed">å·²å®Œæˆæ¯”èµ›</option>
                                            <option value="incomplete">æœªå®Œæˆæ¯”èµ›</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">æ’åºæ–¹å¼</label>
                                        <select class="form-select" id="exportSort">
                                            <option value="score">æŒ‰å¾—åˆ†æ’åº</option>
                                            <option value="time">æŒ‰ç”¨æ—¶æ’åº</option>
                                            <option value="name">æŒ‰å§“åæ’åº</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary w-100 py-2" id="exportResultsBtn">
                                        <i class="fas fa-file-export me-2"></i>å¯¼å‡ºæˆç»©
                                    </button>
                                </div>
                            </div>
                            
                            <!-- æ•°æ®ç»Ÿè®¡ -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <i class="fas fa-chart-pie me-2"></i>æ•°æ®ç»Ÿè®¡
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">å¹³å‡æ­£ç¡®ç‡</label>
                                        <div class="progress">
                                            <div class="progress-bar" id="avgAccuracyBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="avgAccuracyText">0%</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">å¹³å‡ç”¨æ—¶</label>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-clock text-primary me-2"></i>
                                            <span id="avgTimeUsed">0åˆ†0ç§’</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">æœ€å¿«æäº¤</label>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-bolt text-warning me-2"></i>
                                            <span id="fastestSubmit">0åˆ†0ç§’</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-cogs me-2"></i>æ¯”èµ›è®¾ç½®
                                </div>
                                <div class="card-body">
                                    <form id="quizSettingsForm">
                                        <div class="mb-3">
                                            <label for="quizTitle" class="form-label">æ¯”èµ›æ ‡é¢˜</label>
                                            <input type="text" class="form-control" id="quizTitle" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="quizDescription" class="form-label">æ¯”èµ›æè¿°</label>
                                            <textarea class="form-control" id="quizDescription" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="quizDuration" class="form-label">æ¯”èµ›æ—¶é•¿(åˆ†é’Ÿ)</label>
                                            <input type="number" class="form-control" id="quizDuration" min="1" required>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="quizStartTime" class="form-label">å¼€å§‹æ—¶é—´</label>
                                                <input type="datetime-local" class="form-control" id="quizStartTime" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="quizEndTime" class="form-label">ç»“æŸæ—¶é—´</label>
                                                <input type="datetime-local" class="form-control" id="quizEndTime" required>
                                            </div>
                                        </div>
                                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="showResultsImmediately">
                            <label class="form-check-label" for="showResultsImmediately">ç«‹å³æ˜¾ç¤ºç»“æœ</label>
                        </div>
                        <div class="mb-3" id="resultsDelaySection" style="display: none;">
                            <label for="resultsDelay" class="form-label">ç»“æœå»¶è¿Ÿæ˜¾ç¤ºæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" class="form-control" id="resultsDelay" min="0" value="0">
                        </div>
                        
                        <!-- ä¿®æ”¹è¿™é‡Œï¼šé‡æ–°ç­”é¢˜è®¾ç½® -->
                        <div class="mb-3">
                            <label for="retakeMode" class="form-label">é‡æ–°ç­”é¢˜æ¨¡å¼</label>
                            <select class="form-select" id="retakeMode">
                                <option value="disallow">ä¸å…è®¸é‡æ–°ç­”é¢˜</option>
                                <option value="allow_limited">é™åˆ¶æ¬¡æ•°é‡æ–°ç­”é¢˜</option>
                                <option value="allow_unlimited">æ— é™æ¬¡é‡æ–°ç­”é¢˜</option>
                            </select>
                        </div>
                        <div class="mb-3" id="retakeLimitSection" style="display: none;">
                            <label for="retakeLimit" class="form-label">æœ€å¤§é‡è¯•æ¬¡æ•°</label>
                            <input type="number" class="form-control" id="retakeLimit" min="1" value="3">
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="enableAntiCheat">
                            <label class="form-check-label" for="enableAntiCheat">å¯ç”¨é˜²ä½œå¼Šç³»ç»Ÿ</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-1"></i>ä¿å­˜è®¾ç½®
                        </button>
                    </form>
                </div>
            </div>
        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-info-circle me-2"></i>ç³»ç»Ÿä¿¡æ¯
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">å½“å‰æ¯”èµ›çŠ¶æ€</label>
                                        <div class="alert alert-info" id="quizStatus">
                                            <i class="fas fa-info-circle me-1"></i>æœªå¼€å§‹
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">ç³»ç»Ÿæ“ä½œ</label>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-success" id="startQuizBtn">
                                                <i class="fas fa-play me-1"></i>å¼€å§‹æ¯”èµ›
                                            </button>
                                            <button class="btn btn-warning" id="pauseQuizBtn">
                                                <i class="fas fa-pause me-1"></i>æš‚åœæ¯”èµ›
                                            </button>
                                            <button class="btn btn-danger" id="endQuizBtn">
                                                <i class="fas fa-stop me-1"></i>ç»“æŸæ¯”èµ›
                                            </button>
                                            <button class="btn btn-secondary" id="resetQuizBtn">
                                                <i class="fas fa-redo me-1"></i>é‡ç½®æ¯”èµ›æ•°æ®
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="form-label">ç³»ç»ŸçŠ¶æ€</label>
                                        <ul class="list-group">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                æ•°æ®åº“è¿æ¥
                                                <span class="badge bg-success rounded-pill">æ­£å¸¸</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                å­˜å‚¨æœåŠ¡
                                                <span class="badge bg-success rounded-pill">æ­£å¸¸</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                ç”¨æˆ·è®¤è¯
                                                <span class="badge bg-success rounded-pill">æ­£å¸¸</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="paper" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-magic me-2"></i>æ™ºèƒ½ç»„å·ç³»ç»Ÿ
                        </div>
                        <div class="card-body">
                            <form id="paperForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">è¯•å·åç§°</label>
                                        <input type="text" class="form-control" id="paperName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">è¯•å·æ€»åˆ†</label>
                                        <input type="number" class="form-control" id="paperTotalPoints" min="10" value="100" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">é¢˜ç›®ç±»å‹åˆ†å¸ƒ</label>
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <label class="form-label">å•é€‰é¢˜</label>
                                            <input type="number" class="form-control question-dist" data-type="single" min="0" value="20">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">å¤šé€‰é¢˜</label>
                                            <input type="number" class="form-control question-dist" data-type="multiple" min="0" value="10">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">é—®ç­”é¢˜</label>
                                            <input type="number" class="form-control question-dist" data-type="short_answer" min="0" value="5">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">ç”³è®ºé¢˜</label>
                                            <input type="number" class="form-control question-dist" data-type="essay" min="0" value="2">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">é¢˜ç›®éš¾åº¦åˆ†å¸ƒ</label>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label class="form-label">ç®€å•é¢˜ (%)</label>
                                            <input type="number" class="form-control difficulty-dist" data-level="easy" min="0" max="100" value="30">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">ä¸­ç­‰é¢˜ (%)</label>
                                            <input type="number" class="form-control difficulty-dist" data-level="medium" min="0" max="100" value="50">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">éš¾é¢˜ (%)</label>
                                            <input type="number" class="form-control difficulty-dist" data-level="hard" min="0" max="100" value="20">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">çŸ¥è¯†ç‚¹è¦†ç›–</label>
                                    <select class="form-select" id="paperCategories" multiple>
                                        <option value="general">é€šç”¨çŸ¥è¯†</option>
                                        <option value="programming">ç¼–ç¨‹</option>
                                        <option value="hardware">ç¡¬ä»¶</option>
                                        <option value="network">ç½‘ç»œ</option>
                                        <option value="security">å®‰å…¨</option>
                                        <option value="history">å†å²</option>
                                    </select>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-magic me-1"></i>ç”Ÿæˆè¯•å·
                                    </button>
                                </div>
                            </form>
                            
                            <div class="mt-4" id="generatedPaperContainer" style="display:none;">
                                <h5><i class="fas fa-file-alt me-2"></i>ç”Ÿæˆçš„è¯•å·</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="generatedPaperTable">
                                        <thead>
                                            <tr>
                                                <th>é¢˜å·</th>
                                                <th>é¢˜ç›®å†…å®¹</th>
                                                <th>ç±»å‹</th>
                                                <th>åˆ†å€¼</th>
                                                <th>éš¾åº¦</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-secondary" id="regeneratePaperBtn">
                                        <i class="fas fa-redo me-1"></i>é‡æ–°ç”Ÿæˆ
                                    </button>
                                    <button class="btn btn-success" id="savePaperBtn">
                                        <i class="fas fa-save me-1"></i>ä¿å­˜è¯•å·
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="awards" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-trophy me-2"></i>æ™‹çº§/è·å¥–ç®¡ç†</span>
            <div>
                <button class="btn btn-sm btn-primary me-2" id="addAwardBtn">
                    <i class="fas fa-plus me-1"></i>æ·»åŠ è·å¥–è€…
                </button>
                <button class="btn btn-sm btn-success" id="autoGenerateAwardsBtn">
                    <i class="fas fa-magic me-1"></i>è‡ªåŠ¨ç”Ÿæˆ
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- æ™‹çº§è®¾ç½®è¡¨å• -->
            <form id="awardSettingsForm" class="mb-4">
                <h5><i class="fas fa-cog me-2"></i>æ™‹çº§è®¾ç½®</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="awardMode" class="form-label">æ™‹çº§æ¨¡å¼</label>
                        <select class="form-select" id="awardMode" required>
                            <option value="auto">è‡ªåŠ¨æ™‹çº§</option>
                            <option value="manual">æ‰‹åŠ¨è®¾ç½®</option>
                            <option value="mixed">æ··åˆæ¨¡å¼</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="minimumScore" class="form-label">æœ€ä½æ™‹çº§åˆ†æ•°</label>
                        <input type="number" class="form-control" id="minimumScore" min="0" max="100" value="60" required>
                    </div>
                    <div class="col-md-4">
                        <label for="qualifyPercentage" class="form-label">æ™‹çº§æ¯”ä¾‹ (%)</label>
                        <input type="number" class="form-control" id="qualifyPercentage" min="0" max="100" value="30" required>
                    </div>
                </div>
                
                <div id="autoSettings" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="highschoolQualifyCount" class="form-label">é«˜ä¸­ç»„æ™‹çº§åé¢</label>
                            <input type="number" class="form-control" id="highschoolQualifyCount" min="0" value="10" required>
                        </div>
                        <div class="col-md-6">
                            <label for="middleschoolQualifyCount" class="form-label">åˆä¸­ç»„æ™‹çº§åé¢</label>
                            <input type="number" class="form-control" id="middleschoolQualifyCount" min="0" value="10" required>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="highschoolFirstPrize" class="form-label">é«˜ä¸­ç»„ä¸€ç­‰å¥–å¥–å“</label>
                        <input type="text" class="form-control" id="highschoolFirstPrize" placeholder="ä¾‹å¦‚ï¼šç¬”è®°æœ¬ç”µè„‘">
                    </div>
                    <div class="col-md-6">
                        <label for="middleschoolFirstPrize" class="form-label">åˆä¸­ç»„ä¸€ç­‰å¥–å¥–å“</label>
                        <input type="text" class="form-control" id="middleschoolFirstPrize" placeholder="ä¾‹å¦‚ï¼šå¹³æ¿ç”µè„‘">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>ä¿å­˜è®¾ç½®
                </button>
            </form>
            
            <hr>
            
            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5><i class="fas fa-bolt me-2"></i>å¿«é€Ÿæ“ä½œ</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary" id="exportAwardsBtn">
                            <i class="fas fa-download me-1"></i>å¯¼å‡ºåå•
                        </button>
                        <button class="btn btn-outline-success" id="importAwardsBtn">
                            <i class="fas fa-upload me-1"></i>å¯¼å…¥åå•
                        </button>
                        <button class="btn btn-outline-danger" id="clearAwardsBtn">
                            <i class="fas fa-trash me-1"></i>æ¸…ç©ºåå•
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h6 class="card-title">æ€»è·å¥–äººæ•°</h6>
                            <h2 id="totalAwardsCount">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h6 class="card-title">ä»Šæ—¥æ–°å¢</h6>
                            <h2 id="todayAwardsCount">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h6 class="card-title">é«˜ä¸­ç»„</h6>
                            <h2 id="highschoolAwardsCount">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h6 class="card-title">åˆä¸­ç»„</h6>
                            <h2 id="middleschoolAwardsCount">0</h2>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è·å¥–åå•è¡¨æ ¼ -->
            <h5><i class="fas fa-list me-2"></i>è·å¥–/æ™‹çº§åå•</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>å§“å</th>
                            <th>ç­çº§</th>
                            <th>å­¦å·</th>
                            <th>ç»„åˆ«</th>
                            <th>å¥–é¡¹</th>
                            <th>å¾—åˆ†</th>
                            <th>æ’å</th>
                            <th>å¤‡æ³¨</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="awardsListBody">
                        <!-- è·å¥–åå•å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="userInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>å‚èµ›ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userInfoForm">
                        <div class="mb-3">
                            <label for="userClass" class="form-label">ç­çº§</label>
                            <input type="text" class="form-control" id="userClass" placeholder="ä¾‹å¦‚: é«˜ä¸‰ç†(1)" required>
                        </div>
                        <div class="mb-3">
                            <label for="userGroup" class="form-label">ç»„åˆ«</label>
                            <select class="form-select" id="userGroup" required>
                                <option value="">è¯·é€‰æ‹©ç»„åˆ«</option>
                                <option value="highschool">é«˜ä¸­ç»„</option>
                                <option value="middleschool">åˆä¸­ç»„</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="userStudentId" class="form-label">å­¦å·</label>
                            <input type="text" class="form-control" id="userStudentId" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-primary" id="saveUserInfoBtn">
                        <i class="fas fa-save me-1"></i>ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤æäº¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="submitConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-paper-plane me-2"></i>ç¡®è®¤æäº¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>æ‚¨ç¡®å®šè¦æäº¤ç­”å·å—ï¼Ÿæäº¤åå°†æ— æ³•ä¿®æ”¹ç­”æ¡ˆã€‚</p>
                    <div class="alert alert-warning">
                        <strong><i class="fas fa-exclamation-triangle me-1"></i>æ³¨æ„ï¼š</strong> 
                        æ‚¨è¿˜æœ‰ <span id="unansweredCountModal" class="fw-bold">0</span> é¢˜æœªä½œç­”ã€‚
                    </div>
                    <div class="alert alert-info">
                        <strong><i class="fas fa-info-circle me-1"></i>æç¤ºï¼š</strong>
                        å‰©ä½™æ—¶é—´ï¼š<span id="remainingTimeModal" class="fw-bold">60:00</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmSubmitBtn">
                        <i class="fas fa-paper-plane me-1"></i>ç¡®è®¤æäº¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="exportConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-download me-2"></i>å¯¼å‡ºç¡®è®¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>å³å°†å¯¼å‡º <span id="exportCount" class="fw-bold">0</span> åå‚èµ›è€…çš„æˆç»©æ•°æ®ã€‚</p>
                    <div class="alert alert-info">
                        <strong><i class="fas fa-info-circle me-1"></i>æç¤ºï¼š</strong> 
                        å¯¼å‡ºè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmExportBtn">
                        ç¡®è®¤å¯¼å‡º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆç»©è¯ä¹¦æ¨¡æ€æ¡† -->
    <div class="modal fade" id="certificateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-award me-2"></i>æˆç»©è¯ä¹¦</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="certificate" id="certificateContent">
                        <div class="certificate-content">
                            <h2>æ–°å±±å®½æŸ”ä¸­å­¦ç”µè„‘åä¼š</h2>
                            <h3>å¸¸è¯†æ¯”èµ›æˆç»©è¯ä¹¦</h3>
                            <hr>
                            <h4>å‚èµ›è€…ï¼š<span id="certificateName"></span></h4>
                            <h5>ç­çº§ï¼š<span id="certificateClass"></span></h5>
                            <h5>ç»„åˆ«ï¼š<span id="certificateGroup"></span></h5>
                            <div class="result-score mt-4" id="certificateScore">0/100</div>
                            <h5 class="mt-4">æ€»å¾—åˆ†ï¼š<span id="certificateTotalScore">0</span> åˆ†</h5>
                            <h5>æ’åï¼š<span id="certificateRank"></span></h5>
                            <hr>
                            <p class="mt-4">ç‰¹å‘æ­¤è¯ï¼Œä»¥èµ„é¼“åŠ±</p>
                            <p class="text-muted">é¢å‘æ—¥æœŸï¼š<span id="certificateDate"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        å…³é—­
                    </button>
                    <button type="button" class="btn btn-primary" id="printCertificateBtn">
                        <i class="fas fa-print me-1"></i>æ‰“å°è¯ä¹¦
                    </button>
                </div>
            </div>
        </div>
    </div>
<div class="modal fade" id="awardModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-trophy me-2"></i>æ·»åŠ /ç¼–è¾‘è·å¥–è€…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="awardForm">
                        <input type="hidden" id="awardId">
                        <div class="mb-3">
                            <label for="awardName" class="form-label">å§“å</label>
                            <input type="text" class="form-control" id="awardName" required>
                        </div>
                        <div class="mb-3">
                            <label for="awardClass" class="form-label">ç­çº§</label>
                            <input type="text" class="form-control" id="awardClass" required>
                        </div>
                        <div class="mb-3">
                            <label for="awardStudentId" class="form-label">å­¦å·</label>
                            <input type="text" class="form-control" id="awardStudentId" required>
                        </div>
                        <div class="mb-3">
                            <label for="awardGroup" class="form-label">ç»„åˆ«</label>
                            <select class="form-select" id="awardGroup" required>
                                <option value="">è¯·é€‰æ‹©ç»„åˆ«</option>
                                <option value="highschool">é«˜ä¸­ç»„</option>
                                <option value="middleschool">åˆä¸­ç»„</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="awardType" class="form-label">å¥–é¡¹/çŠ¶æ€</label>
                            <select class="form-select" id="awardType" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="champion">å† å†›</option>
                                <option value="second">äºšå†›</option>
                                <option value="third">å­£å†›</option>
                                <option value="excellent">ä¼˜ç§€å¥–</option>
                                <option value="qualify">æ™‹çº§</option>
                                <option value="participate">å‚ä¸å¥–</option>
                            </select>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="awardScore" class="form-label">å¾—åˆ†</label>
                                <input type="number" class="form-control" id="awardScore" min="0">
                            </div>
                            <div class="col-md-6">
                                <label for="awardRank" class="form-label">æ’å</label>
                                <input type="number" class="form-control" id="awardRank" min="1">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="awardNote" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="awardNote" rows="3" placeholder="å¯å¡«å†™å¥–åŠ±è¯¦æƒ…æˆ–å…¶ä»–å¤‡æ³¨"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveAwardBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ============ ç»“æŸï¼šæ·»åŠ è·å¥–è€…æ¨¡æ€æ¡† ============ -->
    <!-- é¡µè„š -->
    <footer class="footer mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>æ–°å±±å®½æŸ”ä¸­å­¦ç”µè„‘åä¼š</h5>
                    <p>è‡´åŠ›äºæ¨å¹¿è®¡ç®—æœºçŸ¥è¯†ï¼ŒåŸ¹å…»ä¿¡æ¯æŠ€æœ¯äººæ‰ã€‚</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">Â© æ–°å±±å®½æŸ”ä¸­å­¦ç”µè„‘åä¼š - å¸¸è¯†æ¯”èµ›ç³»ç»Ÿ</p>
                    <small>æŠ€æœ¯æ”¯æŒï¼šç”µè„‘åä¼š / é™ˆä¿Šæº</small>
                </div>
            </div>
        </div>
    </footer>
    <!-- å¿«æ·é”®æç¤º -->
    <div class="shortcut-hint d-none" id="shortcutHint">
        <div class="shortcut-item">
            <span>ä¸Šä¸€é¢˜</span>
            <span class="shortcut-key">â†</span>
        </div>
        <div class="shortcut-item">
            <span>ä¸‹ä¸€é¢˜</span>
            <span class="shortcut-key">â†’</span>
        </div>
        <div class="shortcut-item">
            <span>æäº¤ç­”å·</span>
            <span class="shortcut-key">Ctrl + Enter</span>
        </div>
    </div>

    <!-- JavaScript ä»£ç  -->
    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBnlTYP3Tkt0SKbPlW2sMbZCo33GoPhK2M",
            authDomain: "fymcsjb-competition.firebaseapp.com",
            projectId: "fymcsjb-competition",
            storageBucket: "fymcsjb-competition.appspot.com",
            messagingSenderId: "231117222555",
            appId: "1:231117222555:web:a7106a8006774272ec0c3e"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        // å…¨å±€å˜é‡
        let currentUser = null;
        let userInfo = null;
        let quizData = {
            questions: [],
            settings: {
                title: "å®½æŸ”ä¸­å­¦ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›",
                description: "æµ‹è¯•æ‚¨çš„ç”µè„‘çŸ¥è¯†æ°´å¹³",
                duration: 60,
                startTime: null,
                endTime: null,
                showResultsImmediately: true,
                allowRetake: false,
                enableAntiCheat: true,
                status: "not_started"
            }
        };
        let userAnswers = [];
        let currentQuestionIndex = 0;
        let quizTimer = null;
        let timeRemaining = 60 * 60;
        let quizStartTime = null;
        let quill = null;
        let answerQuill = null;
        let currentImageUrl = null;
        let currentMonitoringUserId = null;
        let monitorInterval = null;
        let cheatDetectionEnabled = false;
        let warningCount = 0;
        let maxWarnings = 5;
        let fullscreenCountdown = null;
        let fullscreenTimer = 10;
        let mouseLeaveCount = 0;
        let tabSwitchCount = 0;
        let markedQuestions = new Set();
        // ============ æ¯”èµ›æ—¶é—´éªŒè¯å‡½æ•° ============
function isWithinCompetitionTime() {
    const currentTime = new Date().getTime();
    const startTime = quizData.settings.startTime;
    const endTime = quizData.settings.endTime;
    
    // å¦‚æœæ²¡æœ‰è®¾ç½®å¼€å§‹ç»“æŸæ—¶é—´ï¼Œé»˜è®¤ä¸ºéæ¯”èµ›æ—¶é—´
    if (!startTime || !endTime) {
        console.warn("æ¯”èµ›æ—¶é—´æœªè®¾ç½®");
        return false;
    }
    
    return currentTime >= startTime && currentTime <= endTime;
}

function isCompetitionActive() {
    return quizData.settings.status === 'in_progress';
}

function checkCompetitionTime() {
    if (!isCompetitionActive()) {
        return { allowed: false, reason: 'æ¯”èµ›å°šæœªå¼€å§‹æˆ–å·²ç»“æŸ' };
    }
    
    if (!isWithinCompetitionTime()) {
        return { 
            allowed: false, 
            reason: `ä¸åœ¨æ¯”èµ›æ—¶é—´å†…<br>
                    å½“å‰æ—¶é—´ï¼š${new Date().toLocaleString()}<br>
                    æ¯”èµ›æ—¶é—´ï¼š${quizData.settings.startTime ? 
                      new Date(quizData.settings.startTime).toLocaleString() + ' - ' +
                      new Date(quizData.settings.endTime).toLocaleString() : 'æœªè®¾ç½®'}` 
        };
    }
    
    return { allowed: true, reason: '' };
}
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            console.log("åˆå§‹åŒ–åº”ç”¨ç¨‹åº...");
            // ç¡®ä¿å…³é”®å˜é‡å·²åˆå§‹åŒ–
            if (!userAnswers || !Array.isArray(userAnswers)) {
                userAnswers = [];
                console.log("é‡æ–°åˆå§‹åŒ– userAnswers");
            }
            
            if (!markedQuestions || !(markedQuestions instanceof Set)) {
                markedQuestions = new Set();
                console.log("é‡æ–°åˆå§‹åŒ– markedQuestions");
            }
            
            // ç¡®ä¿å½“å‰ç”¨æˆ·ä¿¡æ¯æ­£ç¡®
            if (currentUser) {
                console.log("å½“å‰ç”¨æˆ·:", currentUser.email);
            }
            
            // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                },
                placeholder: 'è¯·è¾“å…¥é¢˜ç›®å†…å®¹...'
            });
            
            // åˆå§‹åŒ–ç­”æ¡ˆç¼–è¾‘å™¨
            answerQuill = new Quill('#answerEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'è¯·è¾“å…¥å‚è€ƒç­”æ¡ˆ...'
            });

            // ç¡®ä¿é˜²ä½œå¼Šç³»ç»Ÿåˆå§‹çŠ¶æ€
            cheatDetectionEnabled = false;

            bindEventListeners();
            
            // åˆå§‹åŒ–é˜²ä½œå¼Šé¢æ¿ï¼ˆä½†ä¸å¯ç”¨ç›‘æ§ï¼‰
            document.getElementById('cheatDetectionPanel').classList.add('d-none');
            document.getElementById('antiCheatAlert').classList.add('d-none');
            document.getElementById('fullscreenOverlay').classList.add('d-none');

            bindAwardEventListeners();
            document.getElementById('awards-tab')?.addEventListener('click', function() {
                loadAwardsList();
                setTimeout(() => {
                    updateAwardModeUI(); // ç°åœ¨å…ƒç´ å·²ç»åŠ è½½ï¼Œå¯ä»¥å®‰å…¨è°ƒç”¨
                }, 100);
            });
            
            // å½“åˆ‡æ¢åˆ°æ™‹çº§ç®¡ç†é€‰é¡¹å¡æ—¶åŠ è½½æ•°æ®
            document.getElementById('awards-tab')?.addEventListener('click', function() {
                loadAwardsList();
            });
            
            // ç›‘å¬ç¼–è¾‘å™¨å†…å®¹å˜åŒ–
            quill.on('text-change', function() {
                document.getElementById('questionText').value = quill.root.innerHTML;
            });
            
            answerQuill.on('text-change', function() {
                document.getElementById('correctAnswerText').value = answerQuill.root.innerHTML;
            });
            
            // å›¾ç‰‡ä¸Šä¼ å¤„ç†
            const imageUploadContainer = document.getElementById('imageUploadContainer');
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            
            imageUploadContainer.addEventListener('click', function() {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', function(e) {
                handleImageUpload(e.target.files[0]);
            });
            
            // æ‹–æ‹½ä¸Šä¼ 
            imageUploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim();
                this.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            });
            
            imageUploadContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#dee2e6';
                this.style.backgroundColor = '';
            });
            
            imageUploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#dee2e6';
                this.style.backgroundColor = '';
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.match('image.*')) {
                    handleImageUpload(file);
                }
            });
            
            function handleImageUpload(file) {
                if (!file) return;
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(event) {
                    imagePreview.src = event.target.result;
                    imagePreview.classList.remove('d-none');
                    currentImageUrl = event.target.result;
                };
                reader.readAsDataURL(file);
                
                // å®é™…ä¸Šä¼ åˆ° Firebase Storage
                const storageRef = storage.ref('question-images/' + Date.now() + '-' + file.name);
                const uploadTask = storageRef.put(file);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // ä¸Šä¼ è¿›åº¦
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('ä¸Šä¼ è¿›åº¦: ' + progress + '%');
                    },
                    (error) => {
                        console.error("ä¸Šä¼ é”™è¯¯:", error);
                        Swal.fire('é”™è¯¯', 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'error');
                    },
                    () => {
                        // ä¸Šä¼ å®Œæˆï¼Œè·å–ä¸‹è½½URL
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            currentImageUrl = downloadURL;
                        });
                    }
                );
            }
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    updateUserUI();
                    checkUserInfo();
                } else {
                    currentUser = null;
                    userInfo = null;
                    showWelcomeView();
                    updateUserUI();
                }
            });

            // ä»FirebaseåŠ è½½æ•°æ®
            loadQuizData();
            
            // æ›´æ–°å…¨å±€ç»Ÿè®¡
            updateGlobalStats();
            
            // æ˜¾ç¤ºå¿«æ·é”®æç¤ºï¼ˆ5ç§’åè‡ªåŠ¨éšè—ï¼‰
            setTimeout(() => {
                const shortcutHint = document.getElementById('shortcutHint');
                shortcutHint.classList.remove('d-none');
                setTimeout(() => {
                    shortcutHint.classList.add('d-none');
                }, 10000);
            }, 5000);
        }

        // åœ¨init()å‡½æ•°ä¸­æ·»åŠ é¡µé¢çŠ¶æ€æ£€æŸ¥
        function checkPageStateOnLoad() {
            if (currentUser && !document.getElementById('quizView').classList.contains('d-none')) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æäº¤
                database.ref('userAnswers/' + currentUser.uid + '/submitted').once('value')
                    .then(snapshot => {
                        if (snapshot.exists() && snapshot.val() === true) {
                    // å¦‚æœå·²ç»æäº¤ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç»“æœé¡µé¢
                            console.log("æ£€æµ‹åˆ°å·²æäº¤çš„ç­”å·ï¼Œè·³è½¬åˆ°ç»“æœé¡µ");
                            showResultView();
            
                    // ç¡®ä¿æ‰€æœ‰è®¡æ—¶å™¨éƒ½åœæ­¢
                            if (quizTimer) {
                                clearInterval(quizTimer);
                                quizTimer = null;
                            }
                    
                    // åŠ è½½ç»“æœ
                            loadUserResults();
                        }
                    })
                    .catch(error => {
                        console.error("æ£€æŸ¥æäº¤çŠ¶æ€é”™è¯¯:", error);
                    });
            }
        }

// åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨
        document.addEventListener('DOMContentLoaded', () => {
            init();
            setTimeout(checkPageStateOnLoad, 1000); // å»¶è¿Ÿ1ç§’ç­‰å¾…ç”¨æˆ·ä¿¡æ¯åŠ è½½
        });

        // ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // ç™»å½•ç›¸å…³
            document.getElementById('loginButton').addEventListener('click', signInWithGoogle);
            document.getElementById('welcomeLoginButton').addEventListener('click', signInWithGoogle);
            document.getElementById('logoutButton').addEventListener('click', signOut);
            
            // å¯¼èˆªç›¸å…³
            document.getElementById('adminLink').addEventListener('click', showAdminView);
            document.getElementById('viewAllWarningsBtn')?.addEventListener('click', viewAllWarnings);
            document.getElementById('quizLink').addEventListener('click', function(e) {
    e.preventDefault();
    
    // å…ˆæ£€æŸ¥æ¯”èµ›æ—¶é—´
    const timeCheck = checkCompetitionTime();
    if (!timeCheck.allowed) {
        Swal.fire({
            title: 'æ— æ³•è¿›å…¥ç­”é¢˜',
            html: timeCheck.reason,
            icon: 'warning',
            confirmButtonText: 'ç¡®å®š'
        });
        return;
    }
    
    showQuizView();
});
            document.getElementById('checkResultBtn').addEventListener('click', showResultCheckView);
            
            // ç­”é¢˜ç›¸å…³
            document.getElementById('prevQuestionBtn').addEventListener('click', showPreviousQuestion);
            document.getElementById('nextQuestionBtn').addEventListener('click', showNextQuestion);
            document.getElementById('markQuestionBtn').addEventListener('click', toggleMarkQuestion);
            document.getElementById('reviewQuestionsBtn').addEventListener('click', showQuestionReview);
            document.getElementById('submitQuizBtn').addEventListener('click', confirmSubmitQuiz);
            document.getElementById('confirmSubmitBtn').addEventListener('click', submitQuiz);
            
            // ç»“æœç›¸å…³
            document.getElementById('viewRankingBtn').addEventListener('click', showRankingView);
            document.getElementById('backToResultBtn').addEventListener('click', showResultView);
            document.getElementById('downloadCertificateBtn').addEventListener('click', showCertificate);
            document.getElementById('printCertificateBtn').addEventListener('click', printCertificate);
            
            // ç”¨æˆ·ä¿¡æ¯
            document.getElementById('saveUserInfoBtn').addEventListener('click', saveUserInfo);
            
            // é¢˜ç›®ç®¡ç†
            document.getElementById('addQuestionBtn').addEventListener('click', addNewQuestion);
            document.getElementById('questionForm').addEventListener('submit', saveQuestion);
            document.getElementById('questionType').addEventListener('change', updateQuestionTypeUI);
            document.getElementById('addOptionBtn').addEventListener('click', addOption);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEditQuestion);
            document.getElementById('importQuestionsBtn').addEventListener('click', importQuestions);
            
            // æ¯”èµ›è®¾ç½®
            document.getElementById('quizSettingsForm').addEventListener('submit', saveQuizSettings);
            document.getElementById('startQuizBtn').addEventListener('click', startQuiz);
            document.getElementById('pauseQuizBtn').addEventListener('click', pauseQuiz);
            document.getElementById('endQuizBtn').addEventListener('click', endQuiz);
            document.getElementById('resetQuizBtn').addEventListener('click', resetQuiz);
            
            // æˆç»©å¯¼å‡º
            document.getElementById('exportResultsBtn').addEventListener('click', showExportConfirm);
            document.getElementById('exportAllResultsBtn').addEventListener('click', exportAllResults);
            document.getElementById('confirmExportBtn').addEventListener('click', exportResults);
            
            document.addEventListener('click', function(e) {
            if (e.target.closest('.view-warnings-btn')) {
                const userId = e.target.closest('.view-warnings-btn').getAttribute('data-user-id');
                viewParticipantWarnings(userId);
            }
        });
            // æ–°å¢ï¼šç›‘å¬ç»“æœæ˜¾ç¤ºé€‰é¡¹å˜åŒ–
            document.getElementById('showResultsImmediately').addEventListener('change', function() {
                const resultsDelaySection = document.getElementById('resultsDelaySection');
                if (resultsDelaySection) {
                    resultsDelaySection.style.display = this.checked ? 'none' : 'block';
                }
            });
            
            // æ–°å¢ï¼šç›‘å¬é‡è¯•æ¨¡å¼å˜åŒ–
            document.getElementById('retakeMode').addEventListener('change', function() {
                const retakeLimitSection = document.getElementById('retakeLimitSection');
                if (retakeLimitSection) {
                    retakeLimitSection.style.display = this.value === 'allow_limited' ? 'block' : 'none';
                }
            });
            
            // ç»“æœæŸ¥è¯¢
            document.getElementById('resultCheckForm').addEventListener('submit', checkResult);
            
            // ç›‘æ§ç›¸å…³
            document.getElementById('refreshMonitorBtn').addEventListener('click', refreshMonitor);
            
            // æ™ºèƒ½ç»„å·
            document.getElementById('paperForm').addEventListener('submit', generatePaper);
            document.getElementById('regeneratePaperBtn').addEventListener('click', regeneratePaper);
            document.getElementById('savePaperBtn').addEventListener('click', saveGeneratedPaper);
            
            // é˜²ä½œå¼Šç³»ç»Ÿ
            document.getElementById('returnToFullscreen').addEventListener('click', requestFullscreen);
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', handleKeyboardShortcuts);
            bindAwardEventListeners();
        }

        // é”®ç›˜å¿«æ·é”®å¤„ç†
        function handleKeyboardShortcuts(e) {
            // åªæœ‰åœ¨ç­”é¢˜ç•Œé¢æ‰å¯ç”¨å¿«æ·é”®
            if (!document.getElementById('quizView').classList.contains('d-none')) {
                switch(e.key) {
                    case 'ArrowLeft':
                        if (!e.ctrlKey) {
                            e.preventDefault();
                            showPreviousQuestion();
                        }
                        break;
                    case 'ArrowRight':
                        if (!e.ctrlKey) {
                            e.preventDefault();
                            showNextQuestion();
                        }
                        break;
                    case 'm':
                    case 'M':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            toggleMarkQuestion();
                        }
                        break;
                    case 'Enter':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            confirmSubmitQuiz();
                        }
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                        if (e.altKey) {
                            e.preventDefault();
                            const index = parseInt(e.key) - 1;
                            selectOption(currentQuestionIndex, index);
                        }
                        break;
                }
            }
        }

        // æ™ºèƒ½ç»„å·åŠŸèƒ½
        function generatePaper(e) {
            e.preventDefault();
            
            Swal.fire({
                title: 'æ­£åœ¨ç”Ÿæˆè¯•å·',
                html: 'è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨çš„è®¾ç½®æ™ºèƒ½ç»„å·...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            setTimeout(() => {
                Swal.close();
                const generatedPaper = simulatePaperGeneration();
                displayGeneratedPaper(generatedPaper);
                Swal.fire('æˆåŠŸ', 'è¯•å·ç”Ÿæˆå®Œæˆï¼', 'success');
            }, 2000);
        }

        function simulatePaperGeneration() {
            const paper = [];
            const questionDist = {
                single: parseInt(document.querySelector('.question-dist[data-type="single"]').value),
                multiple: parseInt(document.querySelector('.question-dist[data-type="multiple"]').value),
                short_answer: parseInt(document.querySelector('.question-dist[data-type="short_answer"]').value),
                essay: parseInt(document.querySelector('.question-dist[data-type="essay"]').value)
            };
            
            let questionNumber = 1;
            
            // ç”Ÿæˆå•é€‰é¢˜
            for (let i = 0; i < questionDist.single; i++) {
                paper.push({
                    id: 'generated-' + Date.now() + '-' + i,
                    number: questionNumber++,
                    text: `æ™ºèƒ½ç”Ÿæˆçš„å•é€‰é¢˜ç¤ºä¾‹ ${i + 1}`,
                    type: 'single',
                    points: 2,
                    difficulty: 'medium',
                    options: [
                        { text: 'é€‰é¡¹A' },
                        { text: 'é€‰é¡¹B' },
                        { text: 'é€‰é¡¹C' },
                        { text: 'é€‰é¡¹D' }
                    ],
                    correctAnswers: [Math.floor(Math.random() * 4)]
                });
            }
            
            // ç”Ÿæˆå¤šé€‰é¢˜
            for (let i = 0; i < questionDist.multiple; i++) {
                paper.push({
                    id: 'generated-' + Date.now() + '-' + (i + questionDist.single),
                    number: questionNumber++,
                    text: `æ™ºèƒ½ç”Ÿæˆçš„å¤šé€‰é¢˜ç¤ºä¾‹ ${i + 1}`,
                    type: 'multiple',
                    points: 3,
                    difficulty: 'medium',
                    options: [
                        { text: 'é€‰é¡¹A' },
                        { text: 'é€‰é¡¹B' },
                        { text: 'é€‰é¡¹C' },
                        { text: 'é€‰é¡¹D' }
                    ],
                    correctAnswers: [0, 1]
                });
            }
            
            // ç”Ÿæˆé—®ç­”é¢˜
            for (let i = 0; i < questionDist.short_answer; i++) {
                paper.push({
                    id: 'generated-' + Date.now() + '-' + (i + questionDist.single + questionDist.multiple),
                    number: questionNumber++,
                    text: `æ™ºèƒ½ç”Ÿæˆçš„é—®ç­”é¢˜ç¤ºä¾‹ ${i + 1}`,
                    type: 'short_answer',
                    points: 5,
                    difficulty: 'medium',
                    correctAnswerText: 'è¿™æ˜¯é—®ç­”é¢˜çš„å‚è€ƒç­”æ¡ˆ'
                });
            }
            
            // ç”Ÿæˆç”³è®ºé¢˜
            for (let i = 0; i < questionDist.essay; i++) {
                paper.push({
                    id: 'generated-' + Date.now() + '-' + (i + questionDist.single + questionDist.multiple + questionDist.short_answer),
                    number: questionNumber++,
                    text: `æ™ºèƒ½ç”Ÿæˆçš„ç”³è®ºé¢˜ç¤ºä¾‹ ${i + 1}`,
                    type: 'essay',
                    points: 10,
                    difficulty: 'hard',
                    correctAnswerText: 'è¿™æ˜¯ç”³è®ºé¢˜çš„å‚è€ƒç­”æ¡ˆï¼Œéœ€è¦è¯¦ç»†é˜è¿°è§‚ç‚¹ã€‚'
                });
            }
            
            return paper;
        }

        function displayGeneratedPaper(paper) {
            const container = document.getElementById('generatedPaperContainer');
            const tableBody = document.querySelector('#generatedPaperTable tbody');
            
            tableBody.innerHTML = '';
            paper.forEach(question => {
                const row = document.createElement('tr');
                
                let typeText = '';
                switch (question.type) {
                    case 'single': typeText = 'å•é€‰é¢˜'; break;
                    case 'multiple': typeText = 'å¤šé€‰é¢˜'; break;
                    case 'short_answer': typeText = 'é—®ç­”é¢˜'; break;
                    case 'essay': typeText = 'ç”³è®ºé¢˜'; break;
                }
                
                let difficultyText = '';
                switch (question.difficulty) {
                    case 'easy': difficultyText = 'ç®€å•'; break;
                    case 'medium': difficultyText = 'ä¸­ç­‰'; break;
                    case 'hard': difficultyText = 'å›°éš¾'; break;
                }
                
                row.innerHTML = `
                    <td>${question.number}</td>
                    <td>${question.text}</td>
                    <td>${typeText}</td>
                    <td>${question.points}</td>
                    <td>${difficultyText}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-generated-question" data-id="${question.id}">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger remove-question" data-id="${question.id}">ç§»é™¤</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            container.style.display = 'block';
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.edit-generated-question').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-id');
                    editGeneratedQuestion(questionId, paper);
                });
            });
            
            document.querySelectorAll('.remove-question').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-id');
                    removeGeneratedQuestion(questionId, paper);
                });
            });
        }

        function regeneratePaper() {
            document.getElementById('paperForm').dispatchEvent(new Event('submit'));
        }

        function saveGeneratedPaper() {
            const paperName = document.getElementById('paperName').value;
            if (!paperName) {
                Swal.fire('é”™è¯¯', 'è¯·è¾“å…¥è¯•å·åç§°', 'error');
                return;
            }
            
            Swal.fire({
                title: 'ä¿å­˜è¯•å·',
                input: 'text',
                inputLabel: 'è¯•å·æè¿°',
                inputPlaceholder: 'è¯·è¾“å…¥è¯•å·æè¿°...',
                showCancelButton: true,
                confirmButtonText: 'ä¿å­˜',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire('æˆåŠŸ', `è¯•å·"${paperName}"å·²ä¿å­˜æˆåŠŸï¼`, 'success');
                }
            });
        }

        function editGeneratedQuestion(questionId, paper) {
            const question = paper.find(q => q.id === questionId);
            if (question) {
                const questionsTab = document.getElementById('questions-tab');
                if (questionsTab) {
                    questionsTab.click();
                    setTimeout(() => {
                        Swal.fire('æç¤º', 'è¯·åœ¨é¢˜ç›®ç®¡ç†é¡µé¢ç¼–è¾‘æ­¤é¢˜', 'info');
                    }, 500);
                }
            }
        }

        function removeGeneratedQuestion(questionId, paper) {
            const updatedPaper = paper.filter(q => q.id !== questionId);
            const paperName = document.getElementById('paperName').value;
            displayGeneratedPaper(updatedPaper, paperName);
            Swal.fire('æˆåŠŸ', 'é¢˜ç›®å·²ä»è¯•å·ä¸­ç§»é™¤', 'success');
        }

        // é˜²ä½œå¼Šç³»ç»Ÿ
        // ä¿®æ”¹ initAntiCheatSystem å‡½æ•°
// ä¿®æ”¹ initAntiCheatSystem å‡½æ•°
function initAntiCheatSystem() {
    console.log("åˆå§‹åŒ–é˜²ä½œå¼Šç³»ç»Ÿ...");
    
    if (!quizData.settings.enableAntiCheat) {
        console.log("é˜²ä½œå¼Šç³»ç»Ÿè¢«ç¦ç”¨");
        return;
    }
    
    cheatDetectionEnabled = true;
    
    // é‡ç½®æœ¬åœ°è®¡æ•°å™¨
    tabSwitchCount = 0;
    mouseLeaveCount = 0;
    
    // ============ ä¿®å¤ï¼šä»FirebaseåŠ è½½è­¦å‘Šæ¬¡æ•° ============
    if (currentUser) {
        // ä»FirebaseåŠ è½½è­¦å‘Šæ¬¡æ•°
        database.ref('cheatWarnings/' + currentUser.uid + '/current').once('value').then(snapshot => {
            if (snapshot.exists()) {
                warningCount = snapshot.val();
                console.log("ä»FirebaseåŠ è½½è­¦å‘Šæ¬¡æ•°:", warningCount);
            } else {
                warningCount = 0;
                // åˆå§‹åŒ–Firebaseä¸­çš„è­¦å‘Šæ¬¡æ•°
                database.ref('cheatWarnings/' + currentUser.uid + '/current').set(0);
            }
            
            // æ›´æ–°UIæ˜¾ç¤º
            document.getElementById('warningCount').textContent = warningCount;
            
            // ç»§ç»­åˆå§‹åŒ–é˜²ä½œå¼Šç³»ç»Ÿ
            continueAntiCheatInit();
        }).catch(error => {
            console.error("åŠ è½½è­¦å‘Šæ¬¡æ•°é”™è¯¯:", error);
            warningCount = 0;
            document.getElementById('warningCount').textContent = '0';
            continueAntiCheatInit();
        });
    } else {
        warningCount = 0;
        document.getElementById('warningCount').textContent = '0';
        continueAntiCheatInit();
    }
    
    function continueAntiCheatInit() {
        // é‡æ–°æ˜¾ç¤ºé˜²ä½œå¼Šé¢æ¿
        const cheatPanel = document.getElementById('cheatDetectionPanel');
        if (cheatPanel) {
            cheatPanel.classList.remove('d-none');
        }
        
        // é‡ç½®çŠ¶æ€æ˜¾ç¤º
        updateStatus('tabStatus', 'safe', 'æ­£å¸¸');
        updateStatus('fullscreenStatus', 'safe', 'æ­£å¸¸');
        updateStatus('keyboardStatus', 'safe', 'æ­£å¸¸');
        updateStatus('mouseStatus', 'safe', 'æ­£å¸¸');
        
        // ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        bindAntiCheatEvents();
        
        console.log("é˜²ä½œå¼Šç³»ç»Ÿå·²åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰è­¦å‘Šæ¬¡æ•°:", warningCount);
    }
}

        // æ–°å¢ï¼šæ¸…ç†é˜²ä½œå¼Šç³»ç»Ÿå‡½æ•°
function cleanupAntiCheatSystem() {
    console.log("æ¸…ç†é˜²ä½œå¼Šç³»ç»Ÿ...");
    
    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    document.removeEventListener('fullscreenchange', handleFullscreenChange);
    document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.removeEventListener('mozfullscreenchange', handleFullscreenChange);
    document.removeEventListener('MSFullscreenChange', handleFullscreenChange);
    
    document.removeEventListener('visibilitychange', handleVisibilityChange);
    document.removeEventListener('mouseleave', handleMouseLeave);
    document.removeEventListener('mouseenter', handleMouseEnter);
    document.removeEventListener('contextmenu', disableContextMenu);
    
    // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
    document.removeEventListener('keydown', handleKeyDown);
    
    // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
    if (fullscreenCountdown) {
        clearInterval(fullscreenCountdown);
        fullscreenCountdown = null;
    }
    
    // éšè—é˜²ä½œå¼Šé¢æ¿
    document.getElementById('cheatDetectionPanel').classList.add('d-none');
    document.getElementById('antiCheatAlert').classList.add('d-none');
    document.getElementById('fullscreenOverlay').classList.add('d-none');
    
    cheatDetectionEnabled = false;
}

// ä¿®æ”¹é˜²ä½œå¼Šäº‹ä»¶ç»‘å®šï¼Œç¡®ä¿åªåœ¨æ¯”èµ›è¿›è¡Œä¸­æ‰å¯ç”¨
function bindAntiCheatEvents() {
    console.log("ç»‘å®šé˜²ä½œå¼Šäº‹ä»¶ç›‘å¬å™¨...");
    
    // åªåœ¨æ¯”èµ›è¿›è¡Œä¸­æ‰ç»‘å®šäº‹ä»¶
    if (quizData.settings.status !== 'in_progress') {
        console.log("æ¯”èµ›æœªè¿›è¡Œä¸­ï¼Œè·³è¿‡é˜²ä½œå¼Šäº‹ä»¶ç»‘å®š");
        return;
    }
    
    // å¯ç”¨å…¨å±æ£€æµ‹
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);
    
    // å¯ç”¨æ ‡ç­¾é¡µåˆ‡æ¢æ£€æµ‹
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // å¯ç”¨é¼ æ ‡ç¦»å¼€æ£€æµ‹
    document.addEventListener('mouseleave', handleMouseLeave);
    document.addEventListener('mouseenter', handleMouseEnter);
    
    // ç¦ç”¨å³é”®èœå•
    document.addEventListener('contextmenu', disableContextMenu);
    
    // ç¦ç”¨æ–‡æœ¬é€‰æ‹©
    document.body.classList.add('no-select', 'no-context-menu');
    
    console.log("é˜²ä½œå¼Šäº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆ");
}

        function checkCompetitionStatusForAntiCheat() {
    // æ£€æŸ¥æ¯”èµ›æ˜¯å¦æ­£åœ¨è¿›è¡Œ
    if (quizData.settings.status !== 'in_progress') {
        console.log("æ¯”èµ›æœªè¿›è¡Œä¸­ï¼Œç¦ç”¨é˜²ä½œå¼Šç³»ç»Ÿ");
        cleanupAntiCheatSystem();
        return false;
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨æ¯”èµ›æ—¶é—´å†…
    const currentTime = new Date().getTime();
    const startTime = quizData.settings.startTime;
    const endTime = quizData.settings.endTime;
    
    if (startTime && currentTime < startTime) {
        console.log("æ¯”èµ›å°šæœªå¼€å§‹ï¼Œç¦ç”¨é˜²ä½œå¼Šç³»ç»Ÿ");
        cleanupAntiCheatSystem();
        return false;
    }
    
    if (endTime && currentTime > endTime) {
        console.log("æ¯”èµ›å·²ç»“æŸï¼Œç¦ç”¨é˜²ä½œå¼Šç³»ç»Ÿ");
        cleanupAntiCheatSystem();
        return false;
    }
    
    return true;
}

        function handleFullscreenChange() {
    // å…ˆæ£€æŸ¥æ¯”èµ›çŠ¶æ€
    if (!checkCompetitionStatusForAntiCheat()) {
        return;
    }
    
    const isFullscreen = document.fullscreenElement || 
                       document.webkitFullscreenElement || 
                       document.mozFullScreenElement || 
                       document.msFullscreenElement;
    
    if (isFullscreen) {
        updateStatus('fullscreenStatus', 'safe', 'æ­£å¸¸');
        document.getElementById('fullscreenOverlay').classList.add('d-none');
        
        if (fullscreenCountdown) {
            clearInterval(fullscreenCountdown);
            fullscreenCountdown = null;
        }
    } else {
        updateStatus('fullscreenStatus', 'danger', 'å¼‚å¸¸');
        showAlert('æ£€æµ‹åˆ°é€€å‡ºå…¨å±æ¨¡å¼ï¼è¯·åœ¨10ç§’å†…è¿”å›å…¨å±ã€‚', 'danger');
        
        document.getElementById('fullscreenOverlay').classList.remove('d-none');
        
        fullscreenTimer = 10;
        document.getElementById('countdown').textContent = fullscreenTimer;
        
        fullscreenCountdown = setInterval(() => {
            fullscreenTimer--;
            document.getElementById('countdown').textContent = fullscreenTimer;
            
            if (fullscreenTimer <= 0) {
                clearInterval(fullscreenCountdown);
                submitQuizForCheating("å¤šæ¬¡é€€å‡ºå…¨å±æ¨¡å¼");
            }
        }, 1000);
        
        recordWarning("é€€å‡ºå…¨å±æ¨¡å¼");
    }
}

        function handleVisibilityChange() {
            if (document.hidden) {
                tabSwitchCount++;
                updateStatus('tabStatus', 'danger', 'å¼‚å¸¸');
                showAlert('æ£€æµ‹åˆ°åˆ‡æ¢æ ‡ç­¾é¡µï¼è¯·ç«‹å³è¿”å›è€ƒè¯•ç•Œé¢ã€‚', 'danger');
                recordWarning("åˆ‡æ¢æ ‡ç­¾é¡µ");
            } else {
                updateStatus('tabStatus', 'safe', 'æ­£å¸¸');
            }
        }

        function handleKeyDown(e) {
            // ç¦ç”¨å¼€å‘è€…å·¥å…·å¿«æ·é”®
            if (e.keyCode === 123 || // F12
                (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
                (e.ctrlKey && e.keyCode === 85) || // Ctrl+U
                (e.ctrlKey && e.keyCode === 83) || // Ctrl+S
                (e.metaKey && e.altKey && e.keyCode === 73) // Cmd+Opt+I
            ) {
                e.preventDefault();
                updateStatus('keyboardStatus', 'danger', 'å¼‚å¸¸');
                showAlert('æ£€æµ‹åˆ°ç¦ç”¨å¿«æ·é”®æ“ä½œï¼', 'danger');
                recordWarning("ä½¿ç”¨ç¦ç”¨å¿«æ·é”®");
                return false;
            }
            
            // ç¦ç”¨å¤åˆ¶ç²˜è´´å¿«æ·é”®
            if ((e.ctrlKey || e.metaKey) && 
                (e.keyCode === 67 || e.keyCode === 86 || e.keyCode === 88)) {
                e.preventDefault();
                updateStatus('keyboardStatus', 'warning', 'è­¦å‘Š');
                showAlert('è€ƒè¯•æœŸé—´ç¦æ­¢å¤åˆ¶ç²˜è´´æ“ä½œï¼', 'warning');
                return false;
            }
        }

        function handleMouseLeave(e) {
            if (e.clientY <= 0 || e.clientX <= 0 || 
                e.clientX >= window.innerWidth || e.clientY >= window.innerHeight) {
                mouseLeaveCount++;
                
                if (mouseLeaveCount > 2) {
                    updateStatus('mouseStatus', 'warning', 'å¯ç–‘');
                    showAlert('æ£€æµ‹åˆ°é¼ æ ‡é¢‘ç¹ç¦»å¼€è€ƒè¯•çª—å£ï¼', 'warning');
                    recordWarning("é¼ æ ‡ç¦»å¼€è€ƒè¯•çª—å£");
                }
            }
        }

        function handleMouseEnter() {
            updateStatus('mouseStatus', 'safe', 'æ­£å¸¸');
        }

        function disableContextMenu(e) {
            e.preventDefault();
            updateStatus('mouseStatus', 'warning', 'è­¦å‘Š');
            showAlert('è€ƒè¯•æœŸé—´ç¦ç”¨å³é”®èœå•ï¼', 'warning');
            recordWarning("ä½¿ç”¨å³é”®èœå•");
            return false;
        }

        function updateStatus(elementId, statusClass, statusText) {
            const element = document.getElementById(elementId);
            element.className = 'cheat-status ' + statusClass;
            document.getElementById(elementId + 'Text').textContent = statusText;
        }

        function showAlert(message, type) {
            const alert = document.getElementById('antiCheatAlert');
            const messageElement = document.getElementById('alertMessage');
            
            alert.className = 'anti-cheat-alert';
            
            if (type === 'danger') {
                alert.classList.add('anti-cheat-alert');
            } else if (type === 'warning') {
                alert.classList.add('anti-cheat-warning');
            } else {
                alert.classList.add('anti-cheat-info');
            }
            
            messageElement.textContent = message;
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 5000);
        }

        // ä¿®æ”¹ recordWarning å‡½æ•°
// ä¿®æ”¹ recordWarning å‡½æ•°
function recordWarning(reason) {
    warningCount++;
    document.getElementById('warningCount').textContent = warningCount;
    
    if (currentUser) {
        const warningData = {
            userId: currentUser.uid,
            timestamp: new Date().getTime(),
            reason: reason,
            warningCount: warningCount,
            tabSwitchCount: tabSwitchCount,
            mouseLeaveCount: mouseLeaveCount
        };
        
        // ä¿å­˜åˆ°Firebase - æ›´æ–°å½“å‰è­¦å‘Šæ¬¡æ•°å’Œå†å²è®°å½•
        database.ref('cheatWarnings/' + currentUser.uid + '/current').set(warningCount);
        database.ref('cheatWarnings/' + currentUser.uid + '/history').push(warningData);
        
        console.log("è®°å½•è­¦å‘Š:", reason, "å½“å‰è­¦å‘Šæ¬¡æ•°:", warningCount);
    }
    
    if (warningCount >= maxWarnings) {
        submitQuizForCheating("è¾¾åˆ°æœ€å¤§è­¦å‘Šæ¬¡æ•°");
    }
}

        function submitQuizForCheating(reason) {
            if (quizTimer) clearInterval(quizTimer);
            
            if (currentUser) {
                const cheatData = {
                    userId: currentUser.uid,
                    timestamp: new Date().getTime(),
                    reason: reason,
                    warningCount: warningCount,
                    tabSwitchCount: tabSwitchCount,
                    mouseLeaveCount: mouseLeaveCount
                };
                
                database.ref('cheatViolations/' + currentUser.uid).set(cheatData);
            }
            
            Swal.fire({
                title: 'è€ƒè¯•è¿è§„',
                html: `æ£€æµ‹åˆ°å¤šæ¬¡è¿è§„è¡Œä¸º:<br><strong>${reason}</strong><br>ç³»ç»Ÿå·²è‡ªåŠ¨æäº¤æ‚¨çš„ç­”å·ã€‚`,
                icon: 'error',
                confirmButtonText: 'ç¡®å®š',
                allowOutsideClick: false
            }).then(() => {
                submitQuiz();
            });
        }

        function requestFullscreen() {
            const elem = document.documentElement;
            
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        // Googleç™»å½•
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('profile');
            provider.addScope('email');
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log("ç™»å½•æˆåŠŸ", result.user);
                })
                .catch((error) => {
                    console.error("ç™»å½•é”™è¯¯:", error);
                    let errorMessage = "ç™»å½•å¤±è´¥";
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = "æ‚¨å…³é—­äº†ç™»å½•çª—å£ï¼Œè¯·é‡æ–°å°è¯•";
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œ";
                    } else {
                        errorMessage = `ç™»å½•å¤±è´¥: ${error.message}`;
                    }
                    Swal.fire('é”™è¯¯', errorMessage, 'error');
                });
        }
        
        // é€€å‡ºç™»å½•
        function signOut() {
            auth.signOut().then(() => {
                Swal.fire('å·²é€€å‡º', 'æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½•', 'success');
            }).catch(error => {
                console.error("é€€å‡ºé”™è¯¯:", error);
                Swal.fire('é”™è¯¯', 'é€€å‡ºå¤±è´¥: ' + error.message, 'error');
            });
        }
        
        // æ›´æ–°ç”¨æˆ·UI
        function updateUserUI() {
            if (currentUser) {
                document.getElementById('loginNavItem').classList.add('d-none');
                document.getElementById('userNavItem').classList.remove('d-none');
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                const userPhoto = document.getElementById('userPhoto');
                userPhoto.src = currentUser.photoURL || 'https://via.placeholder.com/30';
                userPhoto.alt = currentUser.displayName || 'ç”¨æˆ·å¤´åƒ';
            } else {
                document.getElementById('loginNavItem').classList.remove('d-none');
                document.getElementById('userNavItem').classList.add('d-none');
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
        function checkUserInfo() {
            database.ref('users/' + currentUser.uid).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    userInfo = snapshot.val();
                    if (currentUser.email === 'tanjunyuanfoonyew@gmail.com') {
                        userInfo.isAdmin = true;
                        database.ref('users/' + currentUser.uid).update({ isAdmin: true });
                    }
                    
                    if (userInfo.isAdmin) {
                        showAdminView();
                    } else {
                        checkQuizStatus();
                    }
                } else {
                    const isAdmin = currentUser.email === 'tanjunyuanfoonyew@gmail.com';
                    userInfo = {
                        name: currentUser.displayName || currentUser.email,
                        email: currentUser.email,
                        photoURL: currentUser.photoURL || '',
                        isAdmin: isAdmin,
                        uid: currentUser.uid
                    };
                    
                    database.ref('users/' + currentUser.uid).set(userInfo).then(() => {
                        if (isAdmin) {
                            showAdminView();
                        } else {
                            showUserInfoForm();
                        }
                    });
                }
            }).catch(error => {
                console.error("è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯:", error);
                Swal.fire('é”™è¯¯', 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            });
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯è¡¨å•
        function showUserInfoForm() {
            const userInfoModal = new bootstrap.Modal(document.getElementById('userInfoModal'));
            userInfoModal.show();
        }
        
        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        function saveUserInfo() {
            const userClass = document.getElementById('userClass').value;
            const userGroup = document.getElementById('userGroup').value;
            const studentId = document.getElementById('userStudentId').value;
            
            if (!userClass || !userGroup || !studentId) {
                Swal.fire('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }
            
            userInfo = {
                ...userInfo,
                class: userClass,
                group: userGroup,
                studentId: studentId
            };
            
            database.ref('users/' + currentUser.uid).update({
                class: userClass,
                group: userGroup,
                studentId: studentId
            }).then(() => {
                bootstrap.Modal.getInstance(document.getElementById('userInfoModal')).hide();
                Swal.fire('æˆåŠŸ', 'ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜', 'success');
                checkQuizStatus();
            }).catch(error => {
                console.error("ä¿å­˜ç”¨æˆ·ä¿¡æ¯é”™è¯¯:", error);
                Swal.fire('é”™è¯¯', 'ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            });
        }

        // æ£€æŸ¥æ¯”èµ›çŠ¶æ€
        function checkQuizStatus() {
    database.ref('quiz/settings/status').once('value').then(snapshot => {
        const status = snapshot.val() || 'not_started';
        
        if (status === 'in_progress') {
            checkUserQuizStatus();
        } else if (status === 'ended') {
            showResultView();
            loadUserResults();
        } else {
            showWelcomeView();
            Swal.fire('æç¤º', 'æ¯”èµ›å°šæœªå¼€å§‹ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å¼€å§‹æ¯”èµ›', 'info');
        }
    }).catch(error => {
        console.error("è·å–æ¯”èµ›çŠ¶æ€é”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'è·å–æ¯”èµ›çŠ¶æ€å¤±è´¥', 'error');
    });
}

        // æ£€æŸ¥ç”¨æˆ·ç­”é¢˜çŠ¶æ€
        async function checkUserQuizStatus() {
    try {
        if (!currentUser || !currentUser.uid) {
            throw new Error('ç”¨æˆ·æœªç™»å½•');
        }

         if (!userAnswers || !Array.isArray(userAnswers)) {
            userAnswers = [];
            console.log("åˆå§‹åŒ– userAnswers");
        }
        
        if (!markedQuestions || !(markedQuestions instanceof Set)) {
            markedQuestions = new Set();
            console.log("åˆå§‹åŒ– markedQuestions");
        }

        const timeCheck = checkCompetitionTime();
        if (!timeCheck.allowed) {
            Swal.fire({
                title: 'æ— æ³•ç­”é¢˜',
                html: timeCheck.reason,
                icon: 'info',
                confirmButtonText: 'ç¡®å®š'
            });
            showWelcomeView();
            return;
        }

        showLoading('æ­£åœ¨è·å–ç­”é¢˜çŠ¶æ€...');

        // åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿æ¸…é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„è®¡æ—¶å™¨
        if (quizTimer) {
            clearInterval(quizTimer);
            quizTimer = null;
        }
        
        // ç¡®ä¿åœæ­¢é˜²ä½œå¼Šç³»ç»Ÿ
        cheatDetectionEnabled = false;
        if (fullscreenCountdown) {
            clearInterval(fullscreenCountdown);
            fullscreenCountdown = null;
        }

        const snapshot = await database.ref('userAnswers/' + currentUser.uid).once('value');
        
        if (!snapshot.exists()) {
            // é¦–æ¬¡ç­”é¢˜
            hideLoading();
            initializeUserQuiz();
            return;
        }

        const answerData = snapshot.val();
        if (answerData.submitted === false) {
            hideLoading();
            loadUserProgress(answerData);
    
    // ============ ä¿®å¤ï¼šåˆ·æ–°åè‡ªåŠ¨é‡æ–°è¿›å…¥å…¨å± ============
            if (quizData.settings.enableAntiCheat) {
                console.log("é‡æ–°åˆå§‹åŒ–é˜²ä½œå¼Šç³»ç»Ÿ...");
                setTimeout(() => {
                    initAntiCheatSystem();
            // å»¶è¿Ÿè¯·æ±‚å…¨å±ï¼Œç¡®ä¿é˜²ä½œå¼Šç³»ç»Ÿå·²å®Œå…¨åˆå§‹åŒ–
                    setTimeout(() => {
                        if (!document.fullscreenElement && 
                            !document.webkitFullscreenElement && 
                            !document.mozFullScreenElement && 
                            !document.msFullscreenElement) {
                            console.log("æ£€æµ‹åˆ°æœªåœ¨å…¨å±æ¨¡å¼ï¼Œè‡ªåŠ¨è¯·æ±‚å…¨å±");
                            requestFullscreen();
                        }
                    }, 1000);
                }, 100);
            }
            showQuizView();
        }
        if (answerData.submitted) {
            // å·²æäº¤ï¼Œæ£€æŸ¥æ˜¯å¦å…è®¸é‡æ–°ç­”é¢˜
            const retakeMode = quizData.settings.retakeMode || 
                              (quizData.settings.allowRetake ? 'allow_unlimited' : 'disallow');
            
            // æ›´æ–°ç®¡ç†å‘˜çŠ¶æ€
            await updateAdminMonitorStatus(currentUser.uid, 'completed');
            
            if (retakeMode === 'disallow') {
                // ä¸å…è®¸é‡æ–°ç­”é¢˜ï¼Œæ£€æŸ¥ç»“æœæ˜¯å¦å¯æ˜¾ç¤º
                await loadUserResults();
                
                const showImmediately = quizData.settings.showResultsImmediately;
                const resultsDelay = quizData.settings.resultsDelay || 0;
                
                if (!showImmediately && resultsDelay > 0) {
                    const submissionTime = answerData.endTime || 0;
                    const currentTime = new Date().getTime();
                    const timePassed = (currentTime - submissionTime) / (1000 * 60);
                    
                    if (timePassed < resultsDelay) {
                        const remainingTime = Math.ceil(resultsDelay - timePassed);
                        hideLoading();
                        Swal.fire({
                            title: 'ç»“æœæš‚æœªå…¬å¸ƒ',
                            html: `æ¯”èµ›ç»“æœå°†åœ¨ <strong>${remainingTime}åˆ†é’Ÿ</strong> åå…¬å¸ƒ<br>è¯·ç¨åå†æŸ¥çœ‹`,
                            icon: 'info',
                            confirmButtonText: 'ç¡®å®š'
                        });
                        showWelcomeView();
                        return;
                    }
                }
                
                hideLoading();
                showResultView();
            } else {
                // å…è®¸é‡æ–°ç­”é¢˜
                const retryCount = answerData.retryCount || 0;
                let canRetake = true;
                let message = 'æ‚¨å·²ç»å®Œæˆäº†ä¸€æ¬¡ç­”é¢˜ã€‚æ˜¯å¦è¦é‡æ–°ç­”é¢˜ï¼Ÿ';
                
                if (retakeMode === 'allow_limited') {
                    const maxRetries = quizData.settings.retakeLimit || 3;
                    if (retryCount >= maxRetries) {
                        canRetake = false;
                    } else {
                        message = `æ‚¨å·²ç»å®Œæˆäº†ä¸€æ¬¡ç­”é¢˜ã€‚<br>å‰©ä½™é‡è¯•æ¬¡æ•°: ${maxRetries - retryCount}<br>æ˜¯å¦è¦é‡æ–°ç­”é¢˜ï¼Ÿ`;
                    }
                }
                
                if (!canRetake) {
                    // è¶…è¿‡é‡è¯•æ¬¡æ•°é™åˆ¶
                    await loadUserResults();
                    hideLoading();
                    showResultView();
                } else {
                    hideLoading();
                    const result = await Swal.fire({
                        title: 'é‡æ–°ç­”é¢˜',
                        html: message,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'é‡æ–°ç­”é¢˜',
                        cancelButtonText: 'æŸ¥çœ‹ä¸Šæ¬¡ç»“æœ'
                    });
                    
                    if (result.isConfirmed) {
                         console.log("ç”¨æˆ·é€‰æ‹©é‡æ–°ç­”é¢˜ï¼Œé‡æ–°åˆå§‹åŒ–");
                        // å…ˆé‡ç½®æ‰€æœ‰çŠ¶æ€
                        userAnswers = [];
                        markedQuestions = new Set();
                        currentQuestionIndex = 0;
                        
                        // ç„¶ååˆå§‹åŒ–
                        initializeUserQuiz();
                    } else {
                        // æŸ¥çœ‹ä¸Šæ¬¡ç»“æœ
                        await loadUserResults();
                        showResultView();
                    }
                }
            }
        } else {
            // æœªæäº¤ï¼Œç»§ç»­ä¸Šæ¬¡ç­”é¢˜
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æ¯”èµ›æ—¶é—´
            if (quizData.settings.endTime && new Date().getTime() > quizData.settings.endTime) {
                // æ¯”èµ›æ—¶é—´å·²ç»“æŸï¼Œè‡ªåŠ¨æäº¤
                hideLoading();
                Swal.fire({
                    title: 'æ¯”èµ›æ—¶é—´å·²ç»“æŸ',
                    text: 'æ¯”èµ›æ—¶é—´å·²åˆ°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æäº¤æ‚¨çš„ç­”å·',
                    icon: 'info',
                    confirmButtonText: 'ç¡®å®š'
                }).then(async () => {
                    // åŠ è½½å½“å‰è¿›åº¦ç„¶åæäº¤
                    loadUserProgress(answerData);
                    await submitQuiz();
                });
                return;
            }
            
            // ============ ä¿®å¤æ—¶é—´è®¡ç®—é€»è¾‘ ============
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡ä¸ªäººç­”é¢˜æ—¶é—´
            const quizDuration = quizData.settings.duration * 60 * 1000; // è½¬ä¸ºæ¯«ç§’
            
            // è·å–å‡†ç¡®çš„å¼€å§‹æ—¶é—´
            const startTime = answerData.startTime;
            
            if (!startTime) {
                // å¦‚æœæ²¡æœ‰å¼€å§‹æ—¶é—´ï¼Œè¯´æ˜æ•°æ®å¼‚å¸¸ï¼Œé‡æ–°å¼€å§‹
                console.warn("ç­”é¢˜æ•°æ®å¼‚å¸¸ï¼šç¼ºå°‘å¼€å§‹æ—¶é—´ï¼Œé‡æ–°å¼€å§‹ç­”é¢˜");
                hideLoading();
                initializeUserQuiz();
                return;
            }
            
            // è®¡ç®—å·²ç”¨æ—¶é—´
            const currentTime = new Date().getTime();
            let timeElapsed = currentTime - startTime;
            
            // éªŒè¯æ—¶é—´åˆç†æ€§
            if (timeElapsed < 0) {
                // æ—¶é—´å¼‚å¸¸ï¼ˆå¼€å§‹æ—¶é—´æ™šäºå½“å‰æ—¶é—´ï¼‰
                console.warn("æ—¶é—´è®¡ç®—å¼‚å¸¸ï¼šå¼€å§‹æ—¶é—´æ™šäºå½“å‰æ—¶é—´");
                // ä½¿ç”¨åˆç†å€¼ï¼ˆå‡è®¾åˆšåˆšå¼€å§‹ï¼‰
                timeElapsed = 0;
            }
            
            // æ·»åŠ é¢å¤–çš„åˆç†æ€§æ£€æŸ¥
            const maxReasonableTime = quizDuration * 2; // æœ€å¤šå…è®¸2å€æ¯”èµ›æ—¶é—´
            
            if (timeElapsed > maxReasonableTime) {
                // æ—¶é—´å¼‚å¸¸ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨æ—¶é—´è¢«ä¿®æ”¹
                console.warn("æ£€æµ‹åˆ°å¼‚å¸¸æ—¶é—´æ•°æ®ï¼š", {
                    startTime: new Date(startTime).toLocaleString(),
                    currentTime: new Date(currentTime).toLocaleString(),
                    timeElapsedSeconds: Math.floor(timeElapsed / 1000),
                    maxAllowedSeconds: quizDuration / 1000
                });
                
                // ä½¿ç”¨ä¿å®ˆçš„æ—¶é—´ä¼°è®¡
                // æ ¹æ®ç­”é¢˜è¿›åº¦ä¼°ç®—æ—¶é—´
                const answeredQuestions = answerData.answers?.filter(a => 
                    (a.selectedOptions && a.selectedOptions.length > 0) || 
                    (a.answerText && a.answerText.trim() !== '')
                ).length || 0;
                
                // å‡è®¾æ¯é“é¢˜å¹³å‡éœ€è¦15-30ç§’
                const estimatedTimePerQuestion = 20000; // 20ç§’
                timeElapsed = Math.min(answeredQuestions * estimatedTimePerQuestion, quizDuration);
                
                console.log("ä½¿ç”¨ä¼°ç®—æ—¶é—´ï¼š", {
                    answeredQuestions,
                    estimatedTime: timeElapsed / 1000
                });
            }
            // ============ ä¿®å¤ç»“æŸ ============
            
            if (timeElapsed > quizDuration) {
                // ä¸ªäººæ—¶é—´å·²ç”¨å®Œï¼Œè‡ªåŠ¨æäº¤
                hideLoading();
                Swal.fire({
                    title: 'ç­”é¢˜æ—¶é—´å·²ç”¨å®Œ',
                    text: 'æ‚¨çš„ç­”é¢˜æ—¶é—´å·²ç»“æŸï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æäº¤æ‚¨çš„ç­”å·',
                    icon: 'info',
                    confirmButtonText: 'ç¡®å®š'
                }).then(async () => {
                    // åŠ è½½å½“å‰è¿›åº¦ç„¶åæäº¤
                    loadUserProgress(answerData);
                    await submitQuiz();
                });
                return;
            }
            
            hideLoading();
            loadUserProgress(answerData);

if (quizData.settings.enableAntiCheat) {
    console.log("é‡æ–°åˆå§‹åŒ–é˜²ä½œå¼Šç³»ç»Ÿ...");
    setTimeout(() => {
        initAntiCheatSystem();
        // å°è¯•é‡æ–°è¿›å…¥å…¨å±æ¨¡å¼
        setTimeout(() => {
            requestFullscreen();
        }, 500);
    }, 100);
}
            showQuizView();
        }
    } catch (error) {
        console.error("è·å–ç­”é¢˜çŠ¶æ€å¤±è´¥:", error);
        hideLoading();
        Swal.fire('é”™è¯¯', `è·å–ç­”é¢˜çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
        showWelcomeView();
    }
}

        function resetCheatWarnings() {
    if (currentUser) {
        database.ref('cheatWarnings/' + currentUser.uid).remove().catch(error => {
            console.error("é‡ç½®è­¦å‘Šæ¬¡æ•°é”™è¯¯:", error);
        });
    }
    warningCount = 0;
}

        // åˆå§‹åŒ–ç›‘æ§ç³»ç»Ÿ
        function initMonitor() {
    // æ¸…é™¤ç°æœ‰çš„ç›‘æ§é—´éš”
    if (monitorInterval) {
        clearInterval(monitorInterval);
    }
    
    // æ›´æ–°ç›‘æ§åˆ—è¡¨
    updateMonitorList();
    
    // å¦‚æœæœ‰é€‰ä¸­çš„å‚èµ›è€…ï¼Œå¼€å§‹ç›‘æ§
    if (currentMonitoringUserId) {
        monitorParticipant(currentMonitoringUserId);
    }
    
    // è®¾ç½®å®šæ—¶åˆ·æ–°ç›‘æ§æ•°æ®ï¼ˆæ¯30ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
    monitorInterval = setInterval(() => {
        if (currentMonitoringUserId) {
            monitorParticipant(currentMonitoringUserId);
        }
        updateMonitorList();
    }, 30000);
    
    console.log("ç›‘æ§ç³»ç»Ÿå·²åˆå§‹åŒ–");
}

        // æ›´æ–°ç®¡ç†å‘˜ç›‘æ§çŠ¶æ€
async function updateAdminMonitorStatus(userId, status) {
    try {
        const updates = {};
        updates[`userAnswers/${userId}/status`] = status;
        updates[`userAnswers/${userId}/lastUpdated`] = firebase.database.ServerValue.TIMESTAMP;
        
        // å¦‚æœçŠ¶æ€æ˜¯completedï¼Œä¹Ÿæ›´æ–°æäº¤æ—¶é—´
        if (status === 'completed') {
            updates[`userAnswers/${userId}/endTime`] = new Date().getTime();
        }
        
        await database.ref().update(updates);
        console.log(`ç”¨æˆ· ${userId} çŠ¶æ€æ›´æ–°ä¸º: ${status}`);
    } catch (error) {
        console.error("æ›´æ–°ç®¡ç†å‘˜çŠ¶æ€é”™è¯¯:", error);
    }
}

// åœ¨ç›‘æ§åˆ—è¡¨ä¸­æ˜¾ç¤ºçŠ¶æ€
function updateMonitorList() {
    database.ref('userAnswers').once('value').then(snapshot => {
        const monitorList = document.getElementById('participantMonitorList');
        monitorList.innerHTML = '';
        
        if (snapshot.exists()) {
            const participants = [];
            
            snapshot.forEach(childSnapshot => {
                const participant = childSnapshot.val();
                if (participant.userInfo) {
                    participants.push(participant);
                }
            });
            
            participants.sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
            
            participants.forEach(participant => {
                const progress = calculateProgress(participant);
                const isActive = participant.userId === currentMonitoringUserId;
                const isCompleted = participant.submitted === true;
                
                const item = document.createElement('button');
                item.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${isActive ? 'active' : ''}`;
                item.innerHTML = `
                    <div>
                        <strong>${participant.userInfo.name}</strong>
                        <div class="text-muted small">
                            ${participant.userInfo.class} - 
                            ${participant.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'}
                            ${isCompleted ? ' (å·²æäº¤)' : ' (ç­”é¢˜ä¸­)'}
                        </div>
                    </div>
                    <span class="badge ${isCompleted ? 'bg-success' : 'bg-warning'} rounded-pill">
                        ${isCompleted ? 'å·²å®Œæˆ' : progress}%
                    </span>
                `;
                
                item.addEventListener('click', () => {
                    currentMonitoringUserId = participant.userId;
                    updateMonitorList();
                    monitorParticipant(participant.userId);
                });
                
                monitorList.appendChild(item);
            });
        }
    });
}

        // åœ¨ç”¨æˆ·å¼€å§‹ç­”é¢˜æ—¶åˆå§‹åŒ–é˜²ä½œå¼Šç³»ç»Ÿ
function initializeUserQuiz() {
    const timeCheck = checkCompetitionTime();
    if (!timeCheck.allowed) {
        Swal.fire({
            title: 'æ— æ³•å¼€å§‹ç­”é¢˜',
            html: timeCheck.reason,
            icon: 'error',
            confirmButtonText: 'ç¡®å®š'
        });
        showWelcomeView();
        return;
    }
    
    if (!quizData.questions || quizData.questions.length === 0) {
        Swal.fire('é”™è¯¯', 'é¢˜ç›®æ•°æ®æœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•', 'error');
        return;
    }
    
    userAnswers = quizData.questions.map(question => ({
        questionId: question.id,
        selectedOptions: [],
        answerText: '',
        isCorrect: null,
        isMarked: false
    }));
    
    currentQuestionIndex = 0;
    quizStartTime = new Date().getTime();
    timeRemaining = quizData.settings.duration * 60;
    
    saveUserProgress();
    
    // ============ ä¿®å¤ï¼šåªæœ‰åœ¨ç®¡ç†å‘˜å¼€å§‹æ¯”èµ›åæ‰å¯ç”¨é˜²ä½œå¼Šç³»ç»Ÿ ============
    // æ£€æŸ¥æ¯”èµ›çŠ¶æ€æ˜¯å¦ä¸ºè¿›è¡Œä¸­
    if (quizData.settings.status === 'in_progress' && quizData.settings.enableAntiCheat) {
        console.log("æ¯”èµ›è¿›è¡Œä¸­ï¼Œå¯ç”¨é˜²ä½œå¼Šç³»ç»Ÿ");
        
        // ç¡®ä¿æ¸…é™¤ä»»ä½•ç°æœ‰çš„è­¦å‘Šæ•°æ®
        resetCheatWarnings();
        
        // å»¶è¿Ÿåˆå§‹åŒ–é˜²ä½œå¼Šç³»ç»Ÿï¼Œç¡®ä¿æ•°æ®å·²é‡ç½®
        setTimeout(() => {
            initAntiCheatSystem();
            
            // å»¶è¿Ÿè¯·æ±‚å…¨å±ï¼Œç¡®ä¿é˜²ä½œå¼Šç³»ç»Ÿå·²å®Œå…¨åˆå§‹åŒ–
            setTimeout(() => {
                requestFullscreen();
            }, 1000);
        }, 500);
    } else {
        console.log("æ¯”èµ›æœªå¼€å§‹æˆ–é˜²ä½œå¼Šç³»ç»Ÿæœªå¯ç”¨ï¼Œè·³è¿‡é˜²ä½œå¼Šåˆå§‹åŒ–");
    }
    
    startTimer();
    displayQuestion(currentQuestionIndex);
    updateQuestionNavDots();
}
        // æ·»åŠ é‡ç½®è­¦å‘Šæ¬¡æ•°çš„å‡½æ•°
function resetCheatWarnings() {
    if (currentUser) {
        // é‡ç½®æœ¬åœ°è­¦å‘Šæ¬¡æ•°
        warningCount = 0;
        tabSwitchCount = 0;
        mouseLeaveCount = 0;
        
        // é‡ç½®Firebaseä¸­çš„è­¦å‘Šæ¬¡æ•°
        const resetData = {
            current: 0,
            lastReset: new Date().getTime()
        };
        
        database.ref('cheatWarnings/' + currentUser.uid).set(resetData)
            .catch(error => {
                console.error("é‡ç½®è­¦å‘Šæ¬¡æ•°é”™è¯¯:", error);
            });
    }
}
        
        // åŠ è½½ç”¨æˆ·è¿›åº¦
function loadUserProgress(answerData) {
    // ç¡®ä¿ userAnswers æ˜¯æœ‰æ•ˆæ•°ç»„
    if (!userAnswers || !Array.isArray(userAnswers)) {
        console.warn("userAnswers æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–");
        userAnswers = quizData.questions.map(question => ({
            questionId: question.id,
            selectedOptions: [],
            answerText: '',
            isCorrect: null,
            isMarked: false
        }));
    }
    
    // åˆå¹¶ç°æœ‰ç­”æ¡ˆå’Œä¿å­˜çš„ç­”æ¡ˆ
    const savedAnswers = Array.isArray(answerData.answers) ? answerData.answers : [];
    
    savedAnswers.forEach((savedAnswer, index) => {
        if (userAnswers[index]) {
            userAnswers[index] = {
                ...userAnswers[index],
                ...savedAnswer
            };
        }
    });
    
    currentQuestionIndex = answerData.currentQuestionIndex || 0;
    userAnswers = Array.isArray(answerData.answers) ? answerData.answers : [];
    currentQuestionIndex = answerData.currentQuestionIndex || 0;
    
    // ============ ä¿®å¤å¼€å§‹æ—¶é—´å¤„ç† ============
    // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å¼€å§‹æ—¶é—´
    quizStartTime = answerData.startTime;
    
    if (!quizStartTime) {
        // å¦‚æœæ²¡æœ‰å¼€å§‹æ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
        console.warn("è­¦å‘Šï¼šç­”é¢˜æ•°æ®ç¼ºå°‘å¼€å§‹æ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´");
        quizStartTime = new Date().getTime();
        
        // ç«‹å³ä¿å­˜ä¿®å¤åçš„å¼€å§‹æ—¶é—´
        setTimeout(() => {
            if (currentUser) {
                database.ref('userAnswers/' + currentUser.uid + '/startTime').set(quizStartTime);
            }
        }, 1000);
    }
    
    // è®¡ç®—å‰©ä½™æ—¶é—´
    const currentTime = new Date().getTime();
    const timeElapsed = Math.max(0, Math.floor((currentTime - quizStartTime) / 1000));
    timeRemaining = Math.max(0, quizData.settings.duration * 60 - timeElapsed);
    // ============ ä¿®å¤ç»“æŸ ============
    
    // æ¢å¤æ ‡è®°çš„é¢˜ç›®
    markedQuestions = new Set(answerData.markedQuestions || []);
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»æäº¤ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
    if (answerData.submitted) {
        console.warn("æ£€æµ‹åˆ°å·²æäº¤çš„ç­”é¢˜è®°å½•ï¼Œä½†ä»åœ¨åŠ è½½è¿›åº¦");
        showResultView();
        return;
    }
    
    startTimer();
    displayQuestion(currentQuestionIndex);
    updateQuestionNavDots();
}
        
        // å¼€å§‹è®¡æ—¶å™¨
function startTimer() {
    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨
    if (quizTimer) {
        clearInterval(quizTimer);
        quizTimer = null;
    }
    
    // ============ ä¿®å¤è®¡æ—¶å™¨åŒæ­¥ ============
    // é‡æ–°è®¡ç®—å‡†ç¡®æ—¶é—´
    const currentTime = new Date().getTime();
    const actualTimeElapsed = Math.max(0, Math.floor((currentTime - quizStartTime) / 1000));
    timeRemaining = Math.max(0, quizData.settings.duration * 60 - actualTimeElapsed);
    
    console.log("è®¡æ—¶å™¨å¯åŠ¨ï¼š", {
        startTime: new Date(quizStartTime).toLocaleTimeString(),
        currentTime: new Date(currentTime).toLocaleTimeString(),
        timeElapsed: actualTimeElapsed,
        timeRemaining: timeRemaining
    });
    // ============ ä¿®å¤ç»“æŸ ============
    
    updateTimerDisplay();
    quizTimer = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        
        if (timeRemaining <= 0) {
            clearInterval(quizTimer);
            quizTimer = null;
            
            // æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨æäº¤
            Swal.fire({
                title: 'æ—¶é—´åˆ°ï¼',
                text: 'ç­”é¢˜æ—¶é—´å·²ç»“æŸï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æäº¤æ‚¨çš„ç­”æ¡ˆ',
                icon: 'info',
                showCancelButton: false,
                confirmButtonText: 'ç¡®å®š',
                allowOutsideClick: false
            }).then(() => {
                submitQuiz();
            });
        }
        
        // å®šæœŸä¿å­˜è¿›åº¦ï¼ˆæ¯30ç§’ï¼‰
        if (timeRemaining % 30 === 0) {
            saveUserProgress();
        }
    }, 1000);
}
        
        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timerElement = document.getElementById('quizTimer');
            timerElement.textContent = `å‰©ä½™æ—¶é—´: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const totalTime = quizData.settings.duration * 60;
            const progress = ((totalTime - timeRemaining) / totalTime) * 100;
            document.getElementById('quizProgress').style.width = `${progress}%`;
            
            if (timeRemaining < 300) {
                timerElement.classList.add('text-danger');
            } else {
                timerElement.classList.remove('text-danger');
            }
        }
        
        // æ˜¾ç¤ºé¢˜ç›®
        function displayQuestion(index) {
            if (index < 0 || index >= quizData.questions.length) {
                console.error("æ— æ•ˆçš„é¢˜ç›®ç´¢å¼•:", index);
                return;
            }

            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ•°æ®æ­£ç¡®åˆå§‹åŒ–
    if (!quizData.questions || !Array.isArray(quizData.questions)) {
        console.error("é¢˜ç›®æ•°æ®æœªåŠ è½½");
        Swal.fire('é”™è¯¯', 'é¢˜ç›®æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
    }
    
    if (index < 0 || index >= quizData.questions.length) {
        console.error("æ— æ•ˆçš„é¢˜ç›®ç´¢å¼•:", index);
        return;
    }
    
    // ç¡®ä¿ userAnswers æ˜¯æœ‰æ•ˆæ•°ç»„
    if (!userAnswers || !Array.isArray(userAnswers)) {
        console.warn("userAnswers æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–");
        userAnswers = quizData.questions.map(question => ({
            questionId: question.id,
            selectedOptions: [],
            answerText: '',
            isCorrect: null,
            isMarked: false
        }));
    }
    
    // ç¡®ä¿å½“å‰é¢˜ç›®çš„ç­”æ¡ˆå¯¹è±¡å­˜åœ¨
    if (!userAnswers[index]) {
        userAnswers[index] = {
            questionId: quizData.questions[index].id,
            selectedOptions: [],
            answerText: '',
            isCorrect: null,
            isMarked: false
        };
    }

            if (!markedQuestions || !(markedQuestions instanceof Set)) {
        markedQuestions = new Set();
        console.warn("é‡æ–°åˆå§‹åŒ– markedQuestions");
    }
            
            const question = quizData.questions[index];
            const userAnswer = (userAnswers[index] && typeof userAnswers[index] === 'object') ? userAnswers[index] : {
                selectedOptions: [],
                answerText: '',
                isCorrect: null,
                isMarked: false
            };
            
            // ç¡®ä¿ selectedOptions æ˜¯æ•°ç»„
            if (!Array.isArray(userAnswer.selectedOptions)) {
                userAnswer.selectedOptions = [];
            }
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('quizUserInfo').textContent = `${userInfo.class} - ${userInfo.group === 'highschool' ? 'é«˜ä¸­ç»„' : 'åˆä¸­ç»„'}`;
            
            let questionHTML = `
                <div class="question-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>é¢˜ç›® ${index + 1}/${quizData.questions.length} (${question.points}åˆ†)</h4>
                        ${markedQuestions.has(index) ? '<span class="badge bg-warning"><i class="fas fa-flag me-1"></i>å·²æ ‡è®°</span>' : ''}
                    </div>
                    <div class="question-content">${question.text}</div>
            `;
            
            if (question.imageUrl) {
                questionHTML += `
                    <div class="text-center my-3">
                        <img src="${question.imageUrl}" class="img-fluid rounded" style="max-height: 300px;">
                    </div>
                `;
            }
            
            if (question.type === 'single' || question.type === 'multiple') {
                questionHTML += `<div class="options-list mt-3">`;
                
                question.options.forEach((option, i) => {
                    const isSelected = userAnswer.selectedOptions.includes(i);
                    questionHTML += `
                        <div class="option-item ${isSelected ? 'selected' : ''}" data-option="${i}">
                            ${String.fromCharCode(65 + i)}. ${option.text}
                        </div>
                    `;
                });
                
                questionHTML += `</div>`;
            } else {
                questionHTML += `
                    <div class="form-group mt-3">
                        <textarea class="form-control answer-textarea" rows="${question.type === 'short_answer' ? 3 : 8}" 
                            placeholder="${question.type === 'short_answer' ? 'è¯·è¾“å…¥æ‚¨çš„ç­”æ¡ˆ...' : 'è¯·è¯¦ç»†å›ç­”...'}"
                            data-question-index="${index}">${userAnswer.answerText || ''}</textarea>
                    </div>
                `;
            }
            
            questionHTML += `</div>`;
            document.getElementById('quizQuestionsContainer').innerHTML = questionHTML;
            
            if (question.type === 'single' || question.type === 'multiple') {
                document.querySelectorAll('.option-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const optionIndex = parseInt(this.getAttribute('data-option'));
                        selectOption(index, optionIndex);
                    });
                });
            } else {
                document.querySelector('.answer-textarea').addEventListener('input', function() {
                    userAnswers[index].answerText = this.value;
                    saveUserProgress();
                });
            }
            
            document.getElementById('prevQuestionBtn').disabled = index === 0;
            document.getElementById('nextQuestionBtn').disabled = index === quizData.questions.length - 1;
            
            updateQuestionNavDots();
        }
        
        // é€‰æ‹©é€‰é¡¹
        // é€‰æ‹©é€‰é¡¹
function selectOption(questionIndex, optionIndex) {
    // ============ æ·»åŠ å®‰å…¨æ£€æŸ¥ ============
    if (questionIndex < 0 || questionIndex >= quizData.questions.length) {
        console.error("æ— æ•ˆçš„é¢˜ç›®ç´¢å¼•:", questionIndex);
        return;
    }
    
    // ç¡®ä¿ userAnswers[questionIndex] å­˜åœ¨
    if (!userAnswers[questionIndex]) {
        userAnswers[questionIndex] = {
            questionId: quizData.questions[questionIndex].id,
            selectedOptions: [],
            answerText: '',
            isCorrect: null,
            isMarked: false
        };
    }
    
    // ç¡®ä¿ selectedOptions æ˜¯æ•°ç»„
    if (!Array.isArray(userAnswers[questionIndex].selectedOptions)) {
        userAnswers[questionIndex].selectedOptions = [];
    }
    // ============ å®‰å…¨æ£€æŸ¥ç»“æŸ ============
    
    const question = quizData.questions[questionIndex];
    const userAnswer = userAnswers[questionIndex];
    
    if (question.type === 'single') {
        userAnswer.selectedOptions = [optionIndex];
    } else {
        // å®‰å…¨ä½¿ç”¨ includes
        const optionPos = userAnswer.selectedOptions.indexOf(optionIndex);
        if (optionPos === -1) {
            userAnswer.selectedOptions.push(optionIndex);
        } else {
            userAnswer.selectedOptions.splice(optionPos, 1);
        }
    }
    
    displayQuestion(questionIndex);
    saveUserProgress();
}
        
        // æ›´æ–°é¢˜ç›®å¯¼èˆªç‚¹
        // ä¿®æ”¹ updateQuestionNavDots å‡½æ•°ï¼Œæ·»åŠ å®‰å…¨æ£€æŸ¥
function updateQuestionNavDots() {
    const dotsContainer = document.getElementById('questionNavDots');
    if (!dotsContainer) return;
    
    dotsContainer.innerHTML = '';
    
    // ç¡®ä¿ quizData.questions æ˜¯æœ‰æ•ˆçš„æ•°ç»„
    if (!quizData.questions || !Array.isArray(quizData.questions) || quizData.questions.length === 0) {
        console.warn("æ— æ³•æ›´æ–°å¯¼èˆªç‚¹ï¼šé¢˜ç›®æ•°æ®æ— æ•ˆæˆ–ä¸ºç©º");
        return;
    }
    
    // ç¡®ä¿ userAnswers æ˜¯æœ‰æ•ˆçš„æ•°ç»„
    if (!userAnswers || !Array.isArray(userAnswers)) {
        userAnswers = [];
        console.warn("userAnswers æœªåˆå§‹åŒ–ï¼Œå·²é‡æ–°åˆå§‹åŒ–");
    }
    
    quizData.questions.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = 'nav-dot';
        
        // è·å–ç”¨æˆ·ç­”æ¡ˆï¼Œç¡®ä¿å®ƒæ˜¯æœ‰æ•ˆå¯¹è±¡
        let userAnswer = {};
        if (userAnswers[index] && typeof userAnswers[index] === 'object') {
            userAnswer = userAnswers[index];
        }
        
        // ç¡®ä¿å¿…è¦å±æ€§å­˜åœ¨
        if (!userAnswer.selectedOptions || !Array.isArray(userAnswer.selectedOptions)) {
            userAnswer.selectedOptions = [];
        }
        if (!userAnswer.answerText || typeof userAnswer.answerText !== 'string') {
            userAnswer.answerText = '';
        }
        
        if (index === currentQuestionIndex) {
            dot.classList.add('current');
        } else if (markedQuestions.has(index)) {
            dot.classList.add('answered');
            dot.innerHTML = '<i class="fas fa-flag"></i>';
        } else {
            const question = quizData.questions[index];
            if (!question) {
                dot.classList.add('unanswered');
            } else if (question.type === 'single' || question.type === 'multiple') {
                // æ£€æŸ¥é€‰æ‹©é¢˜æ˜¯å¦å·²å›ç­”
                if (userAnswer.selectedOptions && userAnswer.selectedOptions.length > 0) {
                    dot.classList.add('answered');
                } else {
                    dot.classList.add('unanswered');
                }
            } else {
                // æ£€æŸ¥é—®ç­”é¢˜æ˜¯å¦å·²å›ç­”
                if (userAnswer.answerText && userAnswer.answerText.trim() !== '') {
                    dot.classList.add('answered');
                } else {
                    dot.classList.add('unanswered');
                }
            }
        }
        
        dot.textContent = index + 1;
        dot.addEventListener('click', () => {
            currentQuestionIndex = index;
            displayQuestion(currentQuestionIndex);
        });
        
        dotsContainer.appendChild(dot);
    });
}
        
        // æ ‡è®°/å–æ¶ˆæ ‡è®°é¢˜ç›®
        function toggleMarkQuestion() {
            if (markedQuestions.has(currentQuestionIndex)) {
                markedQuestions.delete(currentQuestionIndex);
            } else {
                markedQuestions.add(currentQuestionIndex);
            }
            
            userAnswers[currentQuestionIndex].isMarked = markedQuestions.has(currentQuestionIndex);
            saveUserProgress();
            displayQuestion(currentQuestionIndex);
        }
        
        // æ˜¾ç¤ºé¢˜ç›®å›é¡¾
        function showQuestionReview() {
            let reviewHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">é¢˜ç›®å›é¡¾</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;
            
            quizData.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index] || {};
                const isAnswered = question.type === 'single' || question.type === 'multiple' ? 
                    userAnswer.selectedOptions && userAnswer.selectedOptions.length > 0 : 
                    userAnswer.answerText && userAnswer.answerText.trim() !== '';
                
                reviewHTML += `
                    <div class="col-md-3 mb-3">
                        <div class="card ${index === currentQuestionIndex ? 'border-primary' : ''} ${markedQuestions.has(index) ? 'border-warning' : ''}">
                            <div class="card-body text-center">
                                <h6>é¢˜ç›® ${index + 1}</h6>
                                <p class="mb-2">${isAnswered ? 'âœ“ å·²å›ç­”' : 'â—‹ æœªç­”'}</p>
                                ${markedQuestions.has(index) ? '<span class="badge bg-warning"><i class="fas fa-flag"></i> æ ‡è®°</span>' : ''}
                                <button class="btn btn-sm btn-outline-primary mt-2 w-100" onclick="jumpToQuestion(${index})">
                                    è·³è½¬
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            reviewHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            Swal.fire({
                title: 'é¢˜ç›®å›é¡¾',
                html: reviewHTML,
                width: '900px',
                showCloseButton: true,
                showConfirmButton: false
            });
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
        function jumpToQuestion(index) {
            Swal.close();
            currentQuestionIndex = index;
            displayQuestion(currentQuestionIndex);
        }
        
        // æ˜¾ç¤ºä¸Šä¸€é¢˜
        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
            }
        }

        // æ˜¾ç¤ºä¸‹ä¸€é¢˜
        function showNextQuestion() {
            if (currentQuestionIndex < quizData.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            }
        }

        // ä¿å­˜ç”¨æˆ·è¿›åº¦
        function saveUserProgress() {
            if (!currentUser) return;
            
            const progressData = {
                answers: userAnswers,
                currentQuestionIndex: currentQuestionIndex,
                startTime: quizStartTime,
                markedQuestions: Array.from(markedQuestions),
                submitted: false,
                userId: currentUser.uid,
                userInfo: userInfo,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref('userAnswers/' + currentUser.uid).set(progressData).catch(error => {
                console.error("ä¿å­˜è¿›åº¦é”™è¯¯:", error);
            });
        }
        
        // ç¡®è®¤æäº¤
        function confirmSubmitQuiz() {
            const unanswered = userAnswers.filter(answer => {
                const question = quizData.questions.find(q => q.id === answer.questionId);
                if (!question) return false;
                
                if (question.type === 'single' || question.type === 'multiple') {
                    return answer.selectedOptions.length === 0;
                } else {
                    return !answer.answerText || answer.answerText.trim() === '';
                }
            }).length;
            
            document.getElementById('unansweredCountModal').textContent = unanswered;
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('remainingTimeModal').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const submitConfirmModal = new bootstrap.Modal(document.getElementById('submitConfirmModal'));
            submitConfirmModal.show();
        }
        
// æäº¤ç­”å· - ä¿®å¤ç‰ˆæœ¬
async function submitQuiz() {
    // ç¡®ä¿åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨å’Œç›‘æ§
    if (quizTimer) {
        clearInterval(quizTimer);
        quizTimer = null;
    }
    
    if (fullscreenCountdown) {
        clearInterval(fullscreenCountdown);
        fullscreenCountdown = null;
    }
    resetCheatWarnings();
    // å…³é—­é˜²ä½œå¼Šç›‘æ§
    cleanupAntiCheatSystem();

        if (currentUser) {
        database.ref('cheatWarnings/' + currentUser.uid).remove()
            .then(() => {
                console.log("ç”¨æˆ·æäº¤ç­”å·ï¼Œå·²æ¸…é™¤è­¦å‘Šæ¬¡æ•°");
            })
            .catch(error => {
                console.error("æ¸…é™¤è­¦å‘Šæ¬¡æ•°é”™è¯¯:", error);
            });
    }
    
    // éšè—é˜²ä½œå¼Šç›¸å…³å…ƒç´ 
    document.getElementById('cheatDetectionPanel').classList.add('d-none');
    document.getElementById('antiCheatAlert').classList.add('d-none');
    document.getElementById('fullscreenOverlay').classList.add('d-none');
    
    // ç§»é™¤é˜²ä½œå¼ŠCSSç±»
    document.body.classList.remove('no-select', 'no-context-menu');

    try {
        // ä¿å­˜å½“å‰é¢˜ç›®çš„ç­”æ¡ˆ
        const currentQ = quizData.questions[currentQuestionIndex];
        if (currentQ && (currentQ.type === 'short_answer' || currentQ.type === 'essay')) {
            const answerInput = document.querySelector('.answer-textarea');
            if (answerInput) {
                userAnswers[currentQuestionIndex].answerText = answerInput.value.trim();
            }
        }
    } catch (e) {
        console.warn('æ— æ³•ä¿å­˜å½“å‰é¢˜ç­”æ¡ˆ:', e);
    }

    // è®¡ç®—åˆ†æ•°
    userAnswers.forEach((answer, index) => {
        const question = quizData.questions[index];
        if (!question) return;

        if (question.type === 'single' || question.type === 'multiple') {
            const selected = Array.isArray(answer.selectedOptions) ? answer.selectedOptions.slice().sort() : [];
            const correct = Array.isArray(question.correctAnswers) ? question.correctAnswers.slice().sort() : [];

            answer.isCorrect = (
                selected.length === correct.length &&
                selected.every((v, i) => v === correct[i])
            );
            answer.score = answer.isCorrect ? question.points : 0;
        } else if (question.type === 'short_answer' || question.type === 'essay') {
            if (question.correctAnswerText && answer.answerText) {
                const normalizedCorrect = question.correctAnswerText.toLowerCase()
                    .replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
                const normalizedUser = answer.answerText.toLowerCase()
                    .replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
                
                answer.isCorrect = normalizedUser.includes(normalizedCorrect) || 
                                normalizedCorrect.includes(normalizedUser) ||
                                calculateSimilarity(normalizedUser, normalizedCorrect) > 0.7;
                
                answer.score = answer.isCorrect ? question.points : 0;
            }
        }
    });

    const totalScore = calculateTotalScore();
    const endTime = new Date().getTime();
    
    // ============ ä¿®å¤æ—¶é—´è®¡ç®—é€»è¾‘ ============
    // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å¼€å§‹æ—¶é—´
    const actualStartTime = quizStartTime;
    
    // è®¡ç®—ç”¨æ—¶ï¼ˆç§’ï¼‰
    let timeUsed = Math.floor((endTime - actualStartTime) / 1000);
    
    // éªŒè¯æ—¶é—´åˆç†æ€§
    const maxQuizTime = quizData.settings.duration * 60; // æ¯”èµ›æœ€å¤§æ—¶é—´ï¼ˆç§’ï¼‰
    
    // å¦‚æœæ—¶é—´å¼‚å¸¸ï¼Œè¿›è¡Œä¿®æ­£
    if (timeUsed < 0) {
        console.warn("æ—¶é—´è®¡ç®—å¼‚å¸¸ï¼šè´Ÿå€¼ï¼Œä½¿ç”¨é»˜è®¤å€¼");
        timeUsed = Math.max(0, timeUsed); // ç¡®ä¿ä¸ä¸ºè´Ÿ
    }
    
    // å¦‚æœæ—¶é—´è¶…è¿‡æœ€å¤§æ¯”èµ›æ—¶é—´ï¼Œä½¿ç”¨æœ€å¤§æ¯”èµ›æ—¶é—´
    if (timeUsed > maxQuizTime * 1.5) { // å…è®¸50%çš„ç¼“å†²
        console.warn(`æ—¶é—´å¼‚å¸¸ï¼š${timeUsed}ç§’è¶…è¿‡åˆç†èŒƒå›´ï¼Œä½¿ç”¨æœ€å¤§å€¼`);
        timeUsed = maxQuizTime;
    }
    
    // ç¡®ä¿æ—¶é—´ä¸è¶…è¿‡æ¯”èµ›æ—¶é•¿
    timeUsed = Math.min(timeUsed, maxQuizTime);
    
    // è®°å½•è¯¦ç»†æ—¶é—´ä¿¡æ¯ç”¨äºè°ƒè¯•
    console.log("æ—¶é—´è®¡ç®—è¯¦æƒ…ï¼š", {
        startTime: new Date(actualStartTime).toLocaleTimeString(),
        endTime: new Date(endTime).toLocaleTimeString(),
        calculatedTime: timeUsed,
        maxAllowedTime: maxQuizTime
    });
    // ============ ä¿®å¤ç»“æŸ ============

    const resultData = {
        answers: userAnswers,
        startTime: actualStartTime,  // ä½¿ç”¨æ­£ç¡®çš„å¼€å§‹æ—¶é—´
        endTime: endTime,
        submitted: true,
        userId: currentUser.uid,
        userInfo: {
            ...userInfo,
            name: currentUser.displayName || currentUser.email,
            photoURL: currentUser.photoURL || ''
        },
        score: totalScore,
        finalScore: totalScore,  // ç¡®ä¿æœ‰finalScoreå­—æ®µ
        totalScore: totalScore,  // ç¡®ä¿æœ‰totalScoreå­—æ®µ
        correctCount: userAnswers.filter(a => a.isCorrect === true).length,
        wrongCount: userAnswers.filter(a => a.isCorrect === false).length,
        unansweredCount: userAnswers.filter(a => {
            const question = quizData.questions.find(q => q.id === a.questionId);
            if (!question) return true;

            if (question.type === 'single' || question.type === 'multiple') {
                return !Array.isArray(a.selectedOptions) || a.selectedOptions.length === 0;
            } else {
                return !a.answerText || a.answerText.trim() === '';
            }
        }).length,
        markedQuestions: Array.from(markedQuestions),
        retryCount: (userAnswers.retryCount || 0) + 1,
        submissionTime: endTime,
        status: 'completed',  // æ·»åŠ æ˜ç¡®çš„çŠ¶æ€å­—æ®µ
        timeUsed: timeUsed,  // ä½¿ç”¨è®¡ç®—å‡ºçš„å‡†ç¡®æ—¶é—´
        lastUpdated: firebase.database.ServerValue.TIMESTAMP
    };

    try {
        // ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
        const userAnswerRef = database.ref('userAnswers/' + currentUser.uid);
        
        await userAnswerRef.transaction(currentData => {
            if (currentData === null) {
                return resultData;
            }
            
            // å¦‚æœå·²ç»æäº¤è¿‡ï¼Œæ›´æ–°é‡è¯•æ¬¡æ•°
            if (currentData.submitted) {
                resultData.retryCount = (currentData.retryCount || 0) + 1;
            }
            
            return { ...currentData, ...resultData };
        });

        console.log("æäº¤æˆåŠŸï¼Œæ•°æ®å·²ä¿å­˜");
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        await Swal.fire({
            title: 'æäº¤æˆåŠŸï¼',
            text: `æ‚¨çš„ç­”å·å·²æˆåŠŸæäº¤ï¼Œå¾—åˆ†ï¼š${totalScore}ï¼Œç”¨æ—¶ï¼š${Math.floor(timeUsed/60)}åˆ†${timeUsed%60}ç§’`,
            icon: 'success',
            confirmButtonText: 'æŸ¥çœ‹æˆç»©'
        });

        // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç›¸å…³çŠ¶æ€
        localStorage.removeItem(`quiz_progress_${currentUser.uid}`);
        
        // åˆ·æ–°é¡µé¢ä»¥å®Œå…¨é‡ç½®çŠ¶æ€
        setTimeout(() => {
            window.location.reload();
        }, 100);

    } catch (error) {
        console.error("æäº¤ç­”å·é”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'æäº¤ç­”å·å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

        // æ·»åŠ è­¦å‘Šè®°å½•æŸ¥çœ‹åŠŸèƒ½
function viewCheatWarnings(userId) {
    showLoading('åŠ è½½è­¦å‘Šè®°å½•...');
    
    database.ref('cheatWarnings/' + userId + '/history').once('value').then(snapshot => {
        hideLoading();
        
        if (snapshot.exists()) {
            let warningsHTML = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>æ—¶é—´</th><th>åŸå› </th><th>è­¦å‘Šæ¬¡æ•°</th></tr></thead><tbody>';
            
            const warnings = [];
            snapshot.forEach(childSnapshot => {
                warnings.push(childSnapshot.val());
            });
            
            // æŒ‰æ—¶é—´æ’åº
            warnings.sort((a, b) => b.timestamp - a.timestamp);
            
            warnings.forEach(warning => {
                warningsHTML += `
                    <tr>
                        <td>${new Date(warning.timestamp).toLocaleString()}</td>
                        <td>${warning.reason}</td>
                        <td>${warning.warningCount}</td>
                    </tr>
                `;
            });
            
            warningsHTML += '</tbody></table></div>';
            
            Swal.fire({
                title: 'ä½œå¼Šè­¦å‘Šè®°å½•',
                html: warningsHTML,
                width: '800px',
                confirmButtonText: 'å…³é—­'
            });
        } else {
            Swal.fire('æç¤º', 'æ²¡æœ‰è­¦å‘Šè®°å½•', 'info');
        }
    }).catch(error => {
        hideLoading();
        console.error("åŠ è½½è­¦å‘Šè®°å½•é”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'åŠ è½½å¤±è´¥: ' + error.message, 'error');
    });
}
        
        function calculateSimilarity(str1, str2) {
            const set1 = new Set(str1.split(/\s+/));
            const set2 = new Set(str2.split(/\s+/));
            const intersection = new Set([...set1].filter(x => set2.has(x)));
            return intersection.size / Math.max(set1.size, set2.size);
        }

        // è®¡ç®—æ€»åˆ†
        function calculateTotalScore() {
            return userAnswers.reduce((total, answer, index) => {
                const question = quizData.questions[index];
                if (!question) return total;

                if (question.type === 'short_answer' || question.type === 'essay') {
                    return total + (typeof answer.score === 'number' ? answer.score : 0);
                }
                return total + (answer.isCorrect ? question.points : 0);
            }, 0);
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults() {
            userAnswers = userAnswers.map((ua, index) => {
                const question = quizData.questions[index];
                if (!ua || typeof ua !== 'object') return {
                    questionId: question?.id || null,
                    selectedOptions: [],
                    answerText: '',
                    isCorrect: null,
                    score: 0,
                    isMarked: false
                };

                return {
                    questionId: ua.questionId || question?.id || null,
                    selectedOptions: Array.isArray(ua.selectedOptions) ? ua.selectedOptions : [],
                    answerText: typeof ua.answerText === 'string' ? ua.answerText : '',
                    isCorrect: typeof ua.isCorrect === 'boolean' ? ua.isCorrect : null,
                    score: typeof ua.score === 'number' ? ua.score : 0,
                    isMarked: ua.isMarked || false
                };
            });

            if (!Array.isArray(userAnswers)) {
                userAnswers = [];
            }

            const total = calculateTotalScore();
            const maxScore = quizData.questions.reduce((sum, q) => sum + q.points, 0);
            const correct = userAnswers.filter(a => a.isCorrect === true).length;
            const wrong = userAnswers.filter(a => a.isCorrect === false).length;
            
            const unanswered = userAnswers.filter(a => {
                const question = quizData.questions.find(q => q.id === a.questionId);
                if (!question) return true;

                if (question.type === 'single' || question.type === 'multiple') {
                    return !Array.isArray(a.selectedOptions) || a.selectedOptions.length === 0;
                } else {
                    return !a.answerText || a.answerText.trim() === '';
                }
            }).length;

            document.getElementById('finalScore').textContent = `${total}/${maxScore}`;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            document.getElementById('unansweredCount').textContent = unanswered;
            document.getElementById('totalScore').textContent = total;

            let resultsHTML = '';

            quizData.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index] || {};
                const isCorrect = userAnswer.isCorrect ?? null;
                const selectedOptions = Array.isArray(userAnswer.selectedOptions) ? userAnswer.selectedOptions : [];
                const answerText = typeof userAnswer.answerText === 'string' ? userAnswer.answerText : '';
                const options = Array.isArray(question.options) ? question.options : [];
                const correctAnswers = Array.isArray(question.correctAnswers) ? question.correctAnswers : [];
                const questionScore = userAnswer.score || 0;
                const isMarked = userAnswer.isMarked || false;

                resultsHTML += `
                    <div class="question-card mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>é¢˜ç›® ${index + 1} (${question.points}åˆ†)</h4>
                            <div>
                                ${isMarked ? '<span class="badge bg-warning me-2"><i class="fas fa-flag"></i> æ ‡è®°</span>' : ''}
                                <span class="badge ${isCorrect === true ? 'bg-success' : isCorrect === false ? 'bg-danger' : 'bg-secondary'}">
                                    ${isCorrect === true ? 'æ­£ç¡®' : isCorrect === false ? 'é”™è¯¯' : 'æœªä½œç­”'}
                                    ${question.type === 'short_answer' || question.type === 'essay' ? 
                                    `: ${questionScore}/${question.points}åˆ†` : ''}
                                </span>
                            </div>
                        </div>
                        <div class="question-content">${question.text || ''}</div>
                `;

                if (question.imageUrl) {
                    resultsHTML += `
                        <div class="text-center my-3">
                            <img src="${question.imageUrl}" class="img-fluid rounded" style="max-height: 300px;">
                        </div>
                    `;
                }

                if (question.type === 'single' || question.type === 'multiple') {
                    resultsHTML += `<div class="options-list mt-3">`;

                    options.forEach((option, i) => {
                        const isSelected = selectedOptions.includes(i);
                        const isCorrectOption = correctAnswers.includes(i);

                        let optionClass = '';
                        if (isCorrectOption && isSelected) {
                            optionClass = 'correct';
                        } else if (isCorrectOption && !isSelected) {
                            optionClass = 'missed';
                        } else if (!isCorrectOption && isSelected) {
                            optionClass = 'incorrect';
                        }

                        resultsHTML += `
                            <div class="option-item ${optionClass}">
                                ${String.fromCharCode(65 + i)}. ${option.text}
                                ${isSelected ? '<span class="float-end">âœ“</span>' : ''}
                            </div>
                        `;
                    });

                    resultsHTML += `</div>`;

                    if (isCorrect === false && correctAnswers.length > 0) {
                        resultsHTML += `
                            <div class="mt-2 text-success">
                                <strong>æ­£ç¡®ç­”æ¡ˆ:</strong> 
                                ${correctAnswers.map(a => String.fromCharCode(65 + a)).join(', ')}
                            </div>
                        `;
                    }
                } else {
                    resultsHTML += `
                        <div class="mt-3">
                            <h5>æ‚¨çš„ç­”æ¡ˆï¼š</h5>
                            <div class="p-3 bg-light rounded">
                                ${answerText || '<span class="text-muted">æœªä½œç­”</span>'}
                            </div>
                        </div>
                    `;

                    if (question.correctAnswerText) {
                        resultsHTML += `
                            <div class="mt-3">
                                <h5>å‚è€ƒç­”æ¡ˆï¼š</h5>
                                <div class="p-3 bg-light rounded">
                                    ${question.correctAnswerText}
                                </div>
                            </div>
                        `;
                    }

                    if (question.type === 'short_answer' || question.type === 'essay') {
                        resultsHTML += `
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>å¾—åˆ†ï¼š${questionScore}/${question.points}</span>
                                    ${isCorrect !== null ? 
                                    `<span class="text-${isCorrect ? 'success' : 'danger'}">
                                        ${isCorrect ? 'ç­”æ¡ˆæ­£ç¡®' : 'ç­”æ¡ˆä¸æ­£ç¡®'}
                                    </span>` : ''}
                                </div>
                            </div>
                        `;
                    }
                }

                resultsHTML += `</div>`;
            });

            document.getElementById('resultQuestionsContainer').innerHTML = resultsHTML;
            loadRankingData();
        }
        
        // åŠ è½½ç”¨æˆ·ç»“æœ
        async function loadUserResults() {
            try {
                if (!Array.isArray(quizData.questions) || quizData.questions.length === 0) {
                    setTimeout(loadUserResults, 300);
                    return;
                }

                const snapshot = await database.ref('userAnswers/' + currentUser.uid).once('value');

                if (!snapshot.exists()) {
                    Swal.fire('æç¤º', 'æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·çš„ç­”é¢˜è®°å½•', 'info');
                    return;
                }

                const data = snapshot.val();
                userAnswers = Array.isArray(data.answers) ? data.answers : [];
                displayResults();
            } catch (error) {
                console.error("æŸ¥çœ‹å‚èµ›è€…ç­”æ¡ˆé”™è¯¯:", error);
                Swal.fire('é”™è¯¯', `æŸ¥çœ‹å‚èµ›è€…ç­”æ¡ˆé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // åŠ è½½æ’åæ•°æ®
        function loadRankingData() {
            database.ref('userAnswers').orderByChild('submitted').equalTo(true).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const allResults = [];
                    const highschoolResults = [];
                    const middleschoolResults = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const result = childSnapshot.val();
                        if (result.userInfo && result.score !== undefined) {
                            allResults.push(result);
                            
                            if (result.userInfo.group === 'highschool') {
                                highschoolResults.push(result);
                            } else if (result.userInfo.group === 'middleschool') {
                                middleschoolResults.push(result);
                            }
                        }
                    });
                    
                    allResults.sort((a, b) => b.score - a.score || (a.endTime - a.startTime) - (b.endTime - b.startTime));
                    highschoolResults.sort((a, b) => b.score - a.score || (a.endTime - a.startTime) - (b.endTime - b.startTime));
                    middleschoolResults.sort((a, b) => b.score - a.score || (a.endTime - a.startTime) - (b.endTime - b.startTime));
                    
                    displayRanking(allResults, highschoolResults, middleschoolResults);
                    updateUserRanking(allResults, highschoolResults, middleschoolResults);
                }
            }).catch(error => {
                console.error("åŠ è½½æ’åæ•°æ®é”™è¯¯:", error);
            });
        }
        
        // æ˜¾ç¤ºæ’å
        // æ˜¾ç¤ºæ’å - ä¿®æ”¹æ—¶é—´æ˜¾ç¤º
function displayRanking(allResults, highschoolResults, middleschoolResults) {
    const displayRankingTable = (results, tbodyId, showGroup = false) => {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = '';
        
        results.forEach((result, index) => {
            // ============ ä¿®å¤æ—¶é—´æ˜¾ç¤ºé€»è¾‘ ============
            let timeUsed = result.timeUsed; // ä¼˜å…ˆä½¿ç”¨å­˜å‚¨çš„æ—¶é—´
            
            // å¦‚æœæ²¡æœ‰å­˜å‚¨çš„æ—¶é—´ï¼Œåˆ™è®¡ç®—
            if (!timeUsed && result.startTime && result.endTime) {
                timeUsed = Math.floor((result.endTime - result.startTime) / 1000);
            }
            
            // éªŒè¯æ—¶é—´åˆç†æ€§
            const maxQuizTime = quizData.settings.duration * 60;
            if (!timeUsed || timeUsed > maxQuizTime * 1.5) {
                // æ—¶é—´å¼‚å¸¸ï¼Œä½¿ç”¨åˆç†ä¼°ç®—
                const answeredQuestions = result.answers?.filter(a => 
                    a.selectedOptions?.length > 0 || a.answerText?.trim()
                ).length || 0;
                // å‡è®¾æ¯é“é¢˜å¹³å‡éœ€è¦15-30ç§’
                timeUsed = Math.min(answeredQuestions * 25, maxQuizTime);
            }
            
            // ç¡®ä¿ä¸ä¸ºè´Ÿ
            timeUsed = Math.max(0, timeUsed || 0);
            
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            // ============ ä¿®å¤ç»“æŸ ============
            
            let rowClass = '';
            if (index === 0) rowClass = 'first-place';
            else if (index === 1) rowClass = 'second-place';
            else if (index === 2) rowClass = 'third-place';
            
            let row = `<tr class="${rowClass}">
                <td>${index + 1}</td>
                <td>${result.userInfo.name}</td>
                <td>${result.userInfo.class}</td>`;
            
            if (showGroup) {
                row += `<td>${result.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'}</td>`;
            }
            
            row += `<td>${result.correctCount || 0}</td>
                <td>${result.wrongCount || 0}</td>
                <td>${result.score || 0}</td>
                <td>${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</td>
            </tr>`;
            
            tbody.innerHTML += row;
        });
    };
    
    displayRankingTable(highschoolResults, 'highschoolRankingBody');
    displayRankingTable(middleschoolResults, 'middleschoolRankingBody');
    displayRankingTable(allResults, 'overallRankingBody', true);
}
        
        // æ›´æ–°ç”¨æˆ·æ’å
        function updateUserRanking(allResults, highschoolResults, middleschoolResults) {
            const userOverallIndex = allResults.findIndex(r => r.userId === currentUser.uid);
            if (userOverallIndex !== -1) {
                document.getElementById('overallRank').textContent = `${userOverallIndex + 1}/${allResults.length}`;
            }
            
            if (userInfo.group === 'highschool') {
                const userGroupIndex = highschoolResults.findIndex(r => r.userId === currentUser.uid);
                if (userGroupIndex !== -1) {
                    document.getElementById('groupRank').textContent = `${userGroupIndex + 1}/${highschoolResults.length}`;
                }
            } else if (userInfo.group === 'middleschool') {
                const userGroupIndex = middleschoolResults.findIndex(r => r.userId === currentUser.uid);
                if (userGroupIndex !== -1) {
                    document.getElementById('groupRank').textContent = `${userGroupIndex + 1}/${middleschoolResults.length}`;
                }
            }
        }

        // åŠ è½½æ¯”èµ›æ•°æ®
        function loadQuizData() {
            const loadingSwal = Swal.fire({
                title: 'åŠ è½½æ¯”èµ›æ•°æ®',
                html: 'æ­£åœ¨è·å–é¢˜ç›®å’Œè®¾ç½®...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            Promise.all([
                database.ref('quiz/settings').once('value'),
                database.ref('questions').once('value')
            ]).then(([settingsSnapshot, questionsSnapshot]) => {
                loadingSwal.close();
                
                if (settingsSnapshot.exists()) {
                    quizData.settings = settingsSnapshot.val();
                    updateQuizSettingsUI();
                } else {
                    quizData.settings = {
                        title: "å®½æŸ”ä¸­å­¦ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›",
                        description: "æµ‹è¯•æ‚¨çš„ç”µè„‘çŸ¥è¯†æ°´å¹³",
                        duration: 60,
                        startTime: null,
                        endTime: null,
                        showResultsImmediately: true,
                        allowRetake: false,
                        enableAntiCheat: true,
                        status: "not_started"
                    };
                    
                    database.ref('quiz/settings').set(quizData.settings);
                }
                
                if (questionsSnapshot.exists()) {
                    quizData.questions = Object.values(questionsSnapshot.val());
                    updateQuestionList();
                } else {
                    quizData.questions = [];
                    document.getElementById('questionListBody').innerHTML = '<tr><td colspan="5" class="text-center">æš‚æ— é¢˜ç›®</td></tr>';
                    
                    if (userInfo && userInfo.isAdmin) {
                        Swal.fire('æç¤º', 'ç³»ç»Ÿä¸­æ²¡æœ‰é¢˜ç›®ï¼Œè¯·å…ˆæ·»åŠ é¢˜ç›®', 'info');
                    }
                }
                
                updateParticipantList();
                updateResultsStatistics();
                updateGlobalStats();
                
            }).catch(error => {
                loadingSwal.close();
                console.error("åŠ è½½æ¯”èµ›æ•°æ®é”™è¯¯:", error);
                Swal.fire('é”™è¯¯', 'åŠ è½½æ¯”èµ›æ•°æ®å¤±è´¥: ' + error.message, 'error');
            });
        }

        // æ›´æ–°å…¨å±€ç»Ÿè®¡
        function updateGlobalStats() {
            database.ref('userAnswers').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const participants = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const participant = childSnapshot.val();
                        if (participant.userInfo) {
                            participants.push(participant);
                        }
                    });
                    
                    const totalParticipants = participants.length;
                    const completedParticipants = participants.filter(p => p.submitted).length;
                    const completionRate = totalParticipants > 0 ? Math.round((completedParticipants / totalParticipants) * 100) : 0;
                    
                    document.getElementById('totalParticipantsCount').textContent = totalParticipants;
                    document.getElementById('completedParticipantsCount').textContent = completedParticipants;
                    document.getElementById('globalProgress').style.width = `${completionRate}%`;
                    
                    // æ›´æ–°ç®¡ç†å‘˜é¢æ¿ç»Ÿè®¡
                    document.getElementById('adminTotalParticipants').textContent = totalParticipants;
                    document.getElementById('adminCompletedParticipants').textContent = completedParticipants;
                }
            }).catch(error => {
                console.error("æ›´æ–°å…¨å±€ç»Ÿè®¡é”™è¯¯:", error);
            });
        }

        // æ›´æ–°æ¯”èµ›è®¾ç½®UI
        function updateQuizSettingsUI() {
    document.getElementById('quizTitle').value = quizData.settings.title || '';
    document.getElementById('quizDescription').value = quizData.settings.description || '';
    document.getElementById('quizDuration').value = quizData.settings.duration || 60;
    
    if (quizData.settings.startTime) {
        document.getElementById('quizStartTime').value = new Date(quizData.settings.startTime).toISOString().slice(0, 16);
    }
    
    if (quizData.settings.endTime) {
        document.getElementById('quizEndTime').value = new Date(quizData.settings.endTime).toISOString().slice(0, 16);
    }
    
    // ç»“æœæ˜¾ç¤ºè®¾ç½®
    document.getElementById('showResultsImmediately').checked = quizData.settings.showResultsImmediately !== false; // é»˜è®¤ä¸ºtrue
    
    // å¦‚æœå·²ç»å­˜åœ¨resultsDelaySectionå…ƒç´ ï¼Œåˆ™æ˜¾ç¤ºå»¶è¿Ÿæ—¶é—´è®¾ç½®
    const resultsDelaySection = document.getElementById('resultsDelaySection');
    if (resultsDelaySection) {
        resultsDelaySection.style.display = quizData.settings.showResultsImmediately ? 'none' : 'block';
        document.getElementById('resultsDelay').value = quizData.settings.resultsDelay || 0;
    }
    
    // é‡æ–°ç­”é¢˜è®¾ç½® - ä½¿ç”¨æ–°çš„retakeModeæˆ–è€…å…¼å®¹æ—§çš„allowRetake
    if (document.getElementById('retakeMode')) {
        // å¦‚æœæœ‰æ–°çš„retakeModeå­—æ®µ
        const retakeMode = quizData.settings.retakeMode || 
                          (quizData.settings.allowRetake ? 'allow_unlimited' : 'disallow');
        document.getElementById('retakeMode').value = retakeMode;
        
        const retakeLimitSection = document.getElementById('retakeLimitSection');
        if (retakeLimitSection) {
            retakeLimitSection.style.display = retakeMode === 'allow_limited' ? 'block' : 'none';
            document.getElementById('retakeLimit').value = quizData.settings.retakeLimit || 3;
        }
    } else {
        // å…¼å®¹æ—§çš„allowRetakeå¤é€‰æ¡†
        document.getElementById('allowRetake').checked = quizData.settings.allowRetake || false;
    }
    
    document.getElementById('enableAntiCheat').checked = quizData.settings.enableAntiCheat || false;
    updateQuizStatusDisplay(quizData.settings.status || 'not_started');
}
        
        // æ›´æ–°æ¯”èµ›çŠ¶æ€æ˜¾ç¤º
        function updateQuizStatusDisplay(status) {
            let statusText = '';
            let statusClass = '';
            
            switch (status) {
                case 'not_started':
                    statusText = 'æœªå¼€å§‹';
                    statusClass = 'info';
                    document.getElementById('startQuizBtn').disabled = false;
                    document.getElementById('pauseQuizBtn').disabled = true;
                    document.getElementById('endQuizBtn').disabled = true;
                    break;
                case 'in_progress':
                    statusText = 'è¿›è¡Œä¸­';
                    statusClass = 'success';
                    document.getElementById('startQuizBtn').disabled = true;
                    document.getElementById('pauseQuizBtn').disabled = false;
                    document.getElementById('endQuizBtn').disabled = false;
                    break;
                case 'paused':
                    statusText = 'å·²æš‚åœ';
                    statusClass = 'warning';
                    document.getElementById('startQuizBtn').disabled = false;
                    document.getElementById('pauseQuizBtn').disabled = true;
                    document.getElementById('endQuizBtn').disabled = false;
                    break;
                case 'ended':
                    statusText = 'å·²ç»“æŸ';
                    statusClass = 'danger';
                    document.getElementById('startQuizBtn').disabled = true;
                    document.getElementById('pauseQuizBtn').disabled = true;
                    document.getElementById('endQuizBtn').disabled = true;
                    break;
            }
            
            const quizStatus = document.getElementById('quizStatus');
            quizStatus.textContent = statusText;
            quizStatus.className = `alert alert-${statusClass}`;
        }
        
        // æ›´æ–°é¢˜ç›®åˆ—è¡¨
        function updateQuestionList() {
            const questionListBody = document.getElementById('questionListBody');
            questionListBody.innerHTML = '';
            
            if (!quizData.questions || quizData.questions.length === 0) {
                questionListBody.innerHTML = '<tr><td colspan="5" class="text-center">æš‚æ— é¢˜ç›®</td></tr>';
                return;
            }
            
            quizData.questions.forEach((question, index) => {
                let typeText = '';
                switch (question.type) {
                    case 'single': typeText = 'å•é€‰'; break;
                    case 'multiple': typeText = 'å¤šé€‰'; break;
                    case 'short_answer': typeText = 'é—®ç­”'; break;
                    case 'essay': typeText = 'ç”³è®º'; break;
                }
                
                let difficultyText = '';
                switch (question.difficulty) {
                    case 'easy': difficultyText = 'ç®€å•'; break;
                    case 'medium': difficultyText = 'ä¸­ç­‰'; break;
                    case 'hard': difficultyText = 'å›°éš¾'; break;
                    default: difficultyText = 'ä¸­ç­‰';
                }
                
                questionListBody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${question.text.length > 50 ? question.text.substring(0, 50) + '...' : question.text}</td>
                        <td>${typeText}</td>
                        <td>${question.points}</td>
                        <td>${difficultyText}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-question me-1" data-id="${question.id}">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger delete-question" data-id="${question.id}">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            document.querySelectorAll('.edit-question').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-id');
                    editQuestion(questionId);
                });
            });
            
            document.querySelectorAll('.delete-question').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-id');
                    deleteQuestion(questionId);
                });
            });
        }
        
        // æ·»åŠ æ–°é¢˜ç›®
        function addNewQuestion() {
            document.getElementById('questionForm').reset();
            document.getElementById('questionId').value = '';
            document.getElementById('optionsContainer').innerHTML = '';
            document.getElementById('correctAnswersContainer').innerHTML = '';
            quill.setContents([]);
            answerQuill.setContents([]);
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.src = '';
            imagePreview.classList.add('d-none');
            currentImageUrl = null;
            
            document.getElementById('optionsSection').style.display = 'block';
            document.getElementById('correctAnswersSection').style.display = 'block';
            document.getElementById('correctAnswerContainer').style.display = 'none';
            
            addOption();
            addOption();
        }
        
        // æ·»åŠ é€‰é¡¹
        // æ·»åŠ é€‰é¡¹
function addOption() {
    const optionIndex = document.getElementById('optionsContainer').children.length;
    const questionType = document.getElementById('questionType').value;
    const isRequired = questionType === 'single' || questionType === 'multiple';
    
    const optionHTML = `
        <div class="input-group mb-2 option-item" data-index="${optionIndex}">
            <span class="input-group-text">${String.fromCharCode(65 + optionIndex)}</span>
            <input type="text" class="form-control option-text" placeholder="é€‰é¡¹å†…å®¹" ${isRequired ? 'required' : ''}>
            <button class="btn btn-outline-danger remove-option" type="button">Ã—</button>
        </div>
    `;
    
    document.getElementById('optionsContainer').insertAdjacentHTML('beforeend', optionHTML);
    
    const removeBtn = document.getElementById('optionsContainer').lastElementChild.querySelector('.remove-option');
    removeBtn.addEventListener('click', function() {
        this.closest('.option-item').remove();
        updateOptionIndexes();
        updateCorrectAnswersUI();
    });
    
    updateCorrectAnswersUI();
}
        
        // æ›´æ–°é€‰é¡¹ç´¢å¼•
        function updateOptionIndexes() {
            const optionItems = document.getElementById('optionsContainer').querySelectorAll('.option-item');
            optionItems.forEach((item, index) => {
                item.setAttribute('data-index', index);
                item.querySelector('.input-group-text').textContent = String.fromCharCode(65 + index);
            });
        }
        
        // æ›´æ–°æ­£ç¡®ç­”æ¡ˆUI
        function updateCorrectAnswersUI() {
            const correctAnswersContainer = document.getElementById('correctAnswersContainer');
            correctAnswersContainer.innerHTML = '';
            const optionCount = document.getElementById('optionsContainer').children.length;
            
            if (optionCount === 0) return;
            
            const questionType = document.getElementById('questionType').value;
            
            if (questionType === 'single') {
                correctAnswersContainer.innerHTML = '<label class="form-label">é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ</label>';
                
                for (let i = 0; i < optionCount; i++) {
                    correctAnswersContainer.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input correct-answer" type="radio" name="correctAnswer" id="correctAnswer${i}" value="${i}">
                            <label class="form-check-label" for="correctAnswer${i}">
                                ${String.fromCharCode(65 + i)}
                            </label>
                        </div>
                    `;
                }
            } else {
                correctAnswersContainer.innerHTML = '<label class="form-label">é€‰æ‹©æ­£ç¡®ç­”æ¡ˆï¼ˆå¯å¤šé€‰ï¼‰</label>';
                
                for (let i = 0; i < optionCount; i++) {
                    correctAnswersContainer.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input correct-answer" type="checkbox" id="correctAnswer${i}" value="${i}">
                            <label class="form-check-label" for="correctAnswer${i}">
                                ${String.fromCharCode(65 + i)}
                            </label>
                        </div>
                    `;
                }
            }
        }
        
        // æ›´æ–°é¢˜ç›®ç±»å‹UI
        // æ›´æ–°é¢˜ç›®ç±»å‹UI
function updateQuestionTypeUI() {
    const type = document.getElementById('questionType').value;
    const optionInputs = document.querySelectorAll('.option-text');
    
    if (type === 'single' || type === 'multiple') {
        document.getElementById('optionsSection').style.display = 'block';
        document.getElementById('correctAnswersSection').style.display = 'block';
        document.getElementById('correctAnswerContainer').style.display = 'none';
        
        // ä¸ºé€‰æ‹©é¢˜çš„é€‰é¡¹æ·»åŠ requiredå±æ€§
        optionInputs.forEach(input => {
            input.setAttribute('required', 'required');
        });
        
        if (document.getElementById('optionsContainer').children.length === 0) {
            addOption();
            addOption();
        }
    } else {
        document.getElementById('optionsSection').style.display = 'none';
        document.getElementById('correctAnswersSection').style.display = 'none';
        document.getElementById('correctAnswerContainer').style.display = 'block';
        
        // ä¸ºéé€‰æ‹©é¢˜çš„é€‰é¡¹ç§»é™¤requiredå±æ€§
        optionInputs.forEach(input => {
            input.removeAttribute('required');
        });
    }
}
        
        // ç¼–è¾‘é¢˜ç›®
        function editQuestion(id) {
            const loadingSwal = Swal.fire({
                title: 'åŠ è½½é¢˜ç›®',
                html: 'æ­£åœ¨è·å–é¢˜ç›®æ•°æ®...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            database.ref('questions/' + id).once('value').then(snapshot => {
                loadingSwal.close();
                
                if (snapshot.exists()) {
                    const q = snapshot.val();

                    document.getElementById('questionForm').reset();
                    document.getElementById('questionId').value = q.id;
                    document.getElementById('questionType').value = q.type;
                    document.getElementById('questionDifficulty').value = q.difficulty || 'medium';
                    document.getElementById('questionPoints').value = q.points;
                    quill.root.innerHTML = q.text;
                    document.getElementById('questionText').value = q.text;
                    
                    if (q.correctAnswerText) {
                        answerQuill.root.innerHTML = q.correctAnswerText;
                        document.getElementById('correctAnswerText').value = q.correctAnswerText;
                    }
                    
                    currentImageUrl = q.imageUrl || '';
                    const imagePreview = document.getElementById('imagePreview');
                    if (currentImageUrl) {
                        imagePreview.src = currentImageUrl;
                        imagePreview.classList.remove('d-none');
                    } else {
                        imagePreview.classList.add('d-none');
                    }

                    updateQuestionTypeUI();

                    document.getElementById('optionsContainer').innerHTML = '';
                    if (q.options && q.options.length > 0) {
                        q.options.forEach((option, index) => {
                            const optionHTML = `
                                <div class="input-group mb-2 option-item" data-index="${index}">
                                    <span class="input-group-text">${String.fromCharCode(65 + index)}</span>
                                    <input type="text" class="form-control option-text" 
                                        value="${option.text || ''}" placeholder="é€‰é¡¹å†…å®¹" required>
                                    <button class="btn btn-outline-danger remove-option" type="button">Ã—</button>
                                </div>
                            `;
                            document.getElementById('optionsContainer').insertAdjacentHTML('beforeend', optionHTML);
                            
                            const removeBtn = document.getElementById('optionsContainer').lastElementChild.querySelector('.remove-option');
                            removeBtn.addEventListener('click', function() {
                                this.closest('.option-item').remove();
                                updateOptionIndexes();
                                updateCorrectAnswersUI();
                            });
                        });
                    } else if (q.type === 'single' || q.type === 'multiple') {
                        addOption();
                        addOption();
                    }

                    updateCorrectAnswersUI();
                    if (q.correctAnswers && q.correctAnswers.length > 0) {
                        q.correctAnswers.forEach(correctIndex => {
                            const input = document.getElementById('correctAnswersContainer').querySelector(`input[value="${correctIndex}"]`);
                            if (input) {
                                input.checked = true;
                            }
                        });
                    }
                } else {
                    Swal.fire('é”™è¯¯', 'é¢˜ç›®ä¸å­˜åœ¨', 'error');
                }
            }).catch(error => {
                loadingSwal.close();
                console.error("ç¼–è¾‘é¢˜ç›®å¤±è´¥ï¼š", error);
                Swal.fire('é”™è¯¯', 'åŠ è½½é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
            });
        }
        
        // å–æ¶ˆç¼–è¾‘
        function cancelEditQuestion() {
            document.getElementById('questionForm').reset();
            document.getElementById('questionId').value = '';
            document.getElementById('optionsContainer').innerHTML = '';
            document.getElementById('correctAnswersContainer').innerHTML = '';
            quill.setContents([]);
            answerQuill.setContents([]);
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.src = '';
            imagePreview.classList.add('d-none');
            currentImageUrl = null;
            
            document.getElementById('optionsSection').style.display = 'block';
            document.getElementById('correctAnswersSection').style.display = 'block';
        }
        
        // ä¿å­˜é¢˜ç›®
function saveQuestion(event) {
    event.preventDefault();

    const id = document.getElementById('questionId').value || database.ref().child('questions').push().key;
    const type = document.getElementById('questionType').value;
    const difficulty = document.getElementById('questionDifficulty').value;
    const points = parseInt(document.getElementById('questionPoints').value);
    const text = quill.root.innerHTML.trim();

    if (!text || text === '<p><br></p>') {
        Swal.fire('é”™è¯¯', 'é¢˜ç›®å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
        return;
    }

    // å¦‚æœæ˜¯é—®ç­”é¢˜æˆ–ç”³è®ºé¢˜ï¼Œä¸´æ—¶ç§»é™¤é€‰é¡¹çš„requiredå±æ€§
    if (type === 'short_answer' || type === 'essay') {
        const optionInputs = document.querySelectorAll('.option-text');
        optionInputs.forEach(input => {
            input.removeAttribute('required');
        });
    }

    let options = [];
    let correctAnswers = [];
    let correctAnswerText = '';

    if (type === 'short_answer' || type === 'essay') {
        correctAnswerText = document.getElementById('correctAnswerText').value.trim();
    } else if (type === 'single' || type === 'multiple') {
        // å¦‚æœæ˜¯é€‰æ‹©é¢˜ï¼Œç¡®ä¿é€‰é¡¹æœ‰requiredå±æ€§
        const optionInputs = document.querySelectorAll('.option-text');
        optionInputs.forEach(input => {
            input.setAttribute('required', 'required');
        });
        
        options = Array.from(document.getElementById('optionsContainer').querySelectorAll('.form-control')).map(input => ({
            text: input.value.trim()
        }));

        if (options.some(opt => !opt.text)) {
            Swal.fire('é”™è¯¯', 'æ‰€æœ‰é€‰é¡¹éƒ½å¿…é¡»å¡«å†™', 'error');
            return;
        }

        const correctInputs = document.getElementById('correctAnswersContainer').querySelectorAll('input[type="checkbox"], input[type="radio"]');
        correctInputs.forEach((input, index) => {
            if (input.checked) correctAnswers.push(index);
        });

        if (correctAnswers.length === 0) {
            Swal.fire('é”™è¯¯', 'è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ', 'error');
            return;
        }
    }

    const questionData = {
        id,
        type,
        difficulty,
        points,
        text,
        imageUrl: currentImageUrl || '',
        options,
        correctAnswers,
        correctAnswerText
    };

    database.ref('questions/' + id).set(questionData)
        .then(() => {
            Swal.fire('æˆåŠŸ', 'é¢˜ç›®å·²ä¿å­˜', 'success');
            clearQuestionForm();
            loadQuizData();
        })
        .catch(error => {
            console.error("ä¿å­˜å¤±è´¥ï¼š", error);
            Swal.fire('é”™è¯¯', 'ä¿å­˜é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
        });
}
        function clearQuestionForm() {
    document.getElementById('questionId').value = '';
    document.getElementById('questionType').value = 'single';
    document.getElementById('questionDifficulty').value = 'medium';
    document.getElementById('questionPoints').value = 5;
    quill.setText('');
    answerQuill.setText('');
    document.getElementById('questionText').value = '';
    document.getElementById('correctAnswerText').value = '';
    currentImageUrl = '';
    const imagePreview = document.getElementById('imagePreview');
    imagePreview.src = '';
    imagePreview.classList.add('d-none');
    document.getElementById('optionsContainer').innerHTML = '';
    document.getElementById('correctAnswersContainer').innerHTML = '';
    updateQuestionTypeUI();
}

        // åˆ é™¤é¢˜ç›®
        function deleteQuestion(id) {
            Swal.fire({
                title: 'ç¡®è®¤åˆ é™¤ï¼Ÿ',
                text: 'åˆ é™¤åå°†æ— æ³•æ¢å¤è¯¥é¢˜ç›®ï¼',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'åˆ é™¤',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    database.ref('questions/' + id).remove().then(() => {
                        Swal.fire('å·²åˆ é™¤', 'é¢˜ç›®å·²æˆåŠŸåˆ é™¤', 'success');
                        loadQuizData();
                    }).catch(error => {
                        console.error("åˆ é™¤é¢˜ç›®å¤±è´¥ï¼š", error);
                        Swal.fire('é”™è¯¯', 'åˆ é™¤é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
                    });
                }
            });
        }

        // å¯¼å…¥é¢˜ç›®
        function importQuestions() {
            Swal.fire({
                title: 'å¯¼å…¥é¢˜ç›®',
                html: `
                    <p>è¯·é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="importJSON">ä»JSONæ–‡ä»¶å¯¼å…¥</button>
                        <button class="btn btn-success" id="importExcel">ä»Excelæ–‡ä»¶å¯¼å…¥</button>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true
            }).then(() => {
                document.getElementById('importJSON').addEventListener('click', () => {
                    Swal.close();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = e => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = event => {
                            try {
                                const questions = JSON.parse(event.target.result);
                                if (Array.isArray(questions)) {
                                    importQuestionsToFirebase(questions);
                                } else {
                                    Swal.fire('é”™è¯¯', 'JSONæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                                }
                            } catch (error) {
                                Swal.fire('é”™è¯¯', 'è§£æJSONæ–‡ä»¶å¤±è´¥', 'error');
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                });

                document.getElementById('importExcel').addEventListener('click', () => {
                    Swal.close();
                    Swal.fire('æç¤º', 'Excelå¯¼å…¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­', 'info');
                });
            });
        }

        function importQuestionsToFirebase(questions) {
            Swal.fire({
                title: 'æ­£åœ¨å¯¼å…¥',
                html: `æ­£åœ¨å¯¼å…¥ ${questions.length} é“é¢˜ç›®...`,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            const promises = questions.map((question, index) => {
                const id = database.ref().child('questions').push().key;
                question.id = id;
                return database.ref('questions/' + id).set(question);
            });

            Promise.all(promises).then(() => {
                Swal.close();
                Swal.fire('æˆåŠŸ', `æˆåŠŸå¯¼å…¥ ${questions.length} é“é¢˜ç›®`, 'success');
                loadQuizData();
            }).catch(error => {
                Swal.close();
                console.error("å¯¼å…¥é¢˜ç›®å¤±è´¥ï¼š", error);
                Swal.fire('é”™è¯¯', 'å¯¼å…¥é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
            });
        }

        // æ›´æ–°å‚èµ›è€…åˆ—è¡¨
        function updateParticipantList() {
            const participantListBody = document.getElementById('participantListBody');
            participantListBody.innerHTML = '';
            
            // è·å–æ‰€æœ‰å‚èµ›è€…æ•°æ®
            database.ref('userAnswers').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const participants = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const participant = childSnapshot.val();
                        if (participant.userInfo) {
                            participants.push({
                                ...participant,
                                userId: childSnapshot.key
                            });
                        }
                    });
                    
                    // è·å–æ‰€æœ‰å‚èµ›è€…çš„è­¦å‘Šæ¬¡æ•°
                    const warningPromises = participants.map(participant => {
                        return database.ref('cheatWarnings/' + participant.userId + '/current').once('value')
                            .then(warningSnapshot => {
                                return {
                                    ...participant,
                                    warningCount: warningSnapshot.exists() ? warningSnapshot.val() : 0
                                };
                            });
                    });
                    
                    Promise.all(warningPromises).then(participantsWithWarnings => {
                        // æŒ‰è­¦å‘Šæ¬¡æ•°é™åºæ’åº
                        participantsWithWarnings.sort((a, b) => b.warningCount - a.warningCount);
                        
                        participantsWithWarnings.forEach(participant => {
                            const answers = Array.isArray(participant.answers) ? participant.answers : [];
                            const questions = Array.isArray(quizData.questions) ? quizData.questions : [];

                            const progressCount = answers.filter(a => {
                                const question = questions.find(q => q.id === a.questionId);
                                if (!question) return false;

                                if (question.type === 'single' || question.type === 'multiple') {
                                    return Array.isArray(a.selectedOptions) && a.selectedOptions.length > 0;
                                } else {
                                    return typeof a.answerText === 'string' && a.answerText.trim() !== '';
                                }
                            }).length;

                            const progress = questions.length > 0 ? Math.round((progressCount / questions.length) * 100) : 0;
                            const status = participant.submitted ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­';
                            
                            // æ ¹æ®è­¦å‘Šæ¬¡æ•°è®¾ç½®å¾½ç« æ ·å¼
                            let warningBadgeClass = 'warning-badge safe';
                            if (participant.warningCount > 2) {
                                warningBadgeClass = 'warning-badge warning';
                            }
                            if (participant.warningCount > 5) {
                                warningBadgeClass = 'warning-badge danger';
                            }

                            participantListBody.innerHTML += `
                                <tr>
                                    <td>${participant.userInfo.name}</td>
                                    <td>${participant.userInfo.class}</td>
                                    <td>${participant.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'}</td>
                                    <td>
                                        <span class="badge ${participant.submitted ? 'bg-success' : 'bg-warning'}">${status}</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">${progress}%</div>
                                        </div>
                                    </td>
                                    <td>${participant.score || 'æœªè¯„åˆ†'}</td>
                                    <td>
                                        <span class="${warningBadgeClass}" title="å½“å‰è­¦å‘Šæ¬¡æ•°">
                                            ${participant.warningCount}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info view-answers me-1" data-id="${participant.userId}">æŸ¥çœ‹è¯¦æƒ…</button>
                                        <button class="btn btn-sm btn-warning view-warnings" data-id="${participant.userId}" title="æŸ¥çœ‹è­¦å‘Šè®°å½•">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        updateMonitorList();
                        
                        // ç»‘å®šæŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶
                        document.querySelectorAll('.view-answers').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const userId = this.getAttribute('data-id');
                                viewParticipantAnswers(userId);
                            });
                        });
                        
                        // ç»‘å®šæŸ¥çœ‹è­¦å‘Šè®°å½•æŒ‰é’®äº‹ä»¶
                        document.querySelectorAll('.view-warnings').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const userId = this.getAttribute('data-id');
                                viewParticipantWarnings(userId);
                            });
                        });
                        
                    }).catch(error => {
                        console.error("è·å–è­¦å‘Šæ¬¡æ•°é”™è¯¯:", error);
                    });
                }
            }).catch(error => {
                console.error("è·å–å‚èµ›è€…åˆ—è¡¨é”™è¯¯:", error);
            });
        }

        // æ›´æ–°ç›‘æ§åˆ—è¡¨
        function updateMonitorList() {
            database.ref('userAnswers').once('value').then(snapshot => {
                const monitorList = document.getElementById('participantMonitorList');
                monitorList.innerHTML = '';
                
                if (snapshot.exists()) {
                    const participants = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const participant = childSnapshot.val();
                        if (participant.userInfo) {
                            participants.push({
                                ...participant,
                                userId: childSnapshot.key
                            });
                        }
                    });
                    
                    // è·å–è­¦å‘Šæ¬¡æ•°
                    const warningPromises = participants.map(participant => {
                        return database.ref('cheatWarnings/' + participant.userId + '/current').once('value')
                            .then(warningSnapshot => {
                                return {
                                    ...participant,
                                    warningCount: warningSnapshot.exists() ? warningSnapshot.val() : 0
                                };
                            });
                    });
                    
                    Promise.all(warningPromises).then(participantsWithWarnings => {
                        participantsWithWarnings.sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
                        
                        participantsWithWarnings.forEach(participant => {
                            const progress = calculateProgress(participant);
                            const isActive = participant.userId === currentMonitoringUserId;
                            
                            // æ ¹æ®è­¦å‘Šæ¬¡æ•°è®¾ç½®å¾½ç« æ ·å¼
                            let warningBadgeClass = 'warning-badge safe';
                            if (participant.warningCount > 2) {
                                warningBadgeClass = 'warning-badge warning';
                            }
                            if (participant.warningCount > 5) {
                                warningBadgeClass = 'warning-badge danger';
                            }

                            const item = document.createElement('button');
                            item.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${isActive ? 'active' : ''}`;
                            item.innerHTML = `
                                <div>
                                    <strong>${participant.userInfo.name}</strong>
                                    <div class="text-muted small">
                                        ${participant.userInfo.class} - 
                                        ${participant.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'}
                                    </div>
                                </div>
                                <div>
                                    <span class="${warningBadgeClass}" style="margin-right: 8px;" title="è­¦å‘Šæ¬¡æ•°">
                                        ${participant.warningCount}
                                    </span>
                                    <span class="badge ${participant.submitted ? 'bg-success' : 'bg-warning'} rounded-pill">
                                        ${participant.submitted ? 'å·²å®Œæˆ' : progress}%
                                    </span>
                                </div>
                            `;
                            
                            item.addEventListener('click', () => {
                                currentMonitoringUserId = participant.userId;
                                updateMonitorList();
                                monitorParticipant(participant.userId);
                            });
                            
                            monitorList.appendChild(item);
                        });
                    });
                } else {
                    monitorList.innerHTML = '<div class="list-group-item text-muted">æš‚æ— å‚èµ›è€…æ•°æ®</div>';
                }
            }).catch(error => {
                console.error("æ›´æ–°ç›‘æ§åˆ—è¡¨é”™è¯¯:", error);
            });
        }

        // è®¡ç®—è¿›åº¦
        function calculateProgress(participant) {
            if (!participant.answers || !quizData.questions) return 0;
            
            const answeredCount = participant.answers.filter(answer => {
                const question = quizData.questions.find(q => q.id === answer.questionId);
                if (!question) return false;
                
                if (question.type === 'single' || question.type === 'multiple') {
                    return answer.selectedOptions && answer.selectedOptions.length > 0;
                } else {
                    return answer.answerText && answer.answerText.trim() !== '';
                }
            }).length;
            
            return Math.round((answeredCount / quizData.questions.length) * 100);
        }

        // ç›‘æ§å‚èµ›è€…
        function monitorParticipant(userId) {
    const monitorView = document.getElementById('participantMonitorView');
    
    monitorView.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p>åŠ è½½ä¸­...</p></div>';
    
    // è·å–å‚èµ›è€…åŸºæœ¬ä¿¡æ¯å’Œè­¦å‘Šæ¬¡æ•°
    Promise.all([
        database.ref(`userAnswers/${userId}`).once('value'),
        database.ref(`cheatWarnings/${userId}`).once('value')
    ]).then(([participantSnapshot, warningsSnapshot]) => {
        if (participantSnapshot.exists()) {
            const participant = participantSnapshot.val();
            const warningsData = warningsSnapshot.exists() ? warningsSnapshot.val() : { current: 0 };
            
            // æ¸²æŸ“è§†å›¾
            monitorView.innerHTML = renderParticipantMonitorView(participant, warningsData);
            
            // ============ æ·»åŠ äº‹ä»¶ç»‘å®š ============
            // ç»‘å®šæŸ¥çœ‹è­¦å‘Šè®°å½•æŒ‰é’®
            const viewWarningsBtn = monitorView.querySelector('.view-warnings-btn');
            if (viewWarningsBtn) {
                viewWarningsBtn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    viewParticipantWarnings(userId);
                });
            }
            
            // ç»‘å®šå…¶ä»–å¯èƒ½éœ€è¦çš„æŒ‰é’®
            const viewAnswersBtn = monitorView.querySelector('.view-answers-btn');
            if (viewAnswersBtn) {
                viewAnswersBtn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    viewParticipantAnswers(userId);
                });
            }
            // ============ äº‹ä»¶ç»‘å®šç»“æŸ ============
            
        } else {
            monitorView.innerHTML = '<div class="alert alert-warning">æœªæ‰¾åˆ°å‚èµ›è€…æ•°æ®</div>';
        }
    }).catch(error => {
        console.error("ç›‘æ§å‚èµ›è€…é”™è¯¯:", error);
        monitorView.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥: ${error.message}</div>`;
    });
}

        // æ¸²æŸ“å‚èµ›è€…ç›‘æ§è§†å›¾
        // ä¿®æ”¹ renderParticipantMonitorView å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°
function renderParticipantMonitorView(participant, warningsData = {}) {
    // æ·»åŠ é»˜è®¤å€¼ï¼Œé˜²æ­¢ warningsData æœªå®šä¹‰
    const warningCount = warningsData.current || 0;
    const warningHistory = warningsData.history ? Object.values(warningsData.history) : [];
    
    let warningBadgeClass = 'badge bg-success';
    if (warningCount > 2) {
        warningBadgeClass = 'badge bg-warning';
    }
    if (warningCount > 5) {
        warningBadgeClass = 'badge bg-danger';
    }
    
    let html = `
        <div class="participant-header mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h4>${participant.userInfo.name} çš„ç­”é¢˜æƒ…å†µ</h4>
                <div>
                    <span class="badge ${participant.submitted ? 'bg-success' : 'bg-primary'} me-2">
                        ${participant.submitted ? 'å·²æäº¤' : 'ç­”é¢˜ä¸­'}
                    </span>
                    <span class="${warningBadgeClass}" title="è­¦å‘Šæ¬¡æ•°">
                        è­¦å‘Š: ${warningCount}æ¬¡
                    </span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-2">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">ç­çº§</small>
                            <div>${participant.userInfo.class}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">ç»„åˆ«</small>
                            <div>${participant.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">è¿›åº¦</small>
                            <div>${calculateProgress(participant)}%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">å¾—åˆ†</small>
                            <div>${participant.score || 'æœªè¯„åˆ†'}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card ${warningCount > 0 ? 'border-warning' : 'border-light'}">
                        <div class="card-body py-2">
                            <small class="text-muted">é˜²ä½œå¼Šç›‘æ§</small>
                            <div>
                                <button class="btn btn-sm btn-warning view-warnings-btn" data-user-id="${participant.userId}">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    æŸ¥çœ‹è­¦å‘Šè®°å½• (${warningCount}æ¬¡)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="questions-container">
    `;
    
    // ç¡®ä¿ quizData.questions å­˜åœ¨
    const questions = quizData.questions || [];
    
    if (questions.length === 0) {
        html += '<div class="alert alert-info">æš‚æ— é¢˜ç›®æ•°æ®</div>';
    } else {
        questions.forEach((question, index) => {
            const answer = participant.answers?.find(a => a.questionId === question.id) || {};
            
            html += `
                <div class="question-card mb-4 p-3 border rounded">
                    <div class="question-header d-flex justify-content-between align-items-center mb-2">
                        <h5>é¢˜ç›® ${index + 1} (${question.points || 0}åˆ†)</h5>
                        <span class="badge ${answer.isCorrect ? 'bg-success' : answer.isCorrect === false ? 'bg-danger' : 'bg-secondary'}">
                            ${answer.isCorrect ? 'æ­£ç¡®' : answer.isCorrect === false ? 'é”™è¯¯' : 'æœªä½œç­”'}
                        </span>
                    </div>
                    <div class="question-content">${question.text || 'æ— é¢˜ç›®å†…å®¹'}</div>
            `;
            
            if (question.imageUrl) {
                html += `
                    <div class="text-center my-3">
                        <img src="${question.imageUrl}" class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                `;
            }
            
            if (question.type === 'single' || question.type === 'multiple') {
                html += `<div class="options-list mt-3">`;
                
                const options = question.options || [];
                options.forEach((option, i) => {
                    const isSelected = answer.selectedOptions?.includes(i) || false;
                    const isCorrect = question.correctAnswers?.includes(i) || false;
                    
                    let optionClass = '';
                    if (isCorrect && isSelected) optionClass = 'correct';
                    else if (isCorrect) optionClass = 'missed';
                    else if (isSelected) optionClass = 'incorrect';
                    
                    html += `
                        <div class="option-item ${optionClass}">
                            ${String.fromCharCode(65 + i)}. ${option.text || `é€‰é¡¹ ${i+1}`}
                            ${isSelected ? '<span class="float-end">âœ“</span>' : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                html += `
                    <div class="mt-3">
                        <h6>å‚èµ›è€…ç­”æ¡ˆï¼š</h6>
                        <div class="p-3 bg-light rounded">
                            ${answer.answerText || '<span class="text-muted">æœªä½œç­”</span>'}
                        </div>
                    </div>
                `;
                
                if (question.correctAnswerText) {
                    html += `
                        <div class="mt-3">
                            <h6>å‚è€ƒç­”æ¡ˆï¼š</h6>
                            <div class="p-3 bg-light rounded">
                                ${question.correctAnswerText}
                            </div>
                        </div>
                    `;
                }
            }
            
            html += `</div>`;
        });
    }
    
    html += `</div>`;
    
    return html;
}

        // ä¿®æ”¹ viewParticipantWarnings() å‡½æ•°ï¼Œé˜²æ­¢æ¨¡æ€æ¡†å†²çª
function viewParticipantWarnings(userId) {
    showLoading('åŠ è½½è­¦å‘Šè®°å½•...');
    
    // é¦–å…ˆç¡®ä¿å…¨å±è¦†ç›–å±‚æ˜¯éšè—çš„
    document.getElementById('fullscreenOverlay').classList.add('d-none');
    
    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œè­¦å‘Šè®°å½•
    Promise.all([
        database.ref(`userAnswers/${userId}/userInfo`).once('value'),
        database.ref(`cheatWarnings/${userId}`).once('value')
    ]).then(([userInfoSnapshot, warningsSnapshot]) => {
        hideLoading();
        
        if (!userInfoSnapshot.exists()) {
            Swal.fire('é”™è¯¯', 'æ‰¾ä¸åˆ°è¯¥å‚èµ›è€…ä¿¡æ¯', 'error');
            return;
        }
        
        const userInfo = userInfoSnapshot.val();
        const warningsData = warningsSnapshot.exists() ? warningsSnapshot.val() : { current: 0 };
        
        // åˆ›å»ºè­¦å‘Šè®°å½•HTMLå†…å®¹
        const warningHTML = generateWarningHTML(userInfo, warningsData);
        
        // ä½¿ç”¨ SweetAlert2 æ˜¾ç¤ºï¼Œé¿å…ä¸ç°æœ‰æ¨¡æ€æ¡†å†²çª
        Swal.fire({
            title: `${userInfo.name} - ä½œå¼Šè­¦å‘Šè®°å½•`,
            html: warningHTML,
            width: '900px',
            showCloseButton: true,
            showConfirmButton: false,
            didOpen: () => {
                // ç»‘å®šé‡ç½®è­¦å‘ŠæŒ‰é’®äº‹ä»¶
                const resetBtn = document.querySelector('.reset-warnings-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        resetParticipantWarnings(userId, userInfo.name);
                        Swal.close();
                    });
                }
            }
        });
        
    }).catch(error => {
        hideLoading();
        console.error("åŠ è½½è­¦å‘Šè®°å½•é”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'åŠ è½½è­¦å‘Šè®°å½•å¤±è´¥: ' + error.message, 'error');
    });
}

// æ–°å¢è¾…åŠ©å‡½æ•°ï¼Œç”Ÿæˆè­¦å‘Šè®°å½•HTML
function generateWarningHTML(userInfo, warningsData) {
    const currentWarnings = warningsData.current || 0;
    const warningHistory = warningsData.history ? Object.values(warningsData.history) : [];
    
    warningHistory.sort((a, b) => b.timestamp - a.timestamp);
    
    let html = `
        <div class="warning-details">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5>è­¦å‘Šè®°å½•è¯¦æƒ…</h5>
                <span class="badge ${currentWarnings === 0 ? 'bg-success' : currentWarnings > 5 ? 'bg-danger' : 'bg-warning'}">
                    å½“å‰è­¦å‘Šæ¬¡æ•°: ${currentWarnings}
                </span>
            </div>
            <div class="mb-4">
                <p><strong>å§“å:</strong> ${userInfo.name || 'æœªçŸ¥'}</p>
                <p><strong>ç­çº§:</strong> ${userInfo.class || 'æœªçŸ¥'}</p>
                <p><strong>ç»„åˆ«:</strong> ${userInfo.group === 'highschool' ? 'é«˜ä¸­ç»„' : 'åˆä¸­ç»„'}</p>
            </div>
    `;
    
    if (warningHistory.length > 0) {
        html += `
            <h6 class="mb-3">è­¦å‘Šå†å²è®°å½•</h6>
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>åŸå› </th>
                            <th>è­¦å‘Šæ¬¡æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        warningHistory.forEach(record => {
            const time = new Date(record.timestamp).toLocaleString('zh-CN');
            html += `
                <tr>
                    <td>${time}</td>
                    <td>${record.reason || 'æœªçŸ¥åŸå› '}</td>
                    <td>${record.warningCount || 0}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-warning reset-warnings-btn" 
                        data-user-id="${userInfo.uid}">
                    <i class="fas fa-redo me-1"></i>é‡ç½®è­¦å‘Šæ¬¡æ•°
                </button>
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                æš‚æ— è­¦å‘Šå†å²è®°å½•
            </div>
        `;
    }
    
    html += `</div>`;
    return html;
}
        
        // æ–°å¢ï¼šæŸ¥çœ‹æ‰€æœ‰å‚èµ›è€…è­¦å‘Šè®°å½•
        function viewAllWarnings() {
            showLoading('æ­£åœ¨åŠ è½½æ‰€æœ‰å‚èµ›è€…è­¦å‘Šè®°å½•...');
            
            // è·å–æ‰€æœ‰ç”¨æˆ·å’Œä»–ä»¬çš„è­¦å‘Šæ¬¡æ•°
            Promise.all([
                database.ref('userAnswers').once('value'),
                database.ref('cheatWarnings').once('value')
            ]).then(([usersSnapshot, warningsSnapshot]) => {
                hideLoading();
                
                const users = [];
                const warnings = warningsSnapshot.exists() ? warningsSnapshot.val() : {};
                
                if (usersSnapshot.exists()) {
                    usersSnapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        if (user.userInfo) {
                            users.push({
                                ...user,
                                userId: childSnapshot.key
                            });
                        }
                    });
                }
                
                // ä¸ºæ¯ä¸ªç”¨æˆ·æ·»åŠ è­¦å‘Šæ¬¡æ•°
                const usersWithWarnings = users.map(user => {
                    const userWarnings = warnings[user.userId] || { current: 0 };
                    return {
                        ...user,
                        warningCount: userWarnings.current || 0
                    };
                });
                
                // æŒ‰è­¦å‘Šæ¬¡æ•°é™åºæ’åº
                usersWithWarnings.sort((a, b) => b.warningCount - a.warningCount);
                
                let warningsHTML = `
                    <div class="all-warnings-details">
                        <h5 class="mb-4">æ‰€æœ‰å‚èµ›è€…è­¦å‘Šè®°å½•</h5>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            å…± ${usersWithWarnings.length} åå‚èµ›è€…ï¼Œå…¶ä¸­ ${usersWithWarnings.filter(u => u.warningCount > 0).length} åæœ‰è­¦å‘Šè®°å½•
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>æ’å</th>
                                        <th>å§“å</th>
                                        <th>ç­çº§</th>
                                        <th>ç»„åˆ«</th>
                                        <th>çŠ¶æ€</th>
                                        <th>è­¦å‘Šæ¬¡æ•°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                usersWithWarnings.forEach((user, index) => {
                    const status = user.submitted ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­';
                    let warningBadgeClass = 'badge bg-success';
                    if (user.warningCount > 2) {
                        warningBadgeClass = 'badge bg-warning';
                    }
                    if (user.warningCount > 5) {
                        warningBadgeClass = 'badge bg-danger';
                    }
                    
                    warningsHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${user.userInfo.name}</td>
                            <td>${user.userInfo.class}</td>
                            <td>${user.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'}</td>
                            <td>
                                <span class="badge ${status === 'å·²å®Œæˆ' ? 'bg-success' : 'bg-warning'}">
                                    ${status}
                                </span>
                            </td>
                            <td>
                                <span class="${warningBadgeClass}">
                                    ${user.warningCount}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning view-user-warnings" 
                                        data-user-id="${user.userId}">
                                    <i class="fas fa-exclamation-triangle"></i> æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                warningsHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // æ˜¾ç¤ºåœ¨æ¨¡æ€æ¡†ä¸­
                const warningDetailsModal = new bootstrap.Modal(document.getElementById('warningDetailsModal'));
                document.getElementById('warningDetailsContent').innerHTML = warningsHTML;
                warningDetailsModal.show();
                
                // ç»‘å®šæŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.view-user-warnings').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        warningDetailsModal.hide();
                        viewParticipantWarnings(userId);
                    });
                });
                
            }).catch(error => {
                hideLoading();
                console.error("åŠ è½½æ‰€æœ‰è­¦å‘Šè®°å½•é”™è¯¯:", error);
                Swal.fire('é”™è¯¯', 'åŠ è½½è­¦å‘Šè®°å½•å¤±è´¥: ' + error.message, 'error');
            });
        }
        
        // æ–°å¢ï¼šé‡ç½®å‚èµ›è€…è­¦å‘Šæ¬¡æ•°
        function resetParticipantWarnings(userId, userName) {
            Swal.fire({
                title: 'ç¡®è®¤é‡ç½®è­¦å‘Šæ¬¡æ•°ï¼Ÿ',
                html: `ç¡®å®šè¦é‡ç½® <strong>${userName}</strong> çš„è­¦å‘Šæ¬¡æ•°å—ï¼Ÿ<br>
                       æ­¤æ“ä½œä¼šå°†å½“å‰è­¦å‘Šæ¬¡æ•°é‡ç½®ä¸º0ï¼Œä½†ä¿ç•™å†å²è®°å½•ã€‚`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'é‡ç½®',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#ffc107'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading('æ­£åœ¨é‡ç½®è­¦å‘Šæ¬¡æ•°...');
                    
                    const resetData = {
                        current: 0,
                        lastReset: new Date().getTime(),
                        resetBy: userInfo.name || 'ç®¡ç†å‘˜',
                        resetReason: 'æ‰‹åŠ¨é‡ç½®'
                    };
                    
                    database.ref('cheatWarnings/' + userId).update(resetData)
                        .then(() => {
                            hideLoading();
                            Swal.fire('æˆåŠŸ', 'å·²é‡ç½®è­¦å‘Šæ¬¡æ•°', 'success');
                            
                            // æ›´æ–°åˆ—è¡¨
                            updateParticipantList();
                            updateMonitorList();
                            
                            // å…³é—­æ¨¡æ€æ¡†
                            bootstrap.Modal.getInstance(document.getElementById('warningDetailsModal')).hide();
                        })
                        .catch(error => {
                            hideLoading();
                            console.error("é‡ç½®è­¦å‘Šæ¬¡æ•°é”™è¯¯:", error);
                            Swal.fire('é”™è¯¯', 'é‡ç½®å¤±è´¥: ' + error.message, 'error');
                        });
                }
            });
        }

        // åˆ·æ–°ç›‘æ§
        function refreshMonitor() {
            updateMonitorList();
            if (currentMonitoringUserId) {
                monitorParticipant(currentMonitoringUserId);
            }
            Swal.fire('å·²åˆ·æ–°', 'ç›‘æ§æ•°æ®å·²æ›´æ–°', 'success');
        }

        // æŸ¥çœ‹å‚èµ›è€…ç­”æ¡ˆ
        function viewParticipantAnswers(userId) {
            showLoading('åŠ è½½å‚èµ›è€…ç­”é¢˜è¯¦æƒ…...');
            
            Promise.all([
                database.ref('userAnswers/' + userId).once('value'),
                database.ref('questions').once('value')
            ]).then(([participantSnapshot, questionsSnapshot]) => {
                if (!participantSnapshot.exists()) {
                    throw new Error('æ‰¾ä¸åˆ°å‚èµ›è€…æ•°æ®');
                }

                if (!questionsSnapshot.exists()) {
                    throw new Error('æ‰¾ä¸åˆ°é¢˜ç›®æ•°æ®');
                }

                const rawQuestions = questionsSnapshot.val() || {};
                const questions = {};
                Object.keys(rawQuestions).forEach(id => {
                    questions[id] = { id, ...rawQuestions[id] };
                });

                const participantData = participantSnapshot.val();
                const answers = participantData.answers || [];
                const isAdmin = userInfo && userInfo.isAdmin;

                if (!participantData.userInfo) {
                    throw new Error('å‚èµ›è€…ä¿¡æ¯ä¸å®Œæ•´');
                }

                let answersHTML = `
                    <div class="participant-header mb-4">
                        <h4>${participantData.userInfo.name} çš„ç­”é¢˜è¯¦æƒ…</h4>
                        <div class="participant-meta">
                            <span class="badge bg-primary">ç­çº§: ${participantData.userInfo.class || 'æœªçŸ¥'}</span>
                            <span class="badge bg-secondary">ç»„åˆ«: ${participantData.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'}</span>
                            <span class="badge bg-success">å¾—åˆ†: ${participantData.score || 0}</span>
                            <span class="badge bg-info">æ­£ç¡®: ${participantData.correctCount || 0}</span>
                            <span class="badge bg-warning">é”™è¯¯: ${participantData.wrongCount || 0}</span>
                        </div>
                    </div>
                    <hr>
                    <div class="questions-container">
                `;

                Object.values(questions).forEach((question, index) => {
                    if (!question.id) return;
                    
                    const userAnswer = answers.find(a => a.questionId === question.id) || { 
                        selectedOptions: [], 
                        answerText: '', 
                        isCorrect: null,
                        score: 0
                    };

                    const questionType = question.type || 'single';
                    const questionPoints = question.points || 0;
                    const questionText = question.text || 'é¢˜ç›®å†…å®¹ç¼ºå¤±';
                    
                    const questionScore = (questionType === 'short_answer' || questionType === 'essay') ?
                        (userAnswer.score !== undefined ? userAnswer.score : 'æœªè¯„åˆ†') :
                        (userAnswer.isCorrect ? questionPoints : 0);
                    
                    answersHTML += `
                        <div class="question-card mb-4 p-3 border rounded">
                            <div class="question-header d-flex justify-content-between align-items-center mb-2">
                                <h5>é¢˜ç›® ${index + 1} (${questionPoints}åˆ†)</h5>
                                <span class="badge ${userAnswer.isCorrect ? 'bg-success' : userAnswer.isCorrect === false ? 'bg-danger' : 'bg-secondary'}">
                                    ${userAnswer.isCorrect ? 'æ­£ç¡®' : userAnswer.isCorrect === false ? 'é”™è¯¯' : 'æœªä½œç­”'}
                                    ${questionType !== 'short_answer' && questionType !== 'essay' ? 
                                    `: ${questionScore}/${questionPoints}åˆ†` : 
                                    `: ${questionScore}${typeof questionScore === 'number' ? `/${questionPoints}åˆ†` : ''}`}
                                </span>
                            </div>
                            <div class="question-content">${questionText}</div>
                    `;

                    if (question.imageUrl) {
                        answersHTML += `
                            <div class="text-center my-3">
                                <img src="${question.imageUrl}" class="img-fluid rounded" style="max-height: 200px;">
                            </div>
                        `;
                    }

                    if (questionType === 'single' || questionType === 'multiple') {
                        answersHTML += `<div class="options-list mt-3">`;
                        
                        const options = question.options || [];
                        const correctAnswers = question.correctAnswers || [];
                        
                        options.forEach((option, i) => {
                            const optionText = option.text || `é€‰é¡¹ ${i+1}`;
                            const isSelected = Array.isArray(userAnswer.selectedOptions) && userAnswer.selectedOptions.includes(i);
                            const isCorrectOption = correctAnswers.includes(i);
                            
                            let optionClass = '';
                            if (isCorrectOption) {
                                optionClass = 'correct';
                            } else if (isSelected) {
                                optionClass = 'incorrect';
                            }
                            
                            answersHTML += `
                                <div class="option-item ${optionClass}">
                                    ${String.fromCharCode(65 + i)}. ${optionText}
                                    ${isSelected ? '<span class="float-end">âœ“</span>' : ''}
                                </div>
                            `;
                        });
                        
                        answersHTML += `</div>`;
                        
                        if (userAnswer.isCorrect === false && correctAnswers.length > 0) {
                            answersHTML += `
                                <div class="mt-2 text-success">
                                    <strong>æ­£ç¡®ç­”æ¡ˆ:</strong> 
                                    ${correctAnswers.map(a => String.fromCharCode(65 + a)).join(', ')}
                                </div>
                            `;
                        }
                    } else {
                        answersHTML += `
                            <div class="mt-3">
                                <h6>å‚èµ›è€…ç­”æ¡ˆï¼š</h6>
                                <div class="p-3 bg-light rounded">
                                    ${userAnswer.answerText || '<span class="text-muted">æœªä½œç­”</span>'}
                                </div>
                            </div>
                        `;
                        
                        if (question.correctAnswerText) {
                            answersHTML += `
                                <div class="mt-3">
                                    <h6>å‚è€ƒç­”æ¡ˆï¼š</h6>
                                    <div class="p-3 bg-light rounded">
                                        ${question.correctAnswerText}
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (isAdmin) {
                            answersHTML += `
                                <div class="mt-3">
                                    <label class="form-label">è¯„åˆ† (æ»¡åˆ† ${questionPoints} åˆ†)</label>
                                    <input type="number" class="form-control score-input" 
                                           min="0" max="${questionPoints}" 
                                           value="${userAnswer.score !== undefined ? userAnswer.score : ''}" 
                                           data-question-id="${question.id}"
                                           ${participantData.submitted ? '' : 'disabled'}
                                           placeholder="è¯·è¾“å…¥åˆ†æ•°">
                                </div>
                            `;
                        }
                    }
                    
                    answersHTML += `</div>`;
                });

                answersHTML += `</div>`;

                if (isAdmin && participantData.submitted) {
                    answersHTML += `
                        <div class="text-center mt-4">
                            <button class="btn btn-primary save-scores">ä¿å­˜è¯„åˆ†</button>
                        </div>
                    `;
                }

                hideLoading();

                Swal.fire({
                    title: `${participantData.userInfo.name} çš„ç­”é¢˜è¯¦æƒ…`,
                    html: answersHTML,
                    width: '800px',
                    didOpen: () => {
                        const saveBtn = document.querySelector('.save-scores');
                        if (saveBtn) {
                            saveBtn.addEventListener('click', () => {
                                saveParticipantScores(userId, questions, participantData);
                            });
                        }
                    }
                });

            }).catch(error => {
                hideLoading();
                console.error("æŸ¥çœ‹å‚èµ›è€…ç­”æ¡ˆé”™è¯¯:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'åŠ è½½å¤±è´¥',
                    text: error.message,
                    footer: 'è¯·æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨æˆ–è”ç³»ç®¡ç†å‘˜'
                });
            });
        }

        // ä¿å­˜å‚èµ›è€…åˆ†æ•°
        function saveParticipantScores(userId, questions, participantData) {
            console.log("å¼€å§‹ä¿å­˜è¯„åˆ†...");
            
            const scoreInputs = document.querySelectorAll('input[data-question-id]');
            console.log("æ‰¾åˆ°çš„æ‰“åˆ†è¾“å…¥æ¡†æ•°é‡:", scoreInputs.length);
            
            if (scoreInputs.length === 0) {
                Swal.fire('é”™è¯¯', 'æœªæ‰¾åˆ°è¯„åˆ†è¾“å…¥æ¡†ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }

            showLoading('æ­£åœ¨ä¿å­˜è¯„åˆ†...');

            const updates = {};
            let hasError = false;
            let totalScore = 0;

            const allQuestions = Object.values(questions);
            const originalAnswers = participantData.answers || [];
            
            allQuestions.forEach(question => {
                if (question.type === 'single' || question.type === 'multiple') {
                    const answerIndex = originalAnswers.findIndex(a => a.questionId === question.id);
                    if (answerIndex !== -1) {
                        const userAnswer = originalAnswers[answerIndex];
                        let questionScore = 0;
                        
                        if (userAnswer.isCorrect) {
                            questionScore = question.points;
                        }
                        
                        updates[`userAnswers/${userId}/answers/${answerIndex}/score`] = questionScore;
                        totalScore += questionScore;
                        
                        console.log(`é€‰æ‹©é¢˜ ${question.id} åˆ†æ•°: ${questionScore}`);
                    }
                }
            });

            scoreInputs.forEach(input => {
                const questionId = input.dataset.questionId;
                console.log("å¤„ç†é¢˜ç›®:", questionId, "å€¼:", input.value);
                
                const question = allQuestions.find(q => q.id === questionId);
                const score = input.value.trim() === '' ? 0 : parseInt(input.value);

                if (!question) {
                    console.warn("æœªæ‰¾åˆ°å¯¹åº”é¢˜ç›®:", questionId);
                    return;
                }

                if (isNaN(score)) {
                    console.warn("æ— æ•ˆåˆ†æ•°:", input.value);
                    return;
                }

                if (score < 0 || score > question.points) {
                    hasError = true;
                    input.classList.add('is-invalid');
                    console.error("åˆ†æ•°è¶…å‡ºèŒƒå›´:", score, "èŒƒå›´: 0 -", question.points);
                } else {
                    input.classList.remove('is-invalid');
                    const answerIndex = originalAnswers.findIndex(a => a.questionId === questionId);
                    if (answerIndex !== -1) {
                        updates[`userAnswers/${userId}/answers/${answerIndex}/score`] = score;
                        updates[`userAnswers/${userId}/answers/${answerIndex}/isCorrect`] = (score === question.points);
                        updates[`userAnswers/${userId}/answers/${answerIndex}/isGraded`] = true;
                        
                        totalScore += score;
                        
                        console.log("æ›´æ–°é¢˜ç›®è¯„åˆ†:", questionId, "åˆ†æ•°:", score, "æ€»åˆ†ç´¯è®¡:", totalScore);
                    } else {
                        console.warn("æœªæ‰¾åˆ°å¯¹åº”ç­”æ¡ˆ:", questionId);
                    }
                }
            });

            if (hasError) {
                hideLoading();
                Swal.fire('é”™è¯¯', 'éƒ¨åˆ†åˆ†æ•°è¶…å‡ºå…è®¸èŒƒå›´ï¼ˆè¯·æ£€æŸ¥çº¢æ¡†å¤„ï¼‰', 'error');
                return;
            }

            let correctCount = 0;
            let wrongCount = 0;
            let unansweredCount = 0;

            allQuestions.forEach(question => {
                const answerIndex = originalAnswers.findIndex(a => a.questionId === question.id);
                if (answerIndex === -1) {
                    unansweredCount++;
                    return;
                }
                
                const answer = originalAnswers[answerIndex];
                let questionScore = answer.score || 0;
                
                if (question.type === 'single' || question.type === 'multiple') {
                    if (answer.isCorrect) {
                        questionScore = question.points;
                        correctCount++;
                    } else if (answer.selectedOptions && answer.selectedOptions.length > 0) {
                        wrongCount++;
                    } else {
                        unansweredCount++;
                    }
                } else {
                    if (questionScore === question.points) {
                        correctCount++;
                    } else if (questionScore > 0) {
                        wrongCount++;
                    } else {
                        unansweredCount++;
                    }
                }
            });

            console.log("æœ€ç»ˆç»Ÿè®¡ - æ­£ç¡®:", correctCount, "é”™è¯¯:", wrongCount, "æœªç­”:", unansweredCount, "æ€»åˆ†:", totalScore);

            updates[`userAnswers/${userId}/score`] = totalScore;
            updates[`userAnswers/${userId}/finalScore`] = totalScore;
            updates[`userAnswers/${userId}/totalScore`] = totalScore;
            updates[`userAnswers/${userId}/correctCount`] = correctCount;
            updates[`userAnswers/${userId}/wrongCount`] = wrongCount;
            updates[`userAnswers/${userId}/unansweredCount`] = unansweredCount;

            if (participantData.startTime) {
                updates[`userAnswers/${userId}/startTime`] = participantData.startTime;
            }
            if (participantData.endTime) {
                updates[`userAnswers/${userId}/endTime`] = participantData.endTime;
            }

            updates[`userAnswers/${userId}/submitted`] = true;
            updates[`userAnswers/${userId}/lastUpdated`] = firebase.database.ServerValue.TIMESTAMP;

            console.log("æœ€ç»ˆæ›´æ–°æ•°æ®:", updates);

            database.ref().update(updates)
                .then(() => {
                    hideLoading();
                    console.log("è¯„åˆ†ä¿å­˜æˆåŠŸ");
                    
                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'è¯„åˆ†å·²ä¿å­˜',
                        html: `æ€»åˆ†: ${totalScore}<br>
                               æ­£ç¡®: ${correctCount}é¢˜<br>
                               é”™è¯¯: ${wrongCount}é¢˜<br>
                               æœªç­”: ${unansweredCount}é¢˜`,
                        showConfirmButton: true,
                        timer: 3000
                    }).then(() => {
                        viewParticipantAnswers(userId);
                        setTimeout(() => {
                            updateResultsStatistics();
                            updateParticipantList();
                        }, 1000);
                    });
                })
                .catch(error => {
                    hideLoading();
                    console.error("ä¿å­˜è¯„åˆ†é”™è¯¯:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'ä¿å­˜å¤±è´¥',
                        text: 'é”™è¯¯: ' + error.message,
                        footer: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'
                    });
                });
        }

        // æ›´æ–°æˆç»©ç»Ÿè®¡
        function updateResultsStatistics() {
    const avgEl = document.getElementById("adminAverageScore");
    const highEl = document.getElementById("adminHighestScore");
    const avgAccuracyBar = document.getElementById("avgAccuracyBar");
    const avgAccuracyText = document.getElementById("avgAccuracyText");
    const avgTimeUsed = document.getElementById("avgTimeUsed");
    const fastestSubmit = document.getElementById("fastestSubmit");

    database.ref('userAnswers')
        .orderByChild('submitted')
        .equalTo(true)
        .once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const results = [];
                const allResults = []; // ä¿å­˜å®Œæ•´ç»“æœç”¨äºè¡¨æ ¼æ˜¾ç¤º
                let totalScore = 0;
                let maxScore = 0;
                let totalTime = 0;
                let minTime = Infinity;
                let totalQuestions = 0;
                let totalCorrect = 0;

                snapshot.forEach(childSnapshot => {
                    const result = childSnapshot.val();
                    result.userId = childSnapshot.key; // ä¿å­˜ç”¨æˆ·ID
                    
                    let score = result.finalScore || result.score || result.totalScore || 0;
                    
                    console.log("ç”¨æˆ·æˆç»©:", result.userInfo?.name, "åˆ†æ•°:", score);
                    
                    results.push(score);
                    allResults.push(result); // ä¿å­˜å®Œæ•´ç»“æœ
                    totalScore += score;
                    if (score > maxScore) maxScore = score;
                    
                    if (result.endTime && result.startTime) {
                        const timeUsed = result.endTime - result.startTime;
                        totalTime += timeUsed;
                        if (timeUsed < minTime) minTime = timeUsed;
                    }
                    
                    if (result.correctCount && quizData.questions.length > 0) {
                        totalQuestions += quizData.questions.length;
                        totalCorrect += result.correctCount;
                    }
                });

                const average = results.length > 0 ? Math.round(totalScore / results.length) : 0;
                const avgTime = results.length > 0 ? Math.floor(totalTime / results.length / 1000) : 0;
                const fastestTime = minTime !== Infinity ? Math.floor(minTime / 1000) : 0;
                const avgAccuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
                
                console.log("ç»Ÿè®¡ç»“æœ - å¹³å‡åˆ†:", average, "æœ€é«˜åˆ†:", maxScore, "äººæ•°:", results.length);

                avgEl.textContent = average;
                highEl.textContent = maxScore;
                
                avgAccuracyBar.style.width = `${avgAccuracy}%`;
                avgAccuracyText.textContent = `${avgAccuracy}%`;
                
                const avgMinutes = Math.floor(avgTime / 60);
                const avgSeconds = avgTime % 60;
                avgTimeUsed.textContent = `${avgMinutes}åˆ†${avgSeconds}ç§’`;
                
                const fastMinutes = Math.floor(fastestTime / 60);
                const fastSeconds = fastestTime % 60;
                fastestSubmit.textContent = `${fastMinutes}åˆ†${fastSeconds}ç§’`;
                
                updateScoreDistribution(results);
                
                // ============ æ–°å¢ï¼šæ›´æ–°è¯¦ç»†æˆç»©è¡¨æ ¼ ============
                updateDetailedResultsTable(allResults);
                
            } else {
                console.log("æ— æˆç»©æ•°æ®");
                avgEl.textContent = 0;
                highEl.textContent = 0;
                avgAccuracyBar.style.width = '0%';
                avgAccuracyText.textContent = '0%';
                avgTimeUsed.textContent = '0åˆ†0ç§’';
                fastestSubmit.textContent = '0åˆ†0ç§’';
                
                // ============ æ–°å¢ï¼šæ˜¾ç¤ºç©ºè¡¨æ ¼ ============
                const detailedResultsBody = document.getElementById('detailedResultsBody');
                if (detailedResultsBody) {
                    detailedResultsBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4 text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                æš‚æ— æˆç»©æ•°æ®
                            </td>
                        </tr>
                    `;
                }
            }
        })
        .catch(error => {
            console.error("è·å–æˆç»©ç»Ÿè®¡é”™è¯¯:", error);
            avgEl.textContent = 'é”™è¯¯';
            highEl.textContent = 'é”™è¯¯';
            
            // ============ æ–°å¢ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ ============
            const detailedResultsBody = document.getElementById('detailedResultsBody');
            if (detailedResultsBody) {
                detailedResultsBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            åŠ è½½å¤±è´¥: ${error.message}
                        </td>
                    </tr>
                `;
            }
        });
}
        function updateDetailedResultsTable(results) {
    const detailedResultsBody = document.getElementById('detailedResultsBody');
    
    if (!detailedResultsBody) {
        console.error("æ‰¾ä¸åˆ°è¯¦ç»†æˆç»©è¡¨æ ¼å…ƒç´ ");
        return;
    }
    
    // æ¸…ç©ºè¡¨æ ¼
    detailedResultsBody.innerHTML = '';
    
    if (!results || results.length === 0) {
        detailedResultsBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4 text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    æš‚æ— æˆç»©æ•°æ®
                </td>
            </tr>
        `;
        return;
    }
    
    console.log(`æ›´æ–°è¯¦ç»†æˆç»©è¡¨æ ¼ï¼Œå…± ${results.length} æ¡è®°å½•`);
    
    // æŒ‰åˆ†æ•°æ’åºï¼ˆé™åºï¼‰
    results.sort((a, b) => {
        const scoreA = a.finalScore || a.score || a.totalScore || 0;
        const scoreB = b.finalScore || b.score || b.totalScore || 0;
        return scoreB - scoreA; // é™åºæ’åˆ—
    });
    
    // æ¸²æŸ“æ¯ä¸€è¡Œ
    results.forEach((result, index) => {
        const userInfo = result.userInfo || {};
        const score = result.finalScore || result.score || result.totalScore || 0;
        const correctCount = result.correctCount || 0;
        const wrongCount = result.wrongCount || 0;
        
        // è®¡ç®—ç”¨æ—¶
        let timeUsed = "0:00";
        if (result.startTime && result.endTime) {
            const seconds = Math.floor((result.endTime - result.startTime) / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timeUsed = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        const row = document.createElement('tr');
        
        // è®¾ç½®å‰ä¸‰åçš„ç‰¹æ®Šæ ·å¼
        if (index === 0) row.classList.add('first-place');
        else if (index === 1) row.classList.add('second-place');
        else if (index === 2) row.classList.add('third-place');
        
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${userInfo.name || 'æœªçŸ¥'}</td>
            <td>${userInfo.class || 'æœªçŸ¥'}</td>
            <td>${userInfo.group === 'highschool' ? 'é«˜ä¸­ç»„' : (userInfo.group === 'middleschool' ? 'åˆä¸­ç»„' : 'æœªçŸ¥')}</td>
            <td>${correctCount}</td>
            <td>${wrongCount}</td>
            <td><strong>${score}</strong></td>
            <td>${timeUsed}</td>
            <td>
                <button class="btn btn-sm btn-info view-participant-answers" 
                        data-user-id="${result.userId || ''}">
                    <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è¯¦æƒ…
                </button>
            </td>
        `;
        
        detailedResultsBody.appendChild(row);
    });
    
    // é‡æ–°ç»‘å®šæŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶
    bindViewAnswersButtons();
}

// ============ æ–°å¢ï¼šç»‘å®šæŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶ ============
function bindViewAnswersButtons() {
    // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
    document.querySelectorAll('.view-participant-answers').forEach(btn => {
        btn.removeEventListener('click', handleViewAnswers);
    });
    
    // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
    document.querySelectorAll('.view-participant-answers').forEach(btn => {
        btn.addEventListener('click', handleViewAnswers);
    });
}

// ============ æ–°å¢ï¼šå¤„ç†æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ç‚¹å‡» ============
function handleViewAnswers(event) {
    const userId = event.currentTarget.getAttribute('data-user-id');
    if (userId) {
        viewParticipantAnswers(userId);
    }
}

        // åœ¨init()å‡½æ•°ä¸­ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
function bindAwardEventListeners() {
    // æ™‹çº§è®¾ç½®è¡¨å•
    document.getElementById('awardSettingsForm')?.addEventListener('submit', saveAwardSettings);
    
    // å¿«é€Ÿæ“ä½œæŒ‰é’®
    document.getElementById('autoGenerateAwardsBtn')?.addEventListener('click', autoGenerateAwards);
    document.getElementById('clearAwardsBtn')?.addEventListener('click', clearAwards);
    document.getElementById('exportAwardsBtn')?.addEventListener('click', exportAwards);
    document.getElementById('importAwardsBtn')?.addEventListener('click', importAwards);
    document.getElementById('addAwardBtn')?.addEventListener('click', showAddAwardModal);
    document.getElementById('saveAwardBtn')?.addEventListener('click', saveAward);
    
    // æ™‹çº§æ¨¡å¼åˆ‡æ¢
    document.getElementById('awardMode')?.addEventListener('change', updateAwardModeUI);
}

// æ›´æ–°æ™‹çº§æ¨¡å¼UI
function updateAwardModeUI() {
    const awardModeElement = document.getElementById('awardMode');
    const autoSettings = document.getElementById('autoSettings');
    
    // æ·»åŠ ç©ºå€¼æ£€æŸ¥
    if (!awardModeElement || !autoSettings) {
        console.warn('æ™‹çº§ç®¡ç†ç›¸å…³å…ƒç´ å°šæœªåŠ è½½');
        return;
    }
    
    const mode = awardModeElement.value;
    
    if (mode === 'auto' || mode === 'mixed') {
        autoSettings.style.display = 'block';
    } else {
        autoSettings.style.display = 'none';
    }
}

// ä¿å­˜æ™‹çº§è®¾ç½®
function saveAwardSettings(e) {
    e.preventDefault();
    
    const settings = {
        mode: document.getElementById('awardMode').value,
        highschoolQualifyCount: parseInt(document.getElementById('highschoolQualifyCount').value),
        middleschoolQualifyCount: parseInt(document.getElementById('middleschoolQualifyCount').value),
        minimumScore: parseInt(document.getElementById('minimumScore').value),
        qualifyPercentage: parseInt(document.getElementById('qualifyPercentage').value),
        highschoolFirstPrize: document.getElementById('highschoolFirstPrize').value,
        middleschoolFirstPrize: document.getElementById('middleschoolFirstPrize').value,
        lastUpdated: new Date().getTime()
    };
    
    database.ref('awardSettings').set(settings)
        .then(() => {
            Swal.fire('æˆåŠŸ', 'æ™‹çº§è®¾ç½®å·²ä¿å­˜', 'success');
        })
        .catch(error => {
            console.error("ä¿å­˜æ™‹çº§è®¾ç½®é”™è¯¯:", error);
            Swal.fire('é”™è¯¯', 'ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        });
}

// è‡ªåŠ¨ç”Ÿæˆæ™‹çº§åå•
function autoGenerateAwards() {
    Swal.fire({
        title: 'è‡ªåŠ¨ç”Ÿæˆæ™‹çº§åå•',
        html: 'ç¡®å®šè¦æ ¹æ®å½“å‰æˆç»©è‡ªåŠ¨ç”Ÿæˆæ™‹çº§åå•å—ï¼Ÿ',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading('æ­£åœ¨ç”Ÿæˆæ™‹çº§åå•...');
            
            // è·å–æ‰€æœ‰å·²æäº¤çš„æˆç»©
            database.ref('userAnswers')
                .orderByChild('submitted')
                .equalTo(true)
                .once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        hideLoading();
                        Swal.fire('æç¤º', 'æ²¡æœ‰æ‰¾åˆ°å·²æäº¤çš„æˆç»©æ•°æ®', 'info');
                        return;
                    }
                    
                    const allResults = [];
                    snapshot.forEach(childSnapshot => {
                        const result = childSnapshot.val();
                        if (result.userInfo && result.score !== undefined) {
                            allResults.push({
                                ...result,
                                userId: childSnapshot.key
                            });
                        }
                    });
                    
                    // åˆ†ç»„
                    const highschoolResults = allResults.filter(r => r.userInfo.group === 'highschool');
                    const middleschoolResults = allResults.filter(r => r.userInfo.group === 'middleschool');
                    
                    // æ’åº
                    highschoolResults.sort((a, b) => b.score - a.score || (a.endTime - a.startTime) - (b.endTime - b.startTime));
                    middleschoolResults.sort((a, b) => b.score - a.score || (a.endTime - a.startTime) - (b.endTime - b.startTime));
                    
                    // è·å–è®¾ç½®
                    database.ref('awardSettings').once('value').then(settingsSnapshot => {
                        const settings = settingsSnapshot.exists() ? settingsSnapshot.val() : {
                            highschoolQualifyCount: 10,
                            middleschoolQualifyCount: 10,
                            minimumScore: 60
                        };
                        
                        const awards = [];
                        let awardId = 1;
                        
                        // ç”Ÿæˆé«˜ä¸­ç»„è·å¥–åå•
                        const hsCount = Math.min(settings.highschoolQualifyCount, highschoolResults.length);
                        for (let i = 0; i < hsCount; i++) {
                            const result = highschoolResults[i];
                            if (result.score >= (settings.minimumScore || 0)) {
                                awards.push({
                                    id: `award-${awardId++}`,
                                    name: result.userInfo.name,
                                    class: result.userInfo.class,
                                    studentId: result.userInfo.studentId || '',
                                    group: 'highschool',
                                    award: i === 0 ? 'å† å†›' : i === 1 ? 'äºšå†›' : i === 2 ? 'å­£å†›' : 'æ™‹çº§',
                                    score: result.score,
                                    rank: i + 1,
                                    timestamp: new Date().getTime()
                                });
                            }
                        }
                        
                        // ç”Ÿæˆåˆä¸­ç»„è·å¥–åå•
                        const msCount = Math.min(settings.middleschoolQualifyCount, middleschoolResults.length);
                        for (let i = 0; i < msCount; i++) {
                            const result = middleschoolResults[i];
                            if (result.score >= (settings.minimumScore || 0)) {
                                awards.push({
                                    id: `award-${awardId++}`,
                                    name: result.userInfo.name,
                                    class: result.userInfo.class,
                                    studentId: result.userInfo.studentId || '',
                                    group: 'middleschool',
                                    award: i === 0 ? 'å† å†›' : i === 1 ? 'äºšå†›' : i === 2 ? 'å­£å†›' : 'æ™‹çº§',
                                    score: result.score,
                                    rank: i + 1,
                                    timestamp: new Date().getTime()
                                });
                            }
                        }
                        
                        // ä¿å­˜åˆ°æ•°æ®åº“
                        const updates = {};
                        awards.forEach(award => {
                            updates[`awards/${award.id}`] = award;
                        });
                        
                        database.ref().update(updates)
                            .then(() => {
                                hideLoading();
                                Swal.fire('æˆåŠŸ', `å·²ç”Ÿæˆ ${awards.length} åæ™‹çº§/è·å¥–è€…åå•`, 'success');
                                loadAwardsList();
                            })
                            .catch(error => {
                                hideLoading();
                                console.error("ä¿å­˜æ™‹çº§åå•é”™è¯¯:", error);
                                Swal.fire('é”™è¯¯', 'ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                            });
                    });
                })
                .catch(error => {
                    hideLoading();
                    console.error("è·å–æˆç»©æ•°æ®é”™è¯¯:", error);
                    Swal.fire('é”™è¯¯', 'è·å–æˆç»©æ•°æ®å¤±è´¥: ' + error.message, 'error');
                });
        }
    });
}

// åŠ è½½æ™‹çº§åå•
function loadAwardsList() {
    const awardsListBody = document.getElementById('awardsListBody');
    if (!awardsListBody) return;
    
    awardsListBody.innerHTML = '<tr><td colspan="10" class="text-center"><div class="spinner-border"></div></td></tr>';
    
    database.ref('awards').once('value').then(snapshot => {
        awardsListBody.innerHTML = '';
        
        if (!snapshot.exists()) {
            awardsListBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">æš‚æ— æ™‹çº§/è·å¥–æ•°æ®</td></tr>';
            
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('totalAwardsCount').textContent = '0';
            document.getElementById('todayAwardsCount').textContent = '0';
            return;
        }
        
        const awards = [];
        let todayCount = 0;
        const today = new Date().toDateString();
        
        snapshot.forEach(childSnapshot => {
            const award = childSnapshot.val();
            awards.push(award);
            
            // ç»Ÿè®¡ä»Šæ—¥æ–°å¢
            const awardDate = new Date(award.timestamp).toDateString();
            if (awardDate === today) {
                todayCount++;
            }
        });
        
        // æŒ‰ç»„åˆ«å’Œæ’åæ’åº
        awards.sort((a, b) => {
            if (a.group !== b.group) return a.group.localeCompare(b.group);
            if (a.award !== b.award) {
                const awardOrder = { 'å† å†›': 1, 'äºšå†›': 2, 'å­£å†›': 3, 'æ™‹çº§': 4, 'ä¼˜ç§€å¥–': 5, 'å‚ä¸å¥–': 6 };
                return (awardOrder[a.award] || 7) - (awardOrder[b.award] || 7);
            }
            return (a.rank || 999) - (b.rank || 999);
        });
        
        // æ˜¾ç¤ºåˆ—è¡¨
        awards.forEach((award, index) => {
            const row = document.createElement('tr');
            
            // è®¾ç½®ä¸åŒå¥–é¡¹çš„é¢œè‰²
            let awardClass = '';
            switch(award.award) {
                case 'å† å†›': awardClass = 'table-success'; break;
                case 'äºšå†›': awardClass = 'table-info'; break;
                case 'å­£å†›': awardClass = 'table-warning'; break;
                case 'æ™‹çº§': awardClass = ''; break;
                default: awardClass = 'table-light';
            }
            
            row.className = awardClass;
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${award.name}</strong></td>
                <td>${award.class}</td>
                <td>${award.studentId || ''}</td>
                <td>${award.group === 'highschool' ? 'é«˜ä¸­ç»„' : 'åˆä¸­ç»„'}</td>
                <td>
                    <span class="badge ${getAwardBadgeClass(award.award)}">
                        ${award.award}
                    </span>
                </td>
                <td>${award.score || '-'}</td>
                <td>${award.rank || '-'}</td>
                <td>${award.note || ''}</td>
                <td>
                    <button class="btn btn-sm btn-primary edit-award me-1" data-id="${award.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-award" data-id="${award.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            awardsListBody.appendChild(row);
        });
        
        // æ›´æ–°ç»Ÿè®¡
        document.getElementById('totalAwardsCount').textContent = awards.length;
        document.getElementById('todayAwardsCount').textContent = todayCount;
        
        // ç»‘å®šæ“ä½œæŒ‰é’®äº‹ä»¶
        bindAwardActionButtons();
        
    }).catch(error => {
        console.error("åŠ è½½æ™‹çº§åå•é”™è¯¯:", error);
        awardsListBody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
    });
}

// è·å–å¥–é¡¹å¾½ç« æ ·å¼
function getAwardBadgeClass(award) {
    switch(award) {
        case 'å† å†›': return 'bg-success';
        case 'äºšå†›': return 'bg-info';
        case 'å­£å†›': return 'bg-warning';
        case 'æ™‹çº§': return 'bg-primary';
        case 'ä¼˜ç§€å¥–': return 'bg-secondary';
        default: return 'bg-light text-dark';
    }
}

// ç»‘å®šæ™‹çº§æ“ä½œæŒ‰é’®äº‹ä»¶
function bindAwardActionButtons() {
    document.querySelectorAll('.edit-award').forEach(btn => {
        btn.addEventListener('click', function() {
            const awardId = this.getAttribute('data-id');
            editAward(awardId);
        });
    });
    
    document.querySelectorAll('.delete-award').forEach(btn => {
        btn.addEventListener('click', function() {
            const awardId = this.getAttribute('data-id');
            deleteAward(awardId);
        });
    });
}

// æ˜¾ç¤ºæ·»åŠ è·å¥–è€…æ¨¡æ€æ¡†
function showAddAwardModal() {
    document.getElementById('awardForm').reset();
    document.getElementById('awardId').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('awardModal'));
    modal.show();
}

// ç¼–è¾‘è·å¥–è€…
function editAward(awardId) {
    showLoading('åŠ è½½è·å¥–è€…ä¿¡æ¯...');
    
    database.ref('awards/' + awardId).once('value').then(snapshot => {
        hideLoading();
        
        if (snapshot.exists()) {
            const award = snapshot.val();
            
            document.getElementById('awardForm').reset();
            document.getElementById('awardId').value = award.id;
            document.getElementById('awardName').value = award.name || '';
            document.getElementById('awardClass').value = award.class || '';
            document.getElementById('awardStudentId').value = award.studentId || '';
            document.getElementById('awardGroup').value = award.group || '';
            document.getElementById('awardType').value = award.awardType || award.award || '';
            document.getElementById('awardScore').value = award.score || '';
            document.getElementById('awardRank').value = award.rank || '';
            document.getElementById('awardNote').value = award.note || '';
            
            const modal = new bootstrap.Modal(document.getElementById('awardModal'));
            modal.show();
        } else {
            Swal.fire('é”™è¯¯', 'æ‰¾ä¸åˆ°è¯¥è·å¥–è€…ä¿¡æ¯', 'error');
        }
    }).catch(error => {
        hideLoading();
        console.error("åŠ è½½è·å¥–è€…ä¿¡æ¯é”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'åŠ è½½å¤±è´¥: ' + error.message, 'error');
    });
}

// ä¿å­˜è·å¥–è€…
function saveAward() {
    const awardId = document.getElementById('awardId').value || database.ref().child('awards').push().key;
    const awardType = document.getElementById('awardType').value;
    
    const awardData = {
        id: awardId,
        name: document.getElementById('awardName').value.trim(),
        class: document.getElementById('awardClass').value.trim(),
        studentId: document.getElementById('awardStudentId').value.trim(),
        group: document.getElementById('awardGroup').value,
        award: document.getElementById('awardType').value,
        awardType: document.getElementById('awardType').value,
        score: document.getElementById('awardScore').value ? parseInt(document.getElementById('awardScore').value) : null,
        rank: document.getElementById('awardRank').value ? parseInt(document.getElementById('awardRank').value) : null,
        note: document.getElementById('awardNote').value.trim(),
        timestamp: new Date().getTime()
    };
    
    if (!awardData.name || !awardData.class || !awardData.group || !awardData.award) {
        Swal.fire('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
        return;
    }
    
    database.ref('awards/' + awardId).set(awardData)
        .then(() => {
            bootstrap.Modal.getInstance(document.getElementById('awardModal')).hide();
            Swal.fire('æˆåŠŸ', 'è·å¥–è€…ä¿¡æ¯å·²ä¿å­˜', 'success');
            loadAwardsList();
        })
        .catch(error => {
            console.error("ä¿å­˜è·å¥–è€…ä¿¡æ¯é”™è¯¯:", error);
            Swal.fire('é”™è¯¯', 'ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        });
}

// åˆ é™¤è·å¥–è€…
function deleteAward(awardId) {
    Swal.fire({
        title: 'ç¡®è®¤åˆ é™¤ï¼Ÿ',
        text: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè·å¥–è€…è®°å½•å—ï¼Ÿ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'åˆ é™¤',
        cancelButtonText: 'å–æ¶ˆ'
    }).then((result) => {
        if (result.isConfirmed) {
            database.ref('awards/' + awardId).remove()
                .then(() => {
                    Swal.fire('å·²åˆ é™¤', 'è·å¥–è€…è®°å½•å·²åˆ é™¤', 'success');
                    loadAwardsList();
                })
                .catch(error => {
                    console.error("åˆ é™¤è·å¥–è€…é”™è¯¯:", error);
                    Swal.fire('é”™è¯¯', 'åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                });
        }
    });
}

// æ¸…ç©ºæ™‹çº§åå•
function clearAwards() {
    Swal.fire({
        title: 'ç¡®è®¤æ¸…ç©ºï¼Ÿ',
        text: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ™‹çº§/è·å¥–åå•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'æ¸…ç©º',
        cancelButtonText: 'å–æ¶ˆ',
        confirmButtonColor: '#dc3545'
    }).then((result) => {
        if (result.isConfirmed) {
            database.ref('awards').remove()
                .then(() => {
                    Swal.fire('å·²æ¸…ç©º', 'æ™‹çº§åå•å·²æ¸…ç©º', 'success');
                    loadAwardsList();
                })
                .catch(error => {
                    console.error("æ¸…ç©ºæ™‹çº§åå•é”™è¯¯:", error);
                    Swal.fire('é”™è¯¯', 'æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
                });
        }
    });
}

// å¯¼å‡ºæ™‹çº§åå•
function exportAwards() {
    database.ref('awards').once('value').then(snapshot => {
        if (!snapshot.exists()) {
            Swal.fire('æç¤º', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ™‹çº§åå•', 'info');
            return;
        }
        
        const awards = [];
        snapshot.forEach(childSnapshot => {
            awards.push(childSnapshot.val());
        });
        
        // åˆ›å»ºCSV
        let csv = 'åºå·,å§“å,ç­çº§,å­¦å·,ç»„åˆ«,å¥–é¡¹,å¾—åˆ†,æ’å,å¤‡æ³¨\n';
        
        awards.forEach((award, index) => {
            csv += `${index + 1},${award.name},${award.class},${award.studentId || ''},`;
            csv += `${award.group === 'highschool' ? 'é«˜ä¸­ç»„' : 'åˆä¸­ç»„'},`;
            csv += `${award.award},${award.score || ''},${award.rank || ''},${award.note || ''}\n`;
        });
        
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        saveAs(blob, `æ™‹çº§åå•_${new Date().toISOString().slice(0, 10)}.csv`);
        
    }).catch(error => {
        console.error("å¯¼å‡ºæ™‹çº§åå•é”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
    });
}

// å¯¼å…¥æ™‹çº§åå•
function importAwards() {
    Swal.fire({
        title: 'å¯¼å…¥æ™‹çº§åå•',
        html: `
            <p>è¯·é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š</p>
            <div class="d-grid gap-2">
                <button class="btn btn-primary" id="importAwardsCSV">ä»CSVæ–‡ä»¶å¯¼å…¥</button>
                <button class="btn btn-success" id="importAwardsJSON">ä»JSONæ–‡ä»¶å¯¼å…¥</button>
            </div>
        `,
        showConfirmButton: false,
        showCloseButton: true
    }).then(() => {
        document.getElementById('importAwardsCSV').addEventListener('click', () => {
            Swal.close();
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const csvData = event.target.result;
                        parseAndImportAwardsCSV(csvData);
                    } catch (error) {
                        Swal.fire('é”™è¯¯', 'è§£æCSVæ–‡ä»¶å¤±è´¥', 'error');
                    }
                };
                reader.readAsText(file, 'UTF-8');
            };
            input.click();
        });
    });
}

// è§£æå¹¶å¯¼å…¥CSV
function parseAndImportAwardsCSV(csvData) {
    showLoading('æ­£åœ¨è§£æå¹¶å¯¼å…¥æ•°æ®...');
    
    const lines = csvData.split('\n');
    const awards = [];
    let awardId = 1;
    
    // è·³è¿‡æ ‡é¢˜è¡Œ
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const columns = line.split(',');
        if (columns.length >= 8) {
            const award = {
                id: `imported-${Date.now()}-${awardId++}`,
                name: columns[1]?.trim() || '',
                class: columns[2]?.trim() || '',
                studentId: columns[3]?.trim() || '',
                group: columns[4]?.includes('é«˜ä¸­') ? 'highschool' : 'middleschool',
                award: columns[5]?.trim() || 'æ™‹çº§',
                score: columns[6] ? parseInt(columns[6]) : null,
                rank: columns[7] ? parseInt(columns[7]) : null,
                note: columns[8]?.trim() || '',
                timestamp: new Date().getTime()
            };
            
            if (award.name && award.class) {
                awards.push(award);
            }
        }
    }
    
    if (awards.length === 0) {
        hideLoading();
        Swal.fire('é”™è¯¯', 'CSVæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ™‹çº§æ•°æ®', 'error');
        return;
    }
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    const updates = {};
    awards.forEach(award => {
        updates[`awards/${award.id}`] = award;
    });
    
    database.ref().update(updates)
        .then(() => {
            hideLoading();
            Swal.fire('æˆåŠŸ', `æˆåŠŸå¯¼å…¥ ${awards.length} æ¡æ™‹çº§è®°å½•`, 'success');
            loadAwardsList();
        })
        .catch(error => {
            hideLoading();
            console.error("å¯¼å…¥æ™‹çº§åå•é”™è¯¯:", error);
            Swal.fire('é”™è¯¯', 'å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
        });
}

// æ›´æ–°æŸ¥è¯¢ç»“æœåŠŸèƒ½ï¼Œä½¿å…¶èƒ½å¤Ÿæ­£ç¡®æŸ¥è¯¢æ™‹çº§çŠ¶æ€
function checkResult(e) {
    e.preventDefault();
    
    const name = document.getElementById('checkName').value.trim();
    const className = document.getElementById('checkClass').value.trim();
    const studentId = document.getElementById('checkStudentId').value.trim();
    
    if (!name || !className || !studentId) {
        Swal.fire('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰æŸ¥è¯¢ä¿¡æ¯', 'error');
        return;
    }
    
    showLoading('æŸ¥è¯¢ä¸­...');
    
    // é¦–å…ˆæŸ¥è¯¢è·å¥–/æ™‹çº§åå•
    database.ref('awards').once('value').then(awardsSnapshot => {
        let foundAward = null;
        
        if (awardsSnapshot.exists()) {
            awardsSnapshot.forEach(childSnapshot => {
                const award = childSnapshot.val();
                if (award.name === name && award.class === className && award.studentId === studentId) {
                    foundAward = award;
                }
            });
        }
        
        // å¦‚æœæ‰¾åˆ°è·å¥–è®°å½•
        if (foundAward) {
            hideLoading();
            
            const resultContainer = document.getElementById('resultCheckContainer');
            const successDiv = document.getElementById('resultCheckSuccess');
            const infoDiv = document.getElementById('resultCheckInfo');
            const detailsP = document.getElementById('resultCheckDetails');
            const messageP = document.getElementById('resultCheckMessage');
            
            resultContainer.classList.remove('d-none');
            successDiv.style.display = 'block';
            infoDiv.style.display = 'none';
            
            let details = `<strong>æ­å–œï¼æ‚¨å·²${foundAward.award}</strong><br>`;
            details += `å§“å: ${foundAward.name}<br>`;
            details += `ç­çº§: ${foundAward.class}<br>`;
            details += `ç»„åˆ«: ${foundAward.group === 'highschool' ? 'é«˜ä¸­ç»„' : 'åˆä¸­ç»„'}<br>`;
            details += `å¥–é¡¹: ${foundAward.award}<br>`;
            if (foundAward.score) details += `å¾—åˆ†: ${foundAward.score}<br>`;
            if (foundAward.rank) details += `æ’å: ç¬¬${foundAward.rank}å<br>`;
            if (foundAward.note) details += `å¤‡æ³¨: ${foundAward.note}<br>`;
            
            detailsP.innerHTML = details;
            
        } else {
            // å¦‚æœæ²¡æœ‰è·å¥–è®°å½•ï¼ŒæŸ¥è¯¢æ™®é€šæˆç»©
            database.ref('userAnswers').once('value').then(snapshot => {
                hideLoading();
                
                const resultContainer = document.getElementById('resultCheckContainer');
                const successDiv = document.getElementById('resultCheckSuccess');
                const infoDiv = document.getElementById('resultCheckInfo');
                const detailsP = document.getElementById('resultCheckDetails');
                const messageP = document.getElementById('resultCheckMessage');
                
                resultContainer.classList.remove('d-none');
                successDiv.style.display = 'none';
                infoDiv.style.display = 'block';
                
                let foundResult = null;
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const result = childSnapshot.val();
                        if (result.userInfo && 
                            result.userInfo.name === name && 
                            result.userInfo.class === className && 
                            result.userInfo.studentId === studentId) {
                            foundResult = result;
                        }
                    });
                }
                
                if (foundResult && foundResult.submitted) {
                    messageP.innerHTML = `
                        æŸ¥è¯¢åˆ°æ‚¨çš„æ¯”èµ›æˆç»©ï¼š<br>
                        <strong>å¾—åˆ†: ${foundResult.score || 0}</strong><br>
                        æ­£ç¡®é¢˜æ•°: ${foundResult.correctCount || 0}<br>
                        é”™è¯¯é¢˜æ•°: ${foundResult.wrongCount || 0}<br>
                        æœªç­”é¢˜æ•°: ${foundResult.unansweredCount || 0}`;
                } else {
                    messageP.textContent = 'æ²¡æœ‰æ‰¾åˆ°æ‚¨çš„æ¯”èµ›è®°å½•ã€‚';
                }
            });
        }
        
    }).catch(error => {
        hideLoading();
        console.error("æŸ¥è¯¢ç»“æœé”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'æŸ¥è¯¢ç»“æœå¤±è´¥: ' + error.message, 'error');
    });
}

        // æ›´æ–°æˆç»©åˆ†å¸ƒ
        function updateScoreDistribution(results) {
            const scoreDistribution = document.getElementById('scoreDistribution');
            scoreDistribution.innerHTML = '';
            
            if (results.length === 0) return;
            
            const maxScore = Math.max(...results);
            const scoreRanges = [
                { label: '0-59', min: 0, max: 59 },
                { label: '60-69', min: 60, max: 69 },
                { label: '70-79', min: 70, max: 79 },
                { label: '80-89', min: 80, max: 89 },
                { label: '90-100', min: 90, max: 100 }
            ];
            
            const counts = scoreRanges.map(range => 
                results.filter(score => score >= range.min && score <= range.max).length
            );
            
            const maxCount = Math.max(...counts);
            
            scoreRanges.forEach((range, index) => {
                const count = counts[index];
                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                
                const bar = document.createElement('div');
                bar.className = 'distribution-bar';
                bar.style.height = `${percentage}%`;
                bar.title = `${range.label}åˆ†: ${count}äºº`;
                
                const label = document.createElement('div');
                label.className = 'distribution-label';
                label.textContent = range.label;
                
                bar.appendChild(label);
                scoreDistribution.appendChild(bar);
            });
        }

        // ä¿å­˜æ¯”èµ›è®¾ç½®
        // ä¿å­˜æ¯”èµ›è®¾ç½®
function saveQuizSettings(e) {
    e.preventDefault();
    
    // è·å–æ–°çš„é‡è¯•æ¨¡å¼è®¾ç½®
    let retakeMode, retakeLimit;
    if (document.getElementById('retakeMode')) {
        retakeMode = document.getElementById('retakeMode').value;
        retakeLimit = retakeMode === 'allow_limited' ? 
            parseInt(document.getElementById('retakeLimit').value) : 0;
    } else {
        // å…¼å®¹æ—§ç‰ˆæœ¬
        retakeMode = document.getElementById('allowRetake').checked ? 'allow_unlimited' : 'disallow';
        retakeLimit = 0;
    }
    
    const settings = {
        title: document.getElementById('quizTitle').value.trim(),
        description: document.getElementById('quizDescription').value.trim(),
        duration: parseInt(document.getElementById('quizDuration').value),
        startTime: document.getElementById('quizStartTime').value ? 
            new Date(document.getElementById('quizStartTime').value).getTime() : null,
        endTime: document.getElementById('quizEndTime').value ? 
            new Date(document.getElementById('quizEndTime').value).getTime() : null,
        showResultsImmediately: document.getElementById('showResultsImmediately').checked,
        resultsDelay: document.getElementById('resultsDelay') ? 
            parseInt(document.getElementById('resultsDelay').value) : 0,
        retakeMode: retakeMode,
        retakeLimit: retakeLimit,
        enableAntiCheat: document.getElementById('enableAntiCheat').checked,
        status: quizData.settings.status || 'not_started',
        // å…¼å®¹æ—§ç‰ˆæœ¬
        allowRetake: retakeMode !== 'disallow'
    };
    
    if (settings.duration <= 0) {
        Swal.fire('é”™è¯¯', 'æ¯”èµ›æ—¶é•¿å¿…é¡»å¤§äº0', 'error');
        return;
    }
    
    if (settings.startTime && settings.endTime && settings.startTime >= settings.endTime) {
        Swal.fire('é”™è¯¯', 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´', 'error');
        return;
    }
    
    quizData.settings = settings;
    
    database.ref('quiz/settings').set(settings).then(() => {
        Swal.fire('æˆåŠŸ', 'æ¯”èµ›è®¾ç½®å·²ä¿å­˜', 'success');
    }).catch(error => {
        console.error("ä¿å­˜æ¯”èµ›è®¾ç½®é”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'ä¿å­˜æ¯”èµ›è®¾ç½®å¤±è´¥', 'error');
    });
}
        
        // å¼€å§‹æ¯”èµ›
        // å¼€å§‹æ¯”èµ›
function startQuiz() {
    if (quizData.settings.status === 'in_progress') return;
    
    Swal.fire({
        title: 'ç¡®è®¤å¼€å§‹æ¯”èµ›',
        text: 'æ‚¨ç¡®å®šè¦å¼€å§‹æ¯”èµ›å—ï¼Ÿå¼€å§‹åå‚èµ›è€…å¯ä»¥å¼€å§‹ç­”é¢˜ã€‚',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'å¼€å§‹',
        cancelButtonText: 'å–æ¶ˆ'
    }).then(result => {
        if (result.isConfirmed) {
            const settings = {
                ...quizData.settings,
                status: 'in_progress',
                startTime: new Date().getTime()
            };
            
            quizData.settings = settings;
            
            // ============ ä¿®å¤ï¼šå¼€å§‹æ¯”èµ›æ—¶é‡ç½®æ‰€æœ‰ç”¨æˆ·çš„è­¦å‘Šæ¬¡æ•° ============
            database.ref('cheatWarnings').remove()
                .then(() => {
                    console.log("å·²é‡ç½®æ‰€æœ‰ç”¨æˆ·çš„è­¦å‘Šæ¬¡æ•°");
                    
                    // ä¿å­˜æ¯”èµ›è®¾ç½®
                    database.ref('quiz/settings').set(settings).then(() => {
                        Swal.fire('æˆåŠŸ', 'æ¯”èµ›å·²å¼€å§‹ï¼Œæ‰€æœ‰è­¦å‘Šæ¬¡æ•°å·²é‡ç½®', 'success');
                        updateQuizStatusDisplay('in_progress');
                    });
                })
                .catch(error => {
                    console.error("é‡ç½®è­¦å‘Šæ¬¡æ•°é”™è¯¯:", error);
                    // å³ä½¿é‡ç½®å¤±è´¥ä¹Ÿç»§ç»­å¼€å§‹æ¯”èµ›
                    database.ref('quiz/settings').set(settings).then(() => {
                        Swal.fire('æˆåŠŸ', 'æ¯”èµ›å·²å¼€å§‹', 'success');
                        updateQuizStatusDisplay('in_progress');
                    });
                });
        }
    });
}
        
        // æš‚åœæ¯”èµ›
        function pauseQuiz() {
            if (quizData.settings.status !== 'in_progress') return;
            
            Swal.fire({
                title: 'ç¡®è®¤æš‚åœæ¯”èµ›',
                text: 'æ‚¨ç¡®å®šè¦æš‚åœæ¯”èµ›å—ï¼Ÿæš‚åœåå‚èµ›è€…å°†æ— æ³•ç»§ç»­ç­”é¢˜ã€‚',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'æš‚åœ',
                cancelButtonText: 'å–æ¶ˆ'
            }).then(result => {
                if (result.isConfirmed) {
                    const settings = {
                        ...quizData.settings,
                        status: 'paused'
                    };
                    
                    quizData.settings = settings;
                    
                    database.ref('quiz/settings').set(settings).then(() => {
                        Swal.fire('æˆåŠŸ', 'æ¯”èµ›å·²æš‚åœ', 'success');
                        updateQuizStatusDisplay('paused');
                    }).catch(error => {
                        console.error("æš‚åœæ¯”èµ›é”™è¯¯:", error);
                        Swal.fire('é”™è¯¯', 'æš‚åœæ¯”èµ›å¤±è´¥', 'error');
                    });
                }
            });
        }
        
        // ç»“æŸæ¯”èµ›
        function endQuiz() {
            if (quizData.settings.status === 'ended') return;
            
            Swal.fire({
                title: 'ç¡®è®¤ç»“æŸæ¯”èµ›',
                text: 'æ‚¨ç¡®å®šè¦ç»“æŸæ¯”èµ›å—ï¼Ÿç»“æŸåå‚èµ›è€…å°†æ— æ³•ç»§ç»­ç­”é¢˜ã€‚',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ç»“æŸ',
                cancelButtonText: 'å–æ¶ˆ'
            }).then(result => {
                if (result.isConfirmed) {
                    const settings = {
                        ...quizData.settings,
                        status: 'ended',
                        endTime: new Date().getTime()
                    };
                    
                    quizData.settings = settings;
                    
                    database.ref('quiz/settings').set(settings).then(() => {
                        Swal.fire('æˆåŠŸ', 'æ¯”èµ›å·²ç»“æŸ', 'success');
                        updateQuizStatusDisplay('ended');
                    }).catch(error => {
                        console.error("ç»“æŸæ¯”èµ›é”™è¯¯:", error);
                        Swal.fire('é”™è¯¯', 'ç»“æŸæ¯”èµ›å¤±è´¥', 'error');
                    });
                }
            });
        }
        
        // é‡ç½®æ¯”èµ›æ•°æ®
        function resetQuiz() {
            Swal.fire({
                title: 'ç¡®å®šè¦é‡ç½®æ¯”èµ›æ•°æ®ï¼Ÿ',
                text: 'è¿™å°†åˆ é™¤æ‰€æœ‰å‚èµ›è€…æ•°æ®å’Œæˆç»©ï¼Œæ— æ³•æ¢å¤ï¼',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ç¡®è®¤é‡ç½®',
                cancelButtonText: 'å–æ¶ˆ'
            }).then(result => {
                if (result.isConfirmed) {
                    const updates = {
                        'quiz/settings/status': 'not_started',
                        'userAnswers': null,
                        'users': null
                    };

                    firebase.database().ref().update(updates)
                        .then(() => {
                            Swal.fire('å·²é‡ç½®', 'æ¯”èµ›æ•°æ®å·²æ¸…é™¤', 'success');
                            loadQuizData();
                        })
                        .catch((error) => {
                            console.error("é‡ç½®å¤±è´¥:", error);
                            Swal.fire('é”™è¯¯', 'é‡ç½®å¤±è´¥: ' + error.message, 'error');
                        });
                }
            });
        }
        
        // æ˜¾ç¤ºå¯¼å‡ºç¡®è®¤
        function showExportConfirm() {
            document.getElementById('exportCount').textContent = 'æ‰€æœ‰';
            const exportConfirmModal = new bootstrap.Modal(document.getElementById('exportConfirmModal'));
            exportConfirmModal.show();
        }
        
        // å¯¼å‡ºå…¨éƒ¨ç»“æœ
        function exportAllResults() {
            showExportConfirm();
        }
        
        // å¯¼å‡ºæˆç»©
        function exportResults() {
            const exportConfirmModal = bootstrap.Modal.getInstance(document.getElementById('exportConfirmModal'));
            if (exportConfirmModal) exportConfirmModal.hide();
            
            database.ref('userAnswers').orderByChild('submitted').equalTo(true).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const results = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const result = childSnapshot.val();
                        if (result.userInfo && result.score !== undefined) {
                            results.push(result);
                        }
                    });
                    
                    const format = document.getElementById('exportFormat').value;
                    const scope = document.getElementById('exportScope').value;
                    const sort = document.getElementById('exportSort').value;
                    
                    let filteredResults = results;
                    if (scope === 'highschool') {
                        filteredResults = results.filter(r => r.userInfo.group === 'highschool');
                    } else if (scope === 'middleschool') {
                        filteredResults = results.filter(r => r.userInfo.group === 'middleschool');
                    } else if (scope === 'completed') {
                        filteredResults = results.filter(r => r.submitted);
                    } else if (scope === 'incomplete') {
                        filteredResults = results.filter(r => !r.submitted);
                    }
                    
                    if (sort === 'score') {
                        filteredResults.sort((a, b) => b.score - a.score || (a.endTime - a.startTime) - (b.endTime - b.startTime));
                    } else if (sort === 'time') {
                        filteredResults.sort((a, b) => (a.endTime - a.startTime) - (b.endTime - b.startTime) || b.score - a.score);
                    } else if (sort === 'name') {
                        filteredResults.sort((a, b) => a.userInfo.name.localeCompare(b.userInfo.name));
                    }
                    
                    if (format === 'csv') {
                        exportToCSV(filteredResults);
                    } else if (format === 'excel') {
                        exportToExcel(filteredResults);
                    } else if (format === 'pdf') {
                        exportToPDF(filteredResults);
                    } else if (format === 'png') {
                        exportToPNG(filteredResults);
                    }
                } else {
                    Swal.fire('æç¤º', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æˆç»©æ•°æ®', 'info');
                }
            }).catch(error => {
                console.error("å¯¼å‡ºæˆç»©é”™è¯¯:", error);
                Swal.fire('é”™è¯¯', 'å¯¼å‡ºæˆç»©å¤±è´¥', 'error');
            });
        }
        
        // å¯¼å‡ºä¸ºCSV
        function exportToCSV(results) {
            let csv = 'æ’å,å§“å,ç­çº§,ç»„åˆ«,æ­£ç¡®é¢˜æ•°,é”™è¯¯é¢˜æ•°,å¾—åˆ†,ç”¨æ—¶(ç§’)\n';
            
            results.forEach((result, index) => {
                const timeUsed = result.endTime ? Math.floor((result.endTime - result.startTime) / 1000) : 0;
                csv += `${index + 1},${result.userInfo.name},${result.userInfo.class},${result.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'},${result.correctCount || 0},${result.wrongCount || 0},${result.score || 0},${timeUsed}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `å®½ä¸­ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›æˆç»©_${new Date().toISOString().slice(0, 10)}.csv`);
        }
        
        // å¯¼å‡ºä¸ºExcel
        function exportToExcel(results) {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['æ’å', 'å§“å', 'ç­çº§', 'ç»„åˆ«', 'æ­£ç¡®é¢˜æ•°', 'é”™è¯¯é¢˜æ•°', 'å¾—åˆ†', 'ç”¨æ—¶(ç§’)']
            ];
            
            results.forEach((result, index) => {
                const timeUsed = result.endTime ? Math.floor((result.endTime - result.startTime) / 1000) : 0;
                wsData.push([
                    index + 1,
                    result.userInfo.name,
                    result.userInfo.class,
                    result.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­',
                    result.correctCount || 0,
                    result.wrongCount || 0,
                    result.score || 0,
                    timeUsed
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'æˆç»©è¡¨');
            XLSX.writeFile(wb, `å®½ä¸­ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›æˆç»©_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
        
        // å¯¼å‡ºä¸ºPDF - æ”¯æŒä¸­æ–‡çš„ç‰ˆæœ¬
function exportToPDF(results) {
    const { jsPDF } = window.jspdf;
    
    Swal.fire({
        title: 'æ­£åœ¨ç”ŸæˆPDF',
        html: 'è¯·ç¨å€™ï¼Œæ­£åœ¨ç”ŸæˆPDFæ–‡ä»¶...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    // åˆ›å»ºHTMLå†…å®¹
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: 'Microsoft YaHei', 'SimHei', sans-serif; padding: 20px; }
                h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background-color: #2c3e50; color: white; padding: 12px; text-align: left; }
                td { padding: 10px; border-bottom: 1px solid #ddd; }
                tr:nth-child(even) { background-color: #f2f2f2; }
                .header { text-align: center; margin-bottom: 30px; }
                .date { color: #666; margin-top: 10px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>å®½æŸ”ä¸­å­¦ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›æˆç»©å•</h1>
                <p class="date">å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>å§“å</th>
                        <th>ç­çº§</th>
                        <th>ç»„åˆ«</th>
                        <th>æ­£ç¡®é¢˜æ•°</th>
                        <th>é”™è¯¯é¢˜æ•°</th>
                        <th>å¾—åˆ†</th>
                        <th>ç”¨æ—¶</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.map((result, index) => {
                        const timeUsed = result.endTime ? Math.floor((result.endTime - result.startTime) / 1000) : 0;
                        const minutes = Math.floor(timeUsed / 60);
                        const seconds = timeUsed % 60;
                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${result.userInfo.name || ''}</td>
                                <td>${result.userInfo.class || ''}</td>
                                <td>${result.userInfo.group === 'highschool' ? 'é«˜ä¸­' : 'åˆä¸­'}</td>
                                <td>${result.correctCount || 0}</td>
                                <td>${result.wrongCount || 0}</td>
                                <td>${result.score || 0}</td>
                                <td>${minutes}:${seconds.toString().padStart(2, '0')}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </body>
        </html>
    `;
    
    // ä½¿ç”¨html2canvasè½¬æ¢HTMLä¸ºå›¾ç‰‡ï¼Œç„¶åæ·»åŠ åˆ°PDF
    const element = document.createElement('div');
    element.innerHTML = htmlContent;
    element.style.position = 'absolute';
    element.style.left = '-9999px';
    document.body.appendChild(element);
    
    html2canvas(element, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
    }).then(canvas => {
        document.body.removeChild(element);
        
        const imgData = canvas.toDataURL('image/png');
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // æ·»åŠ å›¾ç‰‡åˆ°PDF
        doc.addImage(imgData, 'PNG', 10, 10, pageWidth - 20, pageHeight - 20);
        
        // ä¿å­˜PDF
        doc.save(`å®½ä¸­ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›æˆç»©_${new Date().toISOString().slice(0, 10)}.pdf`);
        
        Swal.close();
        Swal.fire('æˆåŠŸ', 'PDFæ–‡ä»¶å·²ç”Ÿæˆ', 'success');
        
    }).catch(error => {
        document.body.removeChild(element);
        Swal.close();
        console.error("ç”ŸæˆPDFé”™è¯¯:", error);
        Swal.fire('é”™è¯¯', 'ç”ŸæˆPDFå¤±è´¥: ' + error.message, 'error');
    });
}
        
        // å¯¼å‡ºä¸ºPNG
        function exportToPNG(results) {
            const element = document.getElementById('rankingTabContent');
            
            Swal.fire({
                title: 'æ­£åœ¨ç”Ÿæˆæˆªå›¾',
                html: 'è¯·ç¨å€™...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            html2canvas(element, {
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                Swal.close();
                
                const imgData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `å®½ä¸­ç”µè„‘åä¼šå¸¸è¯†æ¯”èµ›æˆç»©_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = imgData;
                link.click();
                
            }).catch(error => {
                Swal.fire('é”™è¯¯', 'ç”Ÿæˆæˆªå›¾å¤±è´¥: ' + error.message, 'error');
                console.error("æˆªå›¾ç”Ÿæˆé”™è¯¯:", error);
            });
        }

        // æ˜¾ç¤ºç»“æœæŸ¥è¯¢ç•Œé¢
        function showResultCheckView() {
            document.getElementById('welcomeView').classList.add('d-none');
            document.getElementById('quizView').classList.add('d-none');
            document.getElementById('resultView').classList.add('d-none');
            document.getElementById('rankingView').classList.add('d-none');
            document.getElementById('adminView').classList.add('d-none');
            document.getElementById('resultCheckView').classList.remove('d-none');
            
            document.getElementById('resultCheckContainer').classList.add('d-none');
            document.getElementById('resultCheckSuccess').style.display = 'none';
            document.getElementById('resultCheckInfo').style.display = 'none';
        }

        // æŸ¥è¯¢ç»“æœ
        function checkResult(e) {
            e.preventDefault();
            
            const name = document.getElementById('checkName').value.trim();
            const className = document.getElementById('checkClass').value.trim();
            const studentId = document.getElementById('checkStudentId').value.trim();
            
            if (!name || !className || !studentId) {
                Swal.fire('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰æŸ¥è¯¢ä¿¡æ¯', 'error');
                return;
            }
            
            const resultContainer = document.getElementById('resultCheckContainer');
            resultContainer.classList.add('d-none');
            const loadingSwal = Swal.fire({
                title: 'æŸ¥è¯¢ä¸­',
                html: 'æ­£åœ¨æŸ¥è¯¢æ‚¨çš„æ¯”èµ›ç»“æœ...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            database.ref('awards').once('value').then(snapshot => {
                loadingSwal.close();
                resultContainer.classList.remove('d-none');
                
                const successDiv = document.getElementById('resultCheckSuccess');
                const infoDiv = document.getElementById('resultCheckInfo');
                const detailsP = document.getElementById('resultCheckDetails');
                const messageP = document.getElementById('resultCheckMessage');
                
                if (snapshot.exists()) {
                    const awards = snapshot.val();
                    let found = false;
                    
                    for (const key in awards) {
                        const award = awards[key];
                        if (award.name === name && award.class === className && award.studentId === studentId) {
                            found = true;
                            successDiv.style.display = 'block';
                            infoDiv.style.display = 'none';
                            
                            let details = `ç­çº§: ${award.class}<br>`;
                            details += `ç»„åˆ«: ${award.group === 'highschool' ? 'é«˜ä¸­ç»„' : 'åˆä¸­ç»„'}<br>`;
                            details += `å¥–é¡¹: ${award.award}<br>`;
                            details += `å¾—åˆ†: ${award.score || 'æ— '}<br>`;
                            details += `æ’å: ${award.rank || 'æ— '}`;
                            
                            detailsP.innerHTML = details;
                            break;
                        }
                    }
                    
                    if (!found) {
                        successDiv.style.display = 'none';
                        infoDiv.style.display = 'block';
                        messageP.textContent = 'å¾ˆé—æ†¾ï¼Œæ‚¨ç›®å‰ä¸åœ¨æ™‹çº§/è·å¥–åå•ä¸­ã€‚è¯·ç»§ç»­åŠªåŠ›ï¼';
                    }
                } else {
                    successDiv.style.display = 'none';
                    infoDiv.style.display = 'block';
                    messageP.textContent = 'ç›®å‰è¿˜æ²¡æœ‰å…¬å¸ƒæ™‹çº§/è·å¥–åå•ï¼Œè¯·ç¨åå†æŸ¥è¯¢ã€‚';
                }
            }).catch(error => {
                loadingSwal.close();
                console.error("æŸ¥è¯¢ç»“æœé”™è¯¯:", error);
                Swal.fire('é”™è¯¯', 'æŸ¥è¯¢ç»“æœå¤±è´¥: ' + error.message, 'error');
            });
        }

        // æ˜¾ç¤ºæˆç»©è¯ä¹¦
        function showCertificate() {
            const certificateModal = new bootstrap.Modal(document.getElementById('certificateModal'));
            
            document.getElementById('certificateName').textContent = userInfo.name;
            document.getElementById('certificateClass').textContent = userInfo.class;
            document.getElementById('certificateGroup').textContent = userInfo.group === 'highschool' ? 'é«˜ä¸­ç»„' : 'åˆä¸­ç»„';
            
            const totalScore = calculateTotalScore();
            const maxScore = quizData.questions.reduce((sum, q) => sum + q.points, 0);
            document.getElementById('certificateScore').textContent = `${totalScore}/${maxScore}`;
            document.getElementById('certificateTotalScore').textContent = totalScore;
            
            // è·å–æ’åä¿¡æ¯
            const groupRank = document.getElementById('groupRank').textContent;
            const overallRank = document.getElementById('overallRank').textContent;
            document.getElementById('certificateRank').textContent = `ç»„å†…${groupRank}ï¼Œæ€»æ’å${overallRank}`;
            
            document.getElementById('certificateDate').textContent = new Date().toLocaleDateString('zh-CN');
            
            certificateModal.show();
        }

        // æ‰“å°è¯ä¹¦
        function printCertificate() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>æˆç»©è¯ä¹¦</title>
                        <style>
                            body { font-family: 'Microsoft YaHei', sans-serif; padding: 50px; }
                            .certificate { 
                                border: 20px solid transparent;
                                border-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="none" stroke="%23ff9800" stroke-width="2"/></svg>') 20 stretch;
                                padding: 60px;
                                text-align: center;
                                background: linear-gradient(135deg, #fff8e1, #ffe0b2);
                            }
                            h1 { color: #ff9800; margin-bottom: 30px; }
                            h2 { margin: 20px 0; }
                            .score { font-size: 48px; color: #2c3e50; margin: 30px 0; }
                            @media print {
                                body { padding: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="certificate">
                            <h1>æ–°å±±å®½æŸ”ä¸­å­¦ç”µè„‘åä¼š</h1>
                            <h2>å¸¸è¯†æ¯”èµ›æˆç»©è¯ä¹¦</h2>
                            <hr>
                            <h3>å‚èµ›è€…ï¼š${userInfo.name}</h3>
                            <h4>ç­çº§ï¼š${userInfo.class}</h4>
                            <h4>ç»„åˆ«ï¼š${userInfo.group === 'highschool' ? 'é«˜ä¸­ç»„' : 'åˆä¸­ç»„'}</h4>
                            <div class="score">${document.getElementById('certificateScore').textContent}</div>
                            <h4>æ€»å¾—åˆ†ï¼š${calculateTotalScore()} åˆ†</h4>
                            <h4>${document.getElementById('certificateRank').textContent}</h4>
                            <hr>
                            <p style="margin-top: 40px;">ç‰¹å‘æ­¤è¯ï¼Œä»¥èµ„é¼“åŠ±</p>
                            <p style="color: #666;">é¢å‘æ—¥æœŸï¼š${new Date().toLocaleDateString('zh-CN')}</p>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // è¾…åŠ©å‡½æ•°
        function showLoading(message) {
            Swal.fire({
                title: 'è¯·ç¨å€™',
                html: message,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
        }

        function hideLoading() {
            Swal.close();
        }

        // è§†å›¾åˆ‡æ¢å‡½æ•°
        function showWelcomeView() {
            document.getElementById('welcomeView').classList.remove('d-none');
            document.getElementById('quizView').classList.add('d-none');
            document.getElementById('resultView').classList.add('d-none');
            document.getElementById('rankingView').classList.add('d-none');
            document.getElementById('adminView').classList.add('d-none');
            document.getElementById('resultCheckView').classList.add('d-none');
        }
        
        function showQuizView() {
            const timeCheck = checkCompetitionTime();
    if (!timeCheck.allowed) {
        Swal.fire({
            title: 'æ— æ³•è¿›å…¥ç­”é¢˜',
            html: timeCheck.reason,
            icon: 'warning',
            confirmButtonText: 'ç¡®å®š'
        }).then(() => {
            showWelcomeView(); // è¿”å›æ¬¢è¿é¡µ
        });
        return;
    }
            document.getElementById('welcomeView').classList.add('d-none');
            document.getElementById('quizView').classList.remove('d-none');
            document.getElementById('resultView').classList.add('d-none');
            document.getElementById('rankingView').classList.add('d-none');
            document.getElementById('adminView').classList.add('d-none');
            document.getElementById('resultCheckView').classList.add('d-none');
        }
        
        // æ˜¾ç¤ºç»“æœç•Œé¢
function showResultView() {
    // ç¡®ä¿åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
    if (quizTimer) {
        clearInterval(quizTimer);
        quizTimer = null;
    }
    
    // åœæ­¢é˜²ä½œå¼Šç›‘æ§
    cheatDetectionEnabled = false;
    
    document.getElementById('welcomeView').classList.add('d-none');
    document.getElementById('quizView').classList.add('d-none');
    document.getElementById('resultView').classList.remove('d-none');
    document.getElementById('rankingView').classList.add('d-none');
    document.getElementById('adminView').classList.add('d-none');
    document.getElementById('resultCheckView').classList.add('d-none');
    
    // å¦‚æœæœ‰é˜²ä½œå¼Šé¢æ¿ï¼Œéšè—å®ƒ
    document.getElementById('cheatDetectionPanel').classList.add('d-none');
    document.getElementById('antiCheatAlert').classList.add('d-none');
    document.getElementById('fullscreenOverlay').classList.add('d-none');
    
    // æ˜¾ç¤ºç»“æœ
    displayResults();
}

        // æ—¶é—´è°ƒè¯•å‡½æ•°
function logTimeDebug(userId) {
    database.ref('userAnswers/' + userId).once('value').then(snapshot => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            console.log("æ—¶é—´è°ƒè¯•ä¿¡æ¯ï¼š", {
                userId: userId,
                userName: data.userInfo?.name,
                startTime: data.startTime ? new Date(data.startTime).toLocaleString() : 'æ— ',
                endTime: data.endTime ? new Date(data.endTime).toLocaleString() : 'æ— ',
                storedTimeUsed: data.timeUsed || 'æ— ',
                calculatedTime: data.startTime && data.endTime ? 
                    Math.floor((data.endTime - data.startTime) / 1000) : 'æ— æ³•è®¡ç®—',
                submitted: data.submitted || false
            });
        }
    });
}

// åœ¨ç®¡ç†å‘˜ç•Œé¢æ·»åŠ è°ƒè¯•æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
function addDebugButtons() {
    // åœ¨ç®¡ç†å‘˜é¢æ¿æ·»åŠ è°ƒè¯•æŒ‰é’®
    const debugHTML = `
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-bug me-2"></i>æ—¶é—´è°ƒè¯•å·¥å…·
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" id="debugUserId" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·ID">
                    <button class="btn btn-warning" onclick="logTimeDebug(document.getElementById('debugUserId').value)">
                        è°ƒè¯•æ—¶é—´
                    </button>
                </div>
                <button class="btn btn-info" onclick="fixAllTimeData()">
                    ä¿®å¤æ‰€æœ‰æ—¶é—´æ•°æ®
                </button>
            </div>
        </div>
    `;
    
    // æ·»åŠ åˆ°ç®¡ç†å‘˜é¢æ¿çš„åˆé€‚ä½ç½®
    document.getElementById('settings').insertAdjacentHTML('beforeend', debugHTML);
}

        // æ—¶é—´è°ƒè¯•å‡½æ•°
function logTimeDebug(userId) {
    database.ref('userAnswers/' + userId).once('value').then(snapshot => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            console.log("æ—¶é—´è°ƒè¯•ä¿¡æ¯ï¼š", {
                userId: userId,
                userName: data.userInfo?.name,
                startTime: data.startTime ? new Date(data.startTime).toLocaleString() : 'æ— ',
                endTime: data.endTime ? new Date(data.endTime).toLocaleString() : 'æ— ',
                storedTimeUsed: data.timeUsed || 'æ— ',
                calculatedTime: data.startTime && data.endTime ? 
                    Math.floor((data.endTime - data.startTime) / 1000) : 'æ— æ³•è®¡ç®—',
                submitted: data.submitted || false
            });
        }
    });
}

// åœ¨ç®¡ç†å‘˜ç•Œé¢æ·»åŠ è°ƒè¯•æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
function addDebugButtons() {
    // åœ¨ç®¡ç†å‘˜é¢æ¿æ·»åŠ è°ƒè¯•æŒ‰é’®
    const debugHTML = `
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-bug me-2"></i>æ—¶é—´è°ƒè¯•å·¥å…·
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" id="debugUserId" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·ID">
                    <button class="btn btn-warning" onclick="logTimeDebug(document.getElementById('debugUserId').value)">
                        è°ƒè¯•æ—¶é—´
                    </button>
                </div>
                <button class="btn btn-info" onclick="fixAllTimeData()">
                    ä¿®å¤æ‰€æœ‰æ—¶é—´æ•°æ®
                </button>
            </div>
        </div>
    `;
    
    // æ·»åŠ åˆ°ç®¡ç†å‘˜é¢æ¿çš„åˆé€‚ä½ç½®
    document.getElementById('settings').insertAdjacentHTML('beforeend', debugHTML);
}
        
        function showRankingView() {
            document.getElementById('welcomeView').classList.add('d-none');
            document.getElementById('quizView').classList.add('d-none');
            document.getElementById('resultView').classList.add('d-none');
            document.getElementById('rankingView').classList.remove('d-none');
            document.getElementById('adminView').classList.add('d-none');
            document.getElementById('resultCheckView').classList.add('d-none');
        }

        
        function showAdminView() {
            if (!currentUser || !userInfo || !userInfo.isAdmin) {
                Swal.fire('é”™è¯¯', 'æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™', 'error');
                return;
            }
            
            const loadingSwal = Swal.fire({
                title: 'åŠ è½½æ•°æ®ä¸­',
                html: 'æ­£åœ¨è·å–ç®¡ç†å‘˜æ•°æ®...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });


            Promise.all([
                database.ref('quiz/settings').once('value'),
                database.ref('questions').once('value'),
                database.ref('userAnswers').once('value')
            ]).then(([settingsSnapshot, questionsSnapshot, answersSnapshot]) => {
                loadingSwal.close();
                
                if (settingsSnapshot.exists()) {
                    quizData.settings = settingsSnapshot.val();
                    updateQuizSettingsUI();
                }
                
                if (questionsSnapshot.exists()) {
                    quizData.questions = Object.values(questionsSnapshot.val());
                    updateQuestionList();
                } else {
                    Swal.fire('è­¦å‘Š', 'ç³»ç»Ÿä¸­å°šæœªè®¾ç½®ä»»ä½•é¢˜ç›®', 'warning');
                    quizData.questions = [];
                    document.getElementById('questionListBody').innerHTML = '<tr><td colspan="5" class="text-center">æš‚æ— é¢˜ç›®</td></tr>';
                }
                
                if (answersSnapshot.exists()) {
                    updateParticipantList();
                    updateResultsStatistics();
                }

                initMonitor();
                
                document.getElementById('welcomeView').classList.add('d-none');
                document.getElementById('quizView').classList.add('d-none');
                document.getElementById('resultView').classList.add('d-none');
                document.getElementById('rankingView').classList.add('d-none');
                document.getElementById('adminView').classList.remove('d-none');
                document.getElementById('resultCheckView').classList.add('d-none');
                
            }).catch(error => {
                loadingSwal.close();
                console.error("åŠ è½½ç®¡ç†å‘˜æ•°æ®å¤±è´¥:", error);
                Swal.fire('é”™è¯¯', 'åŠ è½½ç®¡ç†å‘˜æ•°æ®å¤±è´¥: ' + error.message, 'error');
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å…¨å±çŠ¶æ€
function checkFullscreenOnLoad() {
    // æ£€æŸ¥æ˜¯å¦åœ¨ç­”é¢˜ç•Œé¢ä¸”éœ€è¦å…¨å±
    const isQuizViewVisible = !document.getElementById('quizView').classList.contains('d-none');
    const isAntiCheatEnabled = quizData.settings.enableAntiCheat;
    
    if (isQuizViewVisible && isAntiCheatEnabled && currentUser) {
        // æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±æ¨¡å¼
        const isFullscreen = document.fullscreenElement || 
                           document.webkitFullscreenElement || 
                           document.mozFullScreenElement || 
                           document.msFullscreenElement;
        
        if (!isFullscreen) {
            console.log("é¡µé¢åŠ è½½æ—¶æ£€æµ‹åˆ°æœªåœ¨å…¨å±æ¨¡å¼ï¼Œå»¶è¿Ÿè¯·æ±‚å…¨å±");
            // å»¶è¿Ÿè¯·æ±‚ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            setTimeout(() => {
                requestFullscreen();
            }, 1500);
        }
    }
}

// åœ¨DOMåŠ è½½å®Œæˆåè°ƒç”¨
document.addEventListener('DOMContentLoaded', () => {
    init();
    
    // å»¶è¿Ÿæ£€æŸ¥å…¨å±çŠ¶æ€
    setTimeout(checkFullscreenOnLoad, 2000);
});
        
// æ·»åŠ åˆ·æ–°æ¢å¤åŠŸèƒ½
function handlePageRefresh() {
    // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ·æ–°åè¿›å…¥ç­”é¢˜é¡µé¢
    const isQuizViewVisible = !document.getElementById('quizView').classList.contains('d-none');
    
    if (isQuizViewVisible && currentUser) {
        console.log("æ£€æµ‹åˆ°åˆ·æ–°ååœ¨ç­”é¢˜é¡µé¢ï¼Œæ£€æŸ¥çŠ¶æ€...");
        
        // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
        setTimeout(() => {
            // æ£€æŸ¥ userAnswers æ˜¯å¦æœ‰æ•ˆ
            if (!userAnswers || !Array.isArray(userAnswers) || userAnswers.length === 0) {
                console.warn("åˆ·æ–°å userAnswers æ— æ•ˆï¼Œå°è¯•ä» Firebase æ¢å¤");
                
                // å°è¯•ä» Firebase æ¢å¤æ•°æ®
                database.ref('userAnswers/' + currentUser.uid).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (data && !data.submitted) {
                            console.log("æ‰¾åˆ°æœªæäº¤çš„æ•°æ®ï¼Œæ¢å¤è¿›åº¦");
                            loadUserProgress(data);
                        }
                    }
                }).catch(error => {
                    console.error("æ¢å¤æ•°æ®å¤±è´¥:", error);
                });
            }
        }, 1000);
    }
}

// åœ¨ DOMContentLoaded äº‹ä»¶ä¸­æ·»åŠ 
document.addEventListener('DOMContentLoaded', () => {
    init();
    
    // æ·»åŠ åˆ·æ–°å¤„ç†
    setTimeout(handlePageRefresh, 1500);
});
    </script>
</body>
</html>
